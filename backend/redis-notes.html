<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis | Notes of Tan</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="https://v1.vuepress.vuejs.org/hero.png">
    <meta name="description" content="Tan's notes.">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/notes-of-tan/assets/css/0.styles.f8fd4e37.css" as="style"><link rel="preload" href="/notes-of-tan/assets/js/app.a889d74a.js" as="script"><link rel="preload" href="/notes-of-tan/assets/js/2.82b804b0.js" as="script"><link rel="preload" href="/notes-of-tan/assets/js/26.8a5b1dec.js" as="script"><link rel="prefetch" href="/notes-of-tan/assets/js/10.57f9ec2b.js"><link rel="prefetch" href="/notes-of-tan/assets/js/11.d2c43f8a.js"><link rel="prefetch" href="/notes-of-tan/assets/js/12.728f631e.js"><link rel="prefetch" href="/notes-of-tan/assets/js/13.f9139ce0.js"><link rel="prefetch" href="/notes-of-tan/assets/js/14.27526f21.js"><link rel="prefetch" href="/notes-of-tan/assets/js/15.a7eef278.js"><link rel="prefetch" href="/notes-of-tan/assets/js/16.b0d7eb6a.js"><link rel="prefetch" href="/notes-of-tan/assets/js/17.8b7355db.js"><link rel="prefetch" href="/notes-of-tan/assets/js/18.1e6bdc36.js"><link rel="prefetch" href="/notes-of-tan/assets/js/19.cb2f342e.js"><link rel="prefetch" href="/notes-of-tan/assets/js/20.16d48c16.js"><link rel="prefetch" href="/notes-of-tan/assets/js/21.074c3f9e.js"><link rel="prefetch" href="/notes-of-tan/assets/js/22.35ef7c3a.js"><link rel="prefetch" href="/notes-of-tan/assets/js/23.027ea32f.js"><link rel="prefetch" href="/notes-of-tan/assets/js/24.c1519d8b.js"><link rel="prefetch" href="/notes-of-tan/assets/js/25.814d8043.js"><link rel="prefetch" href="/notes-of-tan/assets/js/27.94e4428d.js"><link rel="prefetch" href="/notes-of-tan/assets/js/28.175070e9.js"><link rel="prefetch" href="/notes-of-tan/assets/js/29.5d06ed42.js"><link rel="prefetch" href="/notes-of-tan/assets/js/3.af21e560.js"><link rel="prefetch" href="/notes-of-tan/assets/js/30.17337f4d.js"><link rel="prefetch" href="/notes-of-tan/assets/js/31.834ae95e.js"><link rel="prefetch" href="/notes-of-tan/assets/js/32.94aab8c5.js"><link rel="prefetch" href="/notes-of-tan/assets/js/33.d3d96aba.js"><link rel="prefetch" href="/notes-of-tan/assets/js/34.373857b6.js"><link rel="prefetch" href="/notes-of-tan/assets/js/35.0ac2b976.js"><link rel="prefetch" href="/notes-of-tan/assets/js/36.86f91b8f.js"><link rel="prefetch" href="/notes-of-tan/assets/js/37.18bb174e.js"><link rel="prefetch" href="/notes-of-tan/assets/js/4.fe0e28a8.js"><link rel="prefetch" href="/notes-of-tan/assets/js/5.b3fa97d8.js"><link rel="prefetch" href="/notes-of-tan/assets/js/6.f90d50ad.js"><link rel="prefetch" href="/notes-of-tan/assets/js/7.ff83a28e.js"><link rel="prefetch" href="/notes-of-tan/assets/js/8.9978b48b.js"><link rel="prefetch" href="/notes-of-tan/assets/js/9.96d16d2f.js">
    <link rel="stylesheet" href="/notes-of-tan/assets/css/0.styles.f8fd4e37.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes-of-tan/" class="home-link router-link-active"><!----> <span class="site-name">Notes of Tan</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notes-of-tan/backend/java/javaBasics.html" class="nav-link">
  Java
</a></div> <a href="https://github.com/tangentyh/notes-of-tan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notes-of-tan/backend/java/javaBasics.html" class="nav-link">
  Java
</a></div> <a href="https://github.com/tangentyh/notes-of-tan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-of-tan/backend/redis-notes.html#introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#data-types-and-data-structures" class="sidebar-link">Data Types And Data Structures</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/redis-notes.html#data-structures" class="sidebar-link">Data Structures</a></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/redis-notes.html#data-types" class="sidebar-link">Data Types</a></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/redis-notes.html#sort" class="sidebar-link">Sort</a></li></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#server" class="sidebar-link">Server</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#events" class="sidebar-link">Events</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#publish-and-subscribe" class="sidebar-link">Publish and Subscribe</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#persistence" class="sidebar-link">Persistence</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#clustering" class="sidebar-link">Clustering</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#transaction" class="sidebar-link">Transaction</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#other" class="sidebar-link">Other</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h1> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <ol><li>docs
<ul><li><a href="https://redis.io/documentation" target="_blank" rel="noopener noreferrer">Redis official<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/redis/redis" target="_blank" rel="noopener noreferrer">Redis GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.redislabs.com/latest/index.html" target="_blank" rel="noopener noreferrer">Redis Labs Documentation | Redis Labs Documentation Center<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://redisdoc.com/" target="_blank" rel="noopener noreferrer">Redis 命令参考 — Redis 命令参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>books
<ul><li><a href="https://redislabs.com/ebooks" target="_blank" rel="noopener noreferrer">e-Books - Redis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://redisbook.com/" target="_blank" rel="noopener noreferrer">Redis 设计与实现 — Redis 设计与实现<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://redisinaction.com/" target="_blank" rel="noopener noreferrer">Redis实战 — Redis 实战<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://redisguide.com/" target="_blank" rel="noopener noreferrer">Redis使用手册<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://learnredis.com/" target="_blank" rel="noopener noreferrer">《Redis入门与实战》 — LearnRedis.com 1.0 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></li></ol> <h2 id="data-types-and-data-structures"><a href="#data-types-and-data-structures" class="header-anchor">#</a> Data Types And Data Structures</h2> <h3 id="data-structures"><a href="#data-structures" class="header-anchor">#</a> Data Structures</h3> <ol><li><p>string</p> <ul><li><code>c_str</code> -- used in string literal, like when <code>redisLog</code></li> <li>simple dynamic string，SDS -- used as keys, values, and buffers<div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">sdshdr</span> <span class="token punctuation">{</span>
    <span class="token comment">// 记录 buf 数组中已使用字节的数量</span>
    <span class="token comment">// 等于 SDS 所保存字符串的长度</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    <span class="token comment">// 记录 buf 数组中未使用字节的数量</span>
    <span class="token keyword">int</span> free<span class="token punctuation">;</span>
    <span class="token comment">// c_str, '\0' ended, which is not counted in len</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>capacity grow policy -- if <code>len</code> &lt; 1 MB, <code>free</code> = <code>len</code>; else, <code>free</code> = 1 MB</li> <li>lazy reclaim of <code>free</code> -- reclaim on demand</li> <li>binary-safe -- <code>len</code> as end, instead of <code>'\0'</code> as end
<ul><li><code>'\0'</code> as end -- for C API reuse, partially supported</li></ul></li></ul></li></ul></li> <li><p>dictionary, hash table -- used in <code>REDIS_HASH</code> and database implementation, and more</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dict</span> <span class="token punctuation">{</span>
    <span class="token comment">// 类型特定函数</span>
    dictType <span class="token operator">*</span>type<span class="token punctuation">;</span>
    <span class="token comment">// 需要传给那些类型特定函数的可选参数</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">;</span>
    <span class="token comment">// 哈希表</span>
    dictht ht<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// rehash 索引</span>
    <span class="token keyword">int</span> rehashidx<span class="token punctuation">;</span> <span class="token comment">/* rehashing not in progress if rehashidx == -1 */</span>
<span class="token punctuation">}</span> dict<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>dictType</code><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictType</span> <span class="token punctuation">{</span>
    <span class="token comment">// 计算哈希值的函数, MurmurHash algorithm for v3</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>hashFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 复制键的函数</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>keyDup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 复制值的函数</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>valDup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对比键的函数</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>keyCompare<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 销毁键的函数</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>keyDestructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 销毁值的函数</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>valDestructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> dictType<span class="token punctuation">;</span>
</code></pre></div></li> <li><code>dictht</code> -- dictionary hash table<div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictht</span> <span class="token punctuation">{</span>
    <span class="token comment">// 哈希表数组</span>
    dictEntry <span class="token operator">*</span><span class="token operator">*</span>table<span class="token punctuation">;</span>
    <span class="token comment">// size of table, defaults to 4</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>
    <span class="token comment">// 哈希表大小掩码，用于计算索引值</span>
    <span class="token comment">// 总是等于 size - 1</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sizemask<span class="token punctuation">;</span>
    <span class="token comment">// 该哈希表已有节点的数量</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> used<span class="token punctuation">;</span>
<span class="token punctuation">}</span> dictht<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>dictEntry</code> -- key-value pair<div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictEntry</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>
    <span class="token comment">// 值</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span> <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">;</span> <span class="token keyword">uint64_t</span> u64<span class="token punctuation">;</span> <span class="token keyword">int64_t</span> s64<span class="token punctuation">;</span> <span class="token punctuation">}</span> v<span class="token punctuation">;</span>
    <span class="token comment">// 指向下个哈希表节点，形成链表</span>
    <span class="token keyword">struct</span> <span class="token class-name">dictEntry</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span> dictEntry<span class="token punctuation">;</span>
</code></pre></div></li> <li>hash value -- <code>hashFunction(key) &amp; sizemask</code></li> <li>hash collision -- separate chaining with <code>*next</code>, 程序总是将新节点添加到链表的表头位置</li></ul></li> <li>rehash
<ul><li>expand -- when not executing <code>BGSAVE</code> or <code>BGREWRITEAOF</code> and load factor &gt;= 1, or when executing either one and load factor &gt;= 5; expand to the size of the first 2^n that &gt;= <code>ht[0].used * 2</code></li> <li>shrink -- when load factor &lt; 0.1; shrink to the size of the first 2^n that &gt;= <code>ht[0].used</code></li> <li>progressive rehash -- set <code>rehashidx</code> to 0, and increment by 1 for every CRUD operation, reset to -1 when completed and swap <code>ht[0]</code> and <code>ht[1]</code></li></ul></li></ul></li> <li><p>skiplist -- used in <code>REDIS_ZSET</code> and cluster</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">zskiplist</span> <span class="token punctuation">{</span>
    <span class="token comment">// 表头节点和表尾节点</span>
    <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token operator">*</span>header<span class="token punctuation">,</span> <span class="token operator">*</span>tail<span class="token punctuation">;</span>
    <span class="token comment">// 表中节点的数量</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> length<span class="token punctuation">;</span>
    <span class="token comment">// 表中层数最大的节点的层数</span>
    <span class="token keyword">int</span> level<span class="token punctuation">;</span>
<span class="token punctuation">}</span> zskiplist<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>zskiplistNode</code><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token punctuation">{</span>
    <span class="token comment">// 后退指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token operator">*</span>backward<span class="token punctuation">;</span>
    <span class="token comment">// 分值</span>
    <span class="token keyword">double</span> score<span class="token punctuation">;</span>
    <span class="token comment">// 成员对象</span>
    robj <span class="token operator">*</span>obj<span class="token punctuation">;</span>
    <span class="token comment">// 层</span>
    <span class="token keyword">struct</span> <span class="token class-name">zskiplistLevel</span> <span class="token punctuation">{</span>
        <span class="token comment">// 前进指针</span>
        <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token operator">*</span>forward<span class="token punctuation">;</span>
        <span class="token comment">// 跨度</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> span<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> level<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> zskiplistNode<span class="token punctuation">;</span>
</code></pre></div><ul><li>level -- height generated between 1 to 32 according to power law</li> <li>score -- for sort, ascending, sort by <code>obj</code> when equality</li></ul></li></ul></li> <li><p>int set -- encoding-adapting ordered distinct array, used in <code>REDIS_SET</code> if the cardinality is low</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">intset</span> <span class="token punctuation">{</span>
    <span class="token comment">// 编码方式</span>
    <span class="token keyword">uint32_t</span> encoding<span class="token punctuation">;</span>
    <span class="token comment">// 集合包含的元素数量</span>
    <span class="token keyword">uint32_t</span> length<span class="token punctuation">;</span>
    <span class="token comment">// 保存元素的数组, ordered</span>
    <span class="token keyword">int8_t</span> contents<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> intset<span class="token punctuation">;</span>
</code></pre></div><ul><li>add element -- O(N)
<ul><li>space saving -- <code>contents</code> is of the smallest encoding possible, upgrade and reallocate if necessary</li> <li>upgrade -- if one encoding not enough, upgrade encoding of <code>contents</code> from <code>INTSET_ENC_INT16</code> to <code>INTSET_ENC_INT32</code> to <code>INTSET_ENC_INT64</code>, new element added at head or tail</li></ul></li> <li>related commands
<ul><li><code>SADD</code></li></ul></li></ul></li> <li><p>list -- linked list, used in <code>REDIS_LIST</code> and various places</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span> listNode<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">list</span> <span class="token punctuation">{</span>
    listNode <span class="token operator">*</span>head<span class="token punctuation">;</span>
    listNode <span class="token operator">*</span>tail<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">;</span>
    <span class="token comment">// 节点值复制函数</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>dup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 节点值释放函数</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>free<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 节点值对比函数</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>match<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> list<span class="token punctuation">;</span>
</code></pre></div><ul><li>related commands
<ul><li><code>LLEN key</code></li> <li><code>LRANGE key start stop</code></li></ul></li></ul></li> <li><p>ziplist -- a sequential data structure that is continuous on memory, used in <code>REDIS_LIST</code> and <code>REDIS_HASH</code></p> <div class="language- extra-class"><pre class="language-text"><code>zlbytes zltail zllen [entries] zlend
 4b       4b    2b              0xFF
</code></pre></div><ul><li><code>zlbytes</code> -- total size</li> <li><code>zltail</code> -- offset between the start of the ziplist and the start of the last entry</li> <li><code>zllen</code> -- total entry count, can only hold within <code>UINT16_MAX</code></li> <li><code>zlend</code> -- end mark</li> <li>entry -- a byte array or a number<div class="language- extra-class"><pre class="language-text"><code>previous_entry_length encoding content
</code></pre></div><ul><li><code>previous_entry_length</code> -- 1 byte when &lt; <code>0xFE</code> otherwise 5 byte starting with <code>0xFE</code>, for iterating</li> <li><code>encoding</code> -- type and length of <code>content</code></li> <li>operations like push an entry -- O(N), the possibility of long cascade update is low, which needs consecutive entries of length between 250 to 253b
<ul><li>cascade update -- <code>previous_entry_length</code> of an entry updates from 1b to 5b, triggering the <code>previous_entry_length</code> update of the next entry, O(N^2) in the worst case</li></ul></li></ul></li></ul></li></ol> <h3 id="data-types"><a href="#data-types" class="header-anchor">#</a> Data Types</h3> <ol><li><p>object -- wrapper for data structures, with timestamp, with reference count for object sharing and GC</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisObject</span> <span class="token punctuation">{</span>
    <span class="token comment">// 类型</span>
    <span class="token keyword">unsigned</span> type<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token comment">// 编码</span>
    <span class="token keyword">unsigned</span> encoding<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token comment">// 指向底层实现数据结构的指针</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    <span class="token comment">// 引用计数</span>
    <span class="token keyword">int</span> refcount<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> lru<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> robj<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>type</code> -- <code>REDIS_STRING</code>, <code>REDIS_LIST</code>, <code>REDIS_HASH</code>, <code>REDIS_SET</code>, <code>REDIS_ZSET</code>, keys are always string</li> <li><code>encoding</code> -- <code>REDIS_ENCODING_INT</code>, <code>REDIS_ENCODING_EMBSTR</code>, <code>REDIS_ENCODING_RAW</code>, <code>REDIS_ENCODING_HT</code> (hash table), <code>REDIS_ENCODING_LINKEDLIST</code>, <code>REDIS_ENCODING_ZIPLIST</code>, <code>REDIS_ENCODING_INTSET</code>, <code>REDIS_ENCODING_SKIPLIST</code></li> <li>polymorphism -- the same command works for different types and/or encodings</li> <li>GC -- reference counting</li> <li><code>lru</code> -- last accessed timestamp, used when <code>maxmemory</code> with <code>volatile-lru</code> or <code>allkeys-lru</code></li> <li>flyweight -- for integers from 0 to 9999</li> <li>related commands
<ul><li><code>OBJECT</code> <ul><li><code>OBJECT ENCODING</code></li> <li><code>OBJECT REFCOUNT</code></li> <li><code>OBJECT IDLETIME</code></li></ul></li> <li><code>TYPE</code></li> <li>see <code>redisDb</code></li></ul></li></ul></li> <li><p><code>REDIS_STRING</code></p> <ul><li>corresponding <code>encoding</code> <ul><li><code>REDIS_ENCODING_INT</code> -- <code>long</code>, for numbers within range</li> <li><code>REDIS_ENCODING_EMBSTR</code> -- 使用 embstr 编码的 SDS, used when stirng length &lt;= 39 bytes and when <code>long double</code> <ul><li><code>embstr</code> -- like raw SDS, but allocate one space for both <code>redisObject</code> and <code>sdshdr</code>, read only, and more</li></ul></li> <li><code>REDIS_ENCODING_RAW</code> -- SDS, used when string length &gt; 39 bytes</li></ul></li> <li>related commands
<ul><li><code>SET</code>, <code>GET</code></li> <li><code>MSET</code></li> <li><code>APPEND</code></li> <li><code>INCRBYFLOAT</code></li> <li><code>INCRBY</code>, <code>DECRBY</code></li> <li><code>STRLEN</code></li> <li><code>SETRANGE</code>, <code>GETRANGE</code></li> <li><code>SETEX</code></li></ul></li></ul></li> <li><p>bit array</p> <ul><li><code>redisObject.type</code> -- <code>REDIS_STRING</code>, like <code>java.util.BitSet</code>, but one byte (<code>char</code>) each word</li> <li>related commands
<ul><li><code>SETBIT</code></li> <li><code>GETBIT</code></li> <li><code>BITCOUNT</code></li> <li><code>BITOP</code></li></ul></li></ul></li> <li><p><code>REDIS_LIST</code></p> <ul><li>corresponding <code>encoding</code> <ul><li><code>REDIS_ENCODING_ZIPLIST</code> -- when each element size &lt; 64 bytes and list size &lt; 512, <code>list-max-ziplist-value</code> and <code>list-max-ziplist-entries</code> in configurations</li> <li><code>REDIS_ENCODING_LINKEDLIST</code></li></ul></li> <li>related commands
<ul><li><code>LPUSH</code>, <code>RPUSH</code></li> <li><code>LPOP</code>, <code>RPOP</code></li> <li><code>LINDEX</code></li> <li><code>LLEN</code></li> <li><code>LINSERT</code></li> <li><code>LREM</code></li> <li><code>LTRIM</code></li> <li><code>LSET</code></li></ul></li></ul></li> <li><p><code>REDIS_HASH</code></p> <ul><li>corresponding <code>encoding</code> <ul><li><code>REDIS_ENCODING_ZIPLIST</code> -- when all keys and values &lt; 64 bytes, and list size &lt; 512, <code>hash-max-ziplist-value</code> and <code>hash-max-ziplist-entries</code> in configurations</li> <li><code>REDIS_ENCODING_HT</code></li></ul></li> <li>related commands
<ul><li><code>HSET</code>, <code>HGET</code></li> <li><code>HEXISTS</code></li> <li><code>HDEL</code></li> <li><code>HLEN</code></li> <li><code>HGETALL</code></li></ul></li></ul></li> <li><p><code>REDIS_SET</code></p> <ul><li>corresponding <code>encoding</code> <ul><li><code>REDIS_ENCODING_INTSET</code> -- when only integer elements and cardinality &lt; 512, <code>set-max-intset-entrie</code> in configurations</li> <li><code>REDIS_ENCODING_HT</code> -- <code>null</code> as value</li></ul></li> <li>related commands
<ul><li><code>SADD</code></li> <li><code>SCARD</code></li> <li><code>SISMEMBER</code></li> <li><code>SMEMBERS</code></li> <li><code>SRANDMEMBER</code></li> <li><code>SPOP</code></li> <li><code>SREM</code></li></ul></li></ul></li> <li><p><code>REDIS_ZSET</code> -- ordered set</p> <ul><li>corresponding <code>encoding</code> <ul><li><code>REDIS_ENCODING_ZIPLIST</code> -- when cardinality &lt; 128 and all elements &lt; 64 bytes, <code>zset-max-ziplist-entries</code> and <code>zset-max-ziplist-value</code> in configurations</li> <li><code>REDIS_ENCODING_SKIPLIST</code> -- use <code>zset</code>: like <code>java.util.LinkedHashMap</code> but with skiplist in lieu of linked list<div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">zset</span> <span class="token punctuation">{</span>
    zskiplist <span class="token operator">*</span>zsl<span class="token punctuation">;</span>
    dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>
<span class="token punctuation">}</span> zset<span class="token punctuation">;</span>
</code></pre></div></li></ul></li> <li>related commands
<ul><li><code>ZCARD</code></li> <li><code>ZADD</code></li> <li><code>ZRANGE</code>, <code>ZREVRANGE</code></li> <li><code>ZSCORE</code></li> <li><code>ZCOUNT</code></li> <li><code>ZRANK</code>, <code>ZREVRANK</code></li> <li><code>ZREM</code></li></ul></li></ul></li></ol> <h3 id="sort"><a href="#sort" class="header-anchor">#</a> Sort</h3> <ol><li>sort<div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_redisSortObject</span> <span class="token punctuation">{</span>
    robj <span class="token operator">*</span>obj<span class="token punctuation">;</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> score<span class="token punctuation">;</span>
        robj <span class="token operator">*</span>cmpobj<span class="token punctuation">;</span> <span class="token comment">// for BY ALPHA</span>
    <span class="token punctuation">}</span> u<span class="token punctuation">;</span>
<span class="token punctuation">}</span> redisSortObject<span class="token punctuation">;</span>
</code></pre></div><ul><li>steps
<ol><li>create an array of <code>redisSortObject</code></li> <li>populate <code>redisSortObject-&gt;obj</code></li> <li>populate scores, skipped when <code>ALPHA</code>, according to the pattern when <code>BY</code>;otherwise populate <code>cmpobj</code> if <code>BY</code> with <code>ALPHA</code></li> <li>sort, by quicksort</li> <li>return to the client</li></ol></li> <li>compare by<div class="language- extra-class"><pre class="language-text"><code>reids&gt; SADD fruits &quot;apple&quot; &quot;banana&quot; &quot;cherry&quot;
redis&gt; MSET apple-price 8 banana-price 5.5 cherry-price 7
redis&gt; SORT fruits BY *-price
</code></pre></div></li> <li>related commands
<ul><li><code>SORT</code><div class="language- extra-class"><pre class="language-text"><code>SORT key [BY pattern] [LIMIT offset count] [GET pattern [GET pattern ...]] [ASC|DESC] [ALPHA] [STORE destination]
</code></pre></div><ul><li><code>ALPHA</code> -- lexicographically</li> <li><code>ASC</code>, <code>DESC</code></li> <li><code>BY</code></li> <li><code>LIMIT</code></li> <li><code>GET</code> -- get pattern</li> <li><code>STORE</code></li></ul></li></ul></li></ul></li></ol> <h2 id="server"><a href="#server" class="header-anchor">#</a> Server</h2> <ol><li><p>server</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span> <span class="token comment">// db array</span>
  <span class="token keyword">int</span> dbnum<span class="token punctuation">;</span>                      <span class="token comment">/* Total number of configured DBs */</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// part of stats</span>
  <span class="token keyword">long</span> <span class="token keyword">long</span> stat_keyspace_hits<span class="token punctuation">;</span>   <span class="token comment">/* Number of successful lookups of keys */</span>
  <span class="token keyword">long</span> <span class="token keyword">long</span> stat_keyspace_misses<span class="token punctuation">;</span> <span class="token comment">/* Number of failed lookups of keys */</span>
  <span class="token comment">// ...</span>
  <span class="token comment">/* RDB persistence */</span>
  <span class="token keyword">long</span> <span class="token keyword">long</span> dirty<span class="token punctuation">;</span>                <span class="token comment">/* Changes to DB from the last save */</span>
  <span class="token keyword">long</span> <span class="token keyword">long</span> dirty_before_bgsave<span class="token punctuation">;</span>  <span class="token comment">/* Used to restore dirty on failed BGSAVE */</span>
  <span class="token comment">// ...</span>
  <span class="token comment">/* Networking */</span>
  list <span class="token operator">*</span>clients<span class="token punctuation">;</span>              <span class="token comment">/* List of active clients */</span>
  list <span class="token operator">*</span>clients_to_close<span class="token punctuation">;</span>     <span class="token comment">/* Clients to close asynchronously */</span>
  list <span class="token operator">*</span>clients_pending_write<span class="token punctuation">;</span> <span class="token comment">/* There is to write or install handler. */</span>
  list <span class="token operator">*</span>clients_pending_read<span class="token punctuation">;</span>  <span class="token comment">/* Client has pending read socket buffers. */</span>
  <span class="token comment">// ...</span>
  <span class="token comment">/* Scripting */</span>
  lua_State <span class="token operator">*</span>lua<span class="token punctuation">;</span> <span class="token comment">/* The Lua interpreter. We use just one for all clients */</span>
  client <span class="token operator">*</span>lua_client<span class="token punctuation">;</span>   <span class="token comment">/* The &quot;fake client&quot; to query Redis from Lua */</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>dbnum</code> -- defaults to 16, <code>database</code> in configurations</li> <li>maintainence when reading or writing a keyspace
<ul><li>maintain statistics, like <code>stat_keyspace_hits</code>, <code>stat_keyspace_misses</code></li> <li>update <code>redisObject.lru</code></li> <li>delete a key if expired</li> <li>mark <code>WATCH</code>ed keys dirty</li> <li>increment <code>dirty</code> counters</li> <li>dispatch notifications</li></ul></li> <li>related commands
<ul><li><code>INFO</code> <ul><li><code>SERVER</code></li> <li><code>STATS</code></li></ul></li></ul></li></ul></li> <li><p><code>redisDb</code></p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">/* Redis database representation. There are multiple databases identified
 * by integers from 0 (the default database) up to the max configured
 * database. The database number is the 'id' field in the structure. */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisDb</span> <span class="token punctuation">{</span>
    dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>                 <span class="token comment">/* The keyspace for this DB */</span>
    dict <span class="token operator">*</span>expires<span class="token punctuation">;</span>              <span class="token comment">/* Timeout of keys with a timeout set */</span>
    dict <span class="token operator">*</span>blocking_keys<span class="token punctuation">;</span>        <span class="token comment">/* Keys with clients waiting for data (BLPOP)*/</span>
    dict <span class="token operator">*</span>ready_keys<span class="token punctuation">;</span>           <span class="token comment">/* Blocked keys that received a PUSH */</span>
    dict <span class="token operator">*</span>watched_keys<span class="token punctuation">;</span>         <span class="token comment">/* WATCHED keys for MULTI/EXEC CAS */</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>                     <span class="token comment">/* Database ID */</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> avg_ttl<span class="token punctuation">;</span>          <span class="token comment">/* Average TTL, just for stats */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> expires_cursor<span class="token punctuation">;</span> <span class="token comment">/* Cursor of the active expire cycle. */</span>
    list <span class="token operator">*</span>defrag_later<span class="token punctuation">;</span>         <span class="token comment">/* List of key names to attempt to defrag one by one, gradually. */</span>
<span class="token punctuation">}</span> redisDb<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>expires</code> -- a dict where keys are pointers to keys in keyspace, values are <code>long long</code> UNIX timestamps
<ul><li>expungement strategy
<ul><li>lazy -- expunge when reading the key</li> <li>periodic -- expunge with a frequency and duration; continue from the last expunged <code>redisDb</code>, cycling the db array; examine and expunge keys randomly selected from <code>expires</code> for each <code>redisDb</code></li></ul></li> <li>related commands -- <code>PEXPIREAT</code> under the hood
<ul><li><code>EXPIRE</code>, <code>PEXPIRE</code>, <code>SETEX</code> (only for string) -- TTL, in s or ms</li> <li><code>EXPIREAT</code>, <code>PEXPIREAT</code> -- UNIX timestamp, in s or ms</li> <li><code>TTL</code>, <code>PTTL</code> -- remaining time to live, in s or ms</li> <li><code>PERSIST</code> -- remove timestamp</li></ul></li> <li>replication related -- key expungement of followers is controlled by the master, who sends <code>DEL</code> commands to followers</li> <li>persistence related
<ul><li>RDB
<ul><li>when <code>SAVE</code> or <code>BGSAVE</code> -- expired keys filtered</li> <li>when loading data -- master will filter expired keys, followers will not (cleared when syncing with master)</li></ul></li> <li>AOF
<ul><li>when writing to AOF -- when expunged, a <code>DEL</code> is explicitly appended</li> <li>when rewriting AOF -- expired keys filtered</li></ul></li></ul></li></ul></li> <li>related commands
<ul><li><code>FLUSHDB</code></li> <li><code>RANDOMKEY</code></li> <li><code>DBSIZE</code></li> <li><code>EXISTS</code></li> <li><code>DEL</code></li> <li><code>RENAME</code></li> <li><code>KEYS</code></li> <li><code>INFO</code>, <code>INFO STATS</code></li></ul></li></ul></li> <li><p>client</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">client</span> <span class="token punctuation">{</span> <span class="token comment">// once called redisClient</span>
  <span class="token keyword">uint64_t</span> id<span class="token punctuation">;</span>            <span class="token comment">/* Client incremental unique ID. */</span>
  connection <span class="token operator">*</span>conn<span class="token punctuation">;</span> <span class="token comment">// fd, connection type, state, flags, callbacks</span>
  <span class="token comment">// ...</span>
  redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span>            <span class="token comment">/* Pointer to currently SELECTed DB. */</span>
  robj <span class="token operator">*</span>name<span class="token punctuation">;</span>             <span class="token comment">/* As set by CLIENT SETNAME. */</span>
  sds querybuf<span class="token punctuation">;</span>           <span class="token comment">/* Buffer we use to accumulate client queries. */</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">uint64_t</span> flags<span class="token punctuation">;</span>         <span class="token comment">/* Client flags: CLIENT_* macros. */</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span> client<span class="token punctuation">;</span>
</code></pre></div><ul><li>query buffer or reply buffer overflow -- the client will be closed
<ul><li>hard limit -- close immediately</li> <li>soft limit -- close after the time since <code>time_t obuf_soft_limit_reached_time</code> beyond configured, <code>client-output-buffer-limit</code> in configurations</li></ul></li> <li><code>querybuf</code> related fields<div class="language-cpp extra-class"><pre class="language-cpp"><code>size_t qb_pos<span class="token punctuation">;</span>          <span class="token comment">/* The position we have read in querybuf. */</span>
sds pending_querybuf<span class="token punctuation">;</span>   <span class="token comment">/* If this client is flagged as master, this buffer
                           represents the yet not applied portion of the
                           replication stream that we are receiving from
                           the master. */</span>
size_t querybuf_peak<span class="token punctuation">;</span>   <span class="token comment">/* Recent (100ms or more) peak of querybuf size. */</span>
<span class="token keyword">int</span> argc<span class="token punctuation">;</span>               <span class="token comment">/* Num of arguments of current command. */</span>
robj <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">;</span>            <span class="token comment">/* Arguments of current command. */</span>
<span class="token keyword">struct</span> <span class="token class-name">redisCommand</span> <span class="token operator">*</span>cmd<span class="token punctuation">,</span> <span class="token operator">*</span>lastcmd<span class="token punctuation">;</span>  <span class="token comment">/* Last command executed. */</span>
</code></pre></div></li> <li><code>flags</code><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">/* Client flags */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_SLAVE</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>   </span><span class="token comment">/* This client is a repliaca */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_MASTER</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span>  </span><span class="token comment">/* This client is a master */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_MONITOR</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span> </span><span class="token comment">/* This client is a slave monitor, see MONITOR */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_MULTI</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span>   </span><span class="token comment">/* This client is in a MULTI context */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_BLOCKED</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span> </span><span class="token comment">/* The client is waiting in a blocking operation */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_DIRTY_CAS</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span> </span><span class="token comment">/* Watched keys modified. EXEC will fail. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_CLOSE_AFTER_REPLY</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span> </span><span class="token comment">/* Close after writing entire reply. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_UNBLOCKED</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span> </span><span class="token comment">/* This client was unblocked and is stored in
                                  server.unblocked_clients */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_LUA</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> </span><span class="token comment">/* This is a non connected client used by Lua */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_ASKING</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span>     </span><span class="token comment">/* Client issued the ASKING command */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_CLOSE_ASAP</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span></span><span class="token comment">/* Close this client ASAP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_UNIX_SOCKET</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">)</span> </span><span class="token comment">/* Client connected via Unix domain socket */</span></span>
<span class="token comment">// more</span>
</code></pre></div></li> <li>more</li> <li>related commands
<ul><li><code>SELECT</code></li> <li><code>CLIENT</code> <ul><li><code>LIST</code></li> <li><code>SETNAME</code></li> <li><code>KILL</code></li></ul></li></ul></li></ul></li> <li><p><code>redisCommand</code></p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">redisCommand</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    redisCommandProc <span class="token operator">*</span>proc<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>sflags<span class="token punctuation">;</span>   <span class="token comment">/* Flags as string representation, one char per flag. */</span>
    <span class="token keyword">uint64_t</span> flags<span class="token punctuation">;</span> <span class="token comment">/* The actual flags, obtained from the 'sflags' field. */</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> microseconds<span class="token punctuation">,</span> calls<span class="token punctuation">;</span> <span class="token comment">// statistics</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><code>name</code> -- <code>client-&gt;argv[0]</code></li> <li><code>proc</code> -- callback, called as <code>client-&gt;cmd-&gt;proc(client)</code></li> <li><code>sflags</code> <ul><li><code>w</code> -- write, like <code>SET</code>, <code>RPUSH</code>, <code>DEL</code></li> <li><code>r</code> -- read, like <code>GET</code>, <code>STRLEN</code>, <code>EXISTS</code></li> <li><code>m</code> -- 这个命令可能会占用大量内存，执行之前需要先检查服务器的内存使用情况，如果内存紧缺的话就禁止执行这个命令。 like <code>SET</code>, <code>APPEND</code>, <code>RPUSH</code>, <code>LPUSH</code>, <code>SADD</code>, <code>SINTERSTORE</code></li> <li>more</li></ul></li></ul></li></ol> <h2 id="events"><a href="#events" class="header-anchor">#</a> Events</h2> <ol><li><p>event loop</p> <ul><li>file events -- sockets</li> <li>time events -- <code>serverCron</code></li> <li>flush AOF buffer</li></ul></li> <li><p>file events -- Reactor model, I/O multiplexing, event queuing at event dispatcher</p> <ul><li>event handlers
<ul><li><code>acceptTcpHandler</code></li> <li><code>readQueryFromClient</code></li> <li><code>sendReplyToClient</code></li> <li>more</li></ul></li> <li>tbd</li></ul></li> <li><p>time events -- tbd</p> <ul><li>one time scheduled events</li> <li>periodic events
<ul><li><code>serverCron</code> -- <code>hz</code> in configurations, defaults to 10, update statistics, expunge expired keys, close and clear sessions, AOF and RDB, follower replication, cluster synchronization and heartbeat</li></ul></li></ul></li> <li><p><code>serverCron</code></p> <ul><li>update tasks
<ul><li>update timestamp cache -- timestamp cached in <code>redisServer.unixtime</code> and <code>redisServer.mstime</code> to reduce system calls for timestamp insensitive tasks like logging, deciding persistence time point, <code>EXPIRE</code> and slow query log not included</li> <li>update <code>redisServer.lruclock</code> timestamp cache, defaults to once every 10s</li> <li>update stats</li></ul></li> <li>more tasks</li></ul></li></ol> <h2 id="publish-and-subscribe"><a href="#publish-and-subscribe" class="header-anchor">#</a> Publish and Subscribe</h2> <ol><li><p>publish and subscribe</p> <ul><li>channels<div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  dict <span class="token operator">*</span>pubsub_channels<span class="token punctuation">;</span>  <span class="token comment">/* channels a client is interested in (SUBSCRIBE) */</span>
  list <span class="token operator">*</span>pubsub_patterns<span class="token punctuation">;</span>  <span class="token comment">/* patterns a client is interested in (SUBSCRIBE) */</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>pubsub_channels</code> -- <code>dict</code>, key as channel name, value as a linked list of subscribed clients</li> <li><code>pubsub_patterns</code> -- <code>list</code>, <code>pubsubPattern</code> as elements<div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">pubsubPattern</span> <span class="token punctuation">{</span>
    client <span class="token operator">*</span>client<span class="token punctuation">;</span>
    robj <span class="token operator">*</span>pattern<span class="token punctuation">;</span>
<span class="token punctuation">}</span> pubsubPattern<span class="token punctuation">;</span>
</code></pre></div></li></ul></li> <li>related commands
<ul><li><code>SUBSCRIBE</code></li> <li><code>PUBLISH</code></li> <li><code>PSUBSCRIBE</code> -- subscribe but support glob-style patterns</li> <li><code>PUBSUB</code></li> <li><code>PUNSUBSCRIBE</code></li> <li><code>UNSUBSCRIBE</code></li></ul></li></ul></li> <li><p>keyspace changes notification</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>event<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> dbid<span class="token punctuation">)</span>
</code></pre></div><ul><li>keyspace event -- every key event in a keyspace, <code>notify-keyspace-events</code> in configurations
<ul><li>key event -- commands on keys</li></ul></li> <li>channel name -- prefixed with <code>__keyspace@&lt;db&gt;__</code>, like <code>__keyspace@0__:foo</code></li> <li>parameters
<ul><li><code>event</code> -- command name, like <code>del</code></li> <li><code>key</code>, <code>dbid</code> -- related key and db</li> <li><code>type</code><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">/* Keyspace changes notification classes. Every class is associated with a
 * character for configuration purposes. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_KEYSPACE</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>    </span><span class="token comment">/* K */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_KEYEVENT</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span>    </span><span class="token comment">/* E */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_GENERIC</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span>     </span><span class="token comment">/* g */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_STRING</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span>      </span><span class="token comment">/* $ */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_LIST</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span>        </span><span class="token comment">/* l */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_SET</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span>         </span><span class="token comment">/* s */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_HASH</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span>        </span><span class="token comment">/* h */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_ZSET</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span>        </span><span class="token comment">/* z */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_EXPIRED</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span>     </span><span class="token comment">/* x */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_EVICTED</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span>     </span><span class="token comment">/* e */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_STREAM</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span>     </span><span class="token comment">/* t */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_KEY_MISS</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">)</span>   </span><span class="token comment">/* m (Note: This one is excluded from NOTIFY_ALL on purpose) */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_LOADED</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">)</span>     </span><span class="token comment">/* module only key space notification, indicate a key loaded from rdb */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_ALL</span> <span class="token punctuation">(</span>NOTIFY_GENERIC <span class="token operator">|</span> NOTIFY_STRING <span class="token operator">|</span> NOTIFY_LIST <span class="token operator">|</span> NOTIFY_SET <span class="token operator">|</span> NOTIFY_HASH <span class="token operator">|</span> NOTIFY_ZSET <span class="token operator">|</span> NOTIFY_EXPIRED <span class="token operator">|</span> NOTIFY_EVICTED <span class="token operator">|</span> NOTIFY_STREAM<span class="token punctuation">)</span> </span><span class="token comment">/* A flag */</span></span>
</code></pre></div></li></ul></li></ul></li></ol> <h2 id="persistence"><a href="#persistence" class="header-anchor">#</a> Persistence</h2> <ol><li><p>RDB -- persistence of current snapshot in memory as a compressed binary file</p> <ul><li>expired key handling -- see <code>redisDb</code></li> <li>automatic load -- if AOF switched off, RDB files are loaded automatically at start</li> <li>auto <code>BGSAVE</code> -- <code>save</code> in configurations, triggered if <code>redisServer.dirty</code> more than configured during corresponding configured time duration, executed by <code>serverCron</code> function
<ul><li><code>redisServer.dirty</code> -- counter for changes to keys since last <code>SAVE</code> or <code>BGSAVE</code>, for example, the counter will +3 after <code>SADD</code> 3 elements on a key</li> <li><code>redisServer.lastsave</code> -- timestamp of last successful <code>SAVE</code> or <code>BGSAVE</code></li></ul></li> <li>RDB file format -- tbd</li> <li>related commands
<ul><li><code>SAVE</code> -- blocking</li> <li><code>BGSAVE</code> -- non-blocking in a forked process, but reject other <code>SAVE</code>, <code>BGSAVE</code>, <code>BGREWRITEAOF</code> when executing</li></ul></li></ul></li> <li><p>AOF -- append only file, text file format, recording write commands</p> <ul><li>steps
<ul><li>append -- write to buffer <code>redisServer.aof_buf</code>, whose type is <code>sds</code></li> <li>write and sync -- at the end of every event loop, <code>flushAppendOnlyFile</code> executed, which writes to AOF and sync as <code>appendfsync</code> in configurations</li></ul></li> <li><code>appendfsync</code> in configurations
<ul><li><code>always</code> -- also depends on <code>no-appendfsync-on-rewrite</code>, which defaults to false</li> <li><code>everysec</code>, default -- if over 1 sec since last sync; by a dedicated thread</li> <li><code>no</code> -- no sync, sync handled by OS</li></ul></li> <li>AOF loading -- fake client created, from which commands in AOF executed</li> <li>AOF rewrite -- deduplicate AOF, implemented by generating commands from current database state with care for client input buffer overflow
<ul><li>avoid blocking -- AOF rewrite is executed in a forked process, new commands during AOF rewrite are simultaneously saved in a separate buffer, which is flushed before the new AOF replace the previous one</li></ul></li> <li>expired key handling -- see <code>redisDb</code></li> <li>related commands
<ul><li><code>BGREWRITEAOF</code> -- non-blocking, but reject <code>BGSAVE</code> when executing</li></ul></li></ul></li></ol> <h2 id="clustering"><a href="#clustering" class="header-anchor">#</a> Clustering</h2> <ol><li><p>replication</p> <ul><li>set slave -- <code>SLAVEOF</code> command, or <code>slaveof</code> in configurations</li> <li>synchronization
<ul><li><code>SYNC</code> -- used in old version, slave send <code>SYNC</code> to master, the master starts recording commands while <code>BGSAVE</code> for RDB file and send it to the slave, the slave load the file, and the master send commands since <code>BGSAVE</code> to the slave</li> <li><code>PSYNC</code> -- full resynchronization as <code>SYNC</code> for initial replication, partial resynchronization as recovery</li> <li>command propagate -- propagate commands with side effects after <code>SYNC</code></li> <li>heartbeat -- slaves will ping master with <code>REPLCONF ACK replication_offset</code> periodically, defaults to 1 Hz, <code>lag</code> in the output of <code>INFO replication</code> <ul><li>anti-entropy -- reconcile if the <code>replication_offset</code> received by master does not match its own, e.g. some command propagate message lost</li> <li>related configurations <code>min-slaves-to-write</code>, <code>min-slaves-max-lag</code></li></ul></li></ul></li> <li>partial resynchronization implementation -- by replication offset in master and slave, replication backlog in master as buffer, and server ID (run ID)
<ul><li>replication offset -- master adds n to its offset upon n bytes propagated, slave adds n to its offset upon n bytes received</li> <li>replication backlog -- fixed size FIFO queue defaults to 1 MB, saving propagated commands; if the command the replication offset in slave points to no longer in the queue, resort to full resynchronization</li> <li>run ID -- slave will persist the ID of the master server, send back to master upon recovering, full resynchronization if not the same master</li></ul></li> <li>related commands
<ul><li><code>SLAVEOF</code></li> <li><code>SYNC</code>, <code>PSYNC</code> -- internal command</li> <li><code>REPLCONF</code></li> <li><code>INFO replication</code></li></ul></li></ul></li> <li><p>sentinel -- monitor the cluster and pick new leader</p> <ul><li>available commands -- <code>PING</code>, pub/sub etc., see <code>sentinelcmds[]</code> in <code>sentinel.c</code></li> <li>configurations -- <code>sentinel</code></li> <li>state<div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">/* Main state. */</span>
<span class="token keyword">struct</span> <span class="token class-name">sentinelState</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">uint64_t</span> current_epoch<span class="token punctuation">;</span>         <span class="token comment">/* Current epoch. */</span>
    dict <span class="token operator">*</span>masters<span class="token punctuation">;</span>      <span class="token comment">/* Dictionary of master sentinelRedisInstances.
                           Key is the instance name, value is the
                           sentinelRedisInstance structure pointer. */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> sentinel<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>sentinelRedisInstance</code> -- states of master, slave or another sentinel, tbd</li></ul></li> <li>link -- command link and subscribe link, first established to the master and then slaves
<ul><li>channel -- sentinel subscribe by sending command <code>SUBSCRIBE __sentinel__:hello</code> via subscribe link once it is established</li> <li>inter-sentinel link -- upon the discovery of other sentinels, command links established mutually</li></ul></li> <li>heartbeat
<ul><li><code>INFO</code> master and slaves -- sentinel will send <code>INFO</code> to master in 0.1 Hz, refreshing <code>run_id</code> and <code>slaves</code> accordingly, for newly added slaves, sentinel will create link to them and send heartbeats in the same manner, and extract <code>run_id</code>, <code>role</code>, <code>master_link_status</code>, <code>slave_priority</code>, <code>slave_repl_offset</code> etc. from <code>INFO</code></li> <li>make master and slaves <code>PUBLISH</code> and piggyback -- sentinel send <code>PUBLISH</code> to master and slave, defaults to 0.5 Hz<div class="language- extra-class"><pre class="language-text"><code>PUBLISH __sentinel__:hello &quot;&lt;s_ip&gt;,&lt;s_port&gt;,&lt;s_runid&gt;,&lt;s_epoch&gt;,&lt;m_name&gt;,&lt;m_id&gt;,&lt;m_port&gt;,&lt;m_epoch&gt;
</code></pre></div><ul><li><code>s_</code> for sentinel, <code>m_</code> for master</li> <li>loop: perception of other sentinels -- sentinels can <code>PUBLISH</code> via command link and receive via their subscription, for piggybacked message, ignore if same ID as self in the message, update states according to the message if other sentinels</li></ul></li> <li>to master, slaves and other sentinels -- sentinel <code>PING</code> other servers in 1 Hz, with possible response <code>+PONG</code>, <code>-LOADING</code>, <code>-MASTERDOWN</code> <ul><li>subjective down -- if no valid response for <code>down-after-milliseconds</code> in sentinel configurations, <code>SRI_S_DOWN</code> will be ORed to flags; opinion may vary among sentinels</li> <li>objective down -- ask other sentinels, <code>SRI_S_DOWN</code> ORed if subjective down for a quorum, <code>quorum</code> set in sentinel configurations and can vary among sentinels<div class="language- extra-class"><pre class="language-text"><code>SENTINEL is-master-down-by-addr &lt;ip&gt; &lt;port&gt; &lt;current_epoch&gt; &lt;run_id_or_star&gt;
</code></pre></div>response, where the last two only used for leader election<div class="language- extra-class"><pre class="language-text"><code>1) &lt;down_state&gt;
2) &lt;leader_runid&gt;
3) &lt;leader_epoch&gt;
</code></pre></div></li></ul></li></ul></li> <li>sentinel leader election (Raft) -- after master server objective down, a sentinel will <code>SENTINEL is-master-down-by-addr</code> to other sentinels but with own <code>run_id</code>, the following runs like Raft</li> <li>failover -- after master failure, the leader sentinel selects a slave as the new master by sending <code>SLAVEOF no one</code>, then <code>INFO</code> in 1 Hz to see if <code>role</code> in response becomes <code>master</code>, and the <code>SLAVEOF</code> other slaves to set the new master, also <code>SLAVEOF</code> the old master once it come back
<ul><li>master selection -- filter out down slaves, slaves with no response for <code>INFO</code> for 5s, slaves whose link with the old master broke for <code>down-after-milliseconds * 10</code>; then sort by <code>slave_priority</code>, <code>slave_repl_offset</code>, <code>run_id</code> and choose the best</li></ul></li></ul></li> <li><p>cluster -- database sharing</p> <ul><li>enable cluster -- <code>cluster-enabled</code> in configurations, a node can only <code>SELECT</code> 0</li> <li>add node to cluster -- three way handshake after <code>CLUSTER MEET</code> from the client: <code>MEET</code>, <code>PONG</code>, <code>PING</code>; then disseminate to other nodes via Gossip (heartbeats) to let them handshake the new node<div class="language- extra-class"><pre class="language-text"><code>CLUSTER MEET &lt;ip&gt; &lt;port&gt;
</code></pre></div></li> <li>structures in <code>cluster.h</code> -- <code>clusterNode</code>, <code>clusterLink</code>, <code>clusterState</code></li> <li>slots -- <code>1 &lt;&lt; 14</code> = 16384 slots, <code>CLUSTER_FAIL</code> even if only one slot not handled
<ul><li>delegate slots to a node -- <code>CLUSTER ADDSLOTS</code></li> <li>slot state store -- as a <code>clusterNode</code> map in <code>clusterState.slots</code> and as a bit vector <code>slots</code> in <code>clusterNode</code> in <code>clusterState-&gt;nodes</code></li> <li>broadcast <code>slots</code> -- a node will broadcast its <code>slots</code> to other nodes, which is kept in <code>clusterState.slots</code> and <code>clusterNode</code> in <code>clusterState-&gt;nodes</code><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterState</span> <span class="token punctuation">{</span>
    clusterNode <span class="token operator">*</span>myself<span class="token punctuation">;</span>  <span class="token comment">/* This node */</span>
    <span class="token comment">// ...</span>
    dict <span class="token operator">*</span>nodes<span class="token punctuation">;</span>          <span class="token comment">/* Hash table of name -&gt; clusterNode structures */</span>
    dict <span class="token operator">*</span>nodes_black_list<span class="token punctuation">;</span> <span class="token comment">/* Nodes we don't re-add for a few seconds. */</span>
    clusterNode <span class="token operator">*</span>migrating_slots_to<span class="token punctuation">[</span>CLUSTER_SLOTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    clusterNode <span class="token operator">*</span>importing_slots_from<span class="token punctuation">[</span>CLUSTER_SLOTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    clusterNode <span class="token operator">*</span>slots<span class="token punctuation">[</span>CLUSTER_SLOTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> slots_keys_count<span class="token punctuation">[</span>CLUSTER_SLOTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    rax <span class="token operator">*</span>slots_to_keys<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> clusterState<span class="token punctuation">;</span>
</code></pre></div><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterNode</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> slots<span class="token punctuation">[</span>CLUSTER_SLOTS<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* slots handled by this node */</span>
    <span class="token keyword">int</span> numslots<span class="token punctuation">;</span>   <span class="token comment">/* Number of slots handled by this node */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> clusterNode<span class="token punctuation">;</span>
</code></pre></div></li> <li>hash function -- <code>CRC16(key) &amp; 0x3fff</code>, command <code>CLUSTER KEYSLOT</code> <ul><li><code>0x3fff</code> -- bitmap for a node will be of size 2 KB, which saves bandwidth compared to 65536 slots, and 16384 slots are enough for clusters under 1000 nodes</li></ul></li> <li><code>slots_to_keys</code> -- slot to key mapping as radix trees, support for commands like <code>CLUSTER GETKEYSINSLOT</code></li></ul></li> <li>sharding and re-sharding
<ul><li>sharding -- execute if the right slot, otherwise redirect the client to the node the slot belongs to by a <code>MOVE</code> error</li> <li>re-sharding -- adjust slot distribution and migrate slots</li> <li>migrate slots -- executed online by cluster management utility redis-trib, one slot by one slot
<ol><li>send <code>CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;source_id&gt;</code> to target node, setting its <code>clusterState.importing_slots_from[slot]</code> to source node</li> <li>send <code>CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;target_id&gt;</code> to source node, setting its <code>clusterState.migrating_slots_to[slot]</code> t target node</li> <li>send <code>CLUSTER GETKEYSINSLOT</code> to source node, for keys responded, send <code>MIGRATE</code> to source node; repeat until all keys migrated</li> <li>send <code>CLUSTER SETSLOT &lt;slot&gt; NODE &lt;target_id&gt;</code> to any node to disseminate the information to the cluster</li></ol></li> <li>command executing when migrating -- if the key does not exist on the source node, send <code>ASK</code> error to redirect the client to the target node, and client send <code>ASKING</code> to the redirected node before resending command
<ul><li><code>ASKING</code> -- turn on <code>REDIS_ASKING</code> in <code>client.flags</code> for next command; a node will refrain from send <code>MOVE</code> error and try to execute the command even if the slot is not delegated to the node if <code>REDIS_ASKING</code> on the client and <code>clusterState.importing_slots_from[slot]</code> is not <code>NULL</code></li></ul></li></ul></li> <li>replication and failover -- use replication for each node and select a slave as the new master if the original master is down
<ul><li>set slave -- <code>CLUSTER REPLICATE</code>, set <code>clusterState.myself.slaveof</code> and turn off <code>CLUSTER_NODE_MASTER</code> and turn on <code>CLUSTER_NODE_SLAVE</code> <code>clusterState.myself.flags</code>, then information disseminated via heartbeats, and other nodes update information in <code>clusterNode-&gt;slaves</code>, <code>clusterNode.numslaves</code></li> <li><code>CLUSTER_NODE_PFAIL</code> and <code>CLUSTER_NODE_FAIL</code> <ul><li>heartbeat and <code>CLUSTER_NODE_PFAIL</code> -- nodes (masters and slaves) in cluster will periodically <code>PING</code> each other, if no <code>PONG</code>, mark <code>CLUSTER_NODE_PFAIL</code> (probable fail) for target node in <code>clusterState.nodes</code> and disseminate via heartbeat message; upon receiving such message, a node will append to <code>clusterNode-&gt;fail_reports</code> in <code>clusterState.nodes</code></li> <li><code>CLUSTER_NODE_FAIL</code> -- if a majority of master nodes mark one master node <code>CLUSTER_NODE_PFAIL</code>, then that node will be marked <code>CLUSTER_NODE_FAIL</code>, and a <code>FAIL</code> message will be broadcasted</li></ul></li> <li>failover -- when the master fails, a slave is elected to <code>SLAVEOF no one</code>, cancel slots in the original master and add those slots for itself, then broadcast a <code>PONG</code> to inform the cluster
<ul><li>new master election -- Raft, other master nodes can vote</li></ul></li></ul></li> <li>messages
<ul><li>type
<ul><li><code>MEET</code></li> <li><code>PING</code> -- once every second, every node selects 5 other random nodes to <code>PING</code>; besides, every node <code>PING</code> nodes whose last <code>PONG</code> till now is over half of <code>cluster-node-timeout</code></li> <li><code>PONG</code> -- response to <code>MEET</code> and <code>PING</code>, and voluntary broadcast</li> <li><code>FAIL</code> -- broadcasted ASAP</li> <li><code>PUBLISH</code> -- clients can subscribe to every node, and can also publish to every other node; the current implementation will simply broadcast each published message to all other nodes, but at some point this will be optimized either using Bloom filters or other algorithms</li></ul></li> <li>header common to all messages -- <code>clusterMsg</code> in <code>cluster.h</code>, includes the sender's ID, <code>currentEpoch</code>, <code>configEpoch</code>, flags, slot bitmap, address, master ID, cluster state POV (<code>CLUSTER_OK</code> or <code>CLUSTER_FAIL</code>)</li> <li>heartbeat -- <code>PING</code>, <code>PONG</code>, also contain a Gossip section</li> <li>Gossip section -- for <code>MEET</code>, <code>PING</code> and <code>PONG</code> messages, offering a view of ID, last <code>PING</code> and <code>PONG</code> timestamps, address and flags of a few random nodes from the sender<div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">/* PING, MEET and PONG */</span>
<span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">/* Array of N clusterMsgDataGossip structures */</span>
    clusterMsgDataGossip gossip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> ping<span class="token punctuation">;</span>
</code></pre></div></li></ul></li> <li>related command <code>CLUSTER</code> <ul><li><code>MEET</code></li> <li><code>NODES</code></li> <li><code>INFO</code></li> <li><code>ADDSLOTS</code>, <code>SETSLOT</code></li> <li><code>KEYSLOT</code></li> <li><code>GETKEYSINSLOT</code></li> <li><code>REPLICATE</code></li></ul></li></ul></li></ol> <h2 id="transaction"><a href="#transaction" class="header-anchor">#</a> Transaction</h2> <ol><li><p>transaction -- queue commands and execute them atomically</p> <ul><li>command queue -- all commands except transaction related commands will be validated and queued<div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">multiState</span> <span class="token punctuation">{</span>
    multiCmd <span class="token operator">*</span>commands<span class="token punctuation">;</span>     <span class="token comment">/* Array of MULTI commands */</span>
    <span class="token keyword">int</span> count<span class="token punctuation">;</span>              <span class="token comment">/* Total number of MULTI commands */</span>
    <span class="token keyword">int</span> cmd_flags<span class="token punctuation">;</span>          <span class="token comment">/* The accumulated command flags OR-ed together.
                               So if at least a command has a given flag, it
                               will be set in this field. */</span>
    <span class="token keyword">int</span> cmd_inv_flags<span class="token punctuation">;</span>      <span class="token comment">/* Same as cmd_flags, OR-ing the ~flags. so that it
                               is possible to know if all the commands have a
                               certain flag. */</span>
    <span class="token keyword">int</span> minreplicas<span class="token punctuation">;</span>        <span class="token comment">/* MINREPLICAS for synchronous replication */</span>
    time_t minreplicas_timeout<span class="token punctuation">;</span> <span class="token comment">/* MINREPLICAS timeout as unixtime. */</span>
<span class="token punctuation">}</span> multiState<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">client</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    multiState mstate<span class="token punctuation">;</span>      <span class="token comment">/* MULTI/EXEC state */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> client<span class="token punctuation">;</span>
</code></pre></div></li> <li>optimistic lock -- <code>WATCH</code>, transaction aborted if any <code>WATCH</code>ed key is modified before <code>EXEC</code> <ul><li>implementation -- <code>redisDb-&gt;watched_keys</code>, <code>dict</code> of key to client linked list; add <code>CLIENT_DIRTY_CAS</code> in <code>client.flags</code> if a command with <code>w</code> in <code>redisCommand.sflags</code> modified watched keys</li></ul></li> <li>ACID -- guaranteed by single thread, except durability
<ul><li>force durability -- <code>SAVE</code> before <code>EXEC</code>, but low performance</li></ul></li></ul></li> <li><p>non-transactional pipeline -- batch commands but not in a transaction</p></li> <li><p>related commands</p> <ul><li><code>MULTI</code> -- start transaction, <code>CLIENT_MULTI</code> in <code>client.flags</code></li> <li><code>EXEC</code> -- commit</li> <li><code>WATCH</code>, <code>UNWATCH</code></li> <li><code>DISCARD</code></li></ul></li></ol> <h2 id="other"><a href="#other" class="header-anchor">#</a> Other</h2> <ol><li><p>config</p> <ul><li>config file -- <code>/etc/redis/redis.conf</code></li> <li>related commands
<ul><li><code>CONFIG</code></li></ul></li></ul></li> <li><p>eviction when <code>maxmemory</code></p> <ul><li><code>volatile-lru</code> -- 从已设置过期时间的数据集中挑选最近最少使用的数据淘汰</li> <li><code>volatile-ttl</code> -- 从已设置过期时间的数据集中挑选将要过期的数据淘汰</li> <li><code>volatile-random</code> -- 从已设置过期时间的数据集中任意选择数据淘汰</li> <li><code>allkeys-lru</code> -- 从所有数据集中挑选最近最少使用的数据淘汰</li> <li><code>allkeys-random</code> -- 从所有数据集中任意选择数据进行淘汰</li> <li><code>noeviction</code> -- 禁止驱逐数据</li></ul></li> <li><p>Lua</p> <ul><li>create Lua environment
<ol><li>创建一个基础的 Lua 环境 by <code>lua_open</code>， 之后的所有修改都是针对这个环境进行的。</li> <li>载入多个函数库到 Lua 环境里面， 让 Lua 脚本可以使用这些函数库来进行数据操作。 -- tbd</li> <li>创建全局表格 <code>redis</code> ， 这个表格包含了对 Redis 进行操作的函数， 比如用于在 Lua 脚本中执行 Redis 命令的 <code>redis.call</code> 函数。</li> <li>使用 Redis 自制的随机函数来替换 Lua 原有的带有副作用的随机函数， 从而避免在脚本中引入副作用。</li> <li>创建排序辅助函数， Lua 环境使用这个辅佐函数来对一部分 Redis 命令的结果进行排序， 从而消除这些命令的不确定性。</li> <li>创建 <code>redis.pcall</code> 函数的错误报告辅助函数， 这个函数可以提供更详细的出错信息。</li> <li>对 Lua 环境里面的全局环境进行保护， 防止用户在执行 Lua 脚本的过程中， 将额外的全局变量添加到了 Lua 环境里面。</li> <li>将完成修改的 Lua 环境保存到服务器状态的 <code>lua</code> 属性里面， 等待执行服务器传来的 Lua 脚本。</li></ol></li> <li><code>redis.call</code> and <code>redis.pcall</code> -- executed by <code>redisServer.lua_client</code></li> <li>SHA1
<ul><li>as key -- <code>redisServer-&gt;lua_scripts</code>, which is <code>dict</code> with SHA1 as key, function body as value</li> <li>as Lua function name -- function <code>f_&lt;SHA1&gt;()</code> is defined with the arguments of <code>EVAL</code></li></ul></li> <li>script executing -- tbd</li> <li>related commands
<ul><li><code>EVAL</code></li> <li><code>EVALSHA</code></li> <li><code>SCRIPT</code></li></ul></li></ul></li> <li><p>slow log</p> <ul><li>configurations -- <code>slowlog-log-slower-than</code>, <code>slowlog-max-len</code></li> <li>log entry id -- <code>long long</code> <code>redisServer.slowlog_entry_id</code>, +1 every time</li> <li>tbd</li> <li>related commands
<ul><li><code>SLOWLOG</code> <ul><li><code>GET</code></li></ul></li></ul></li></ul></li> <li><p><code>MONITOR</code> -- a debugging command that streams back every command processed by the Redis server</p> <ul><li><code>client.flags</code> -- <code>REDIS_MONITOR</code></li></ul></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/tangentyh/notes-of-tan/edit/master/docs/backend/redis-notes.md" target="_blank" rel="noopener noreferrer">See This Page On GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/29/2020, 5:09:01 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><div class="vuepress-eqn"></div><span class="vuepress-eq"></span></div></div>
    <script src="/notes-of-tan/assets/js/app.a889d74a.js" defer></script><script src="/notes-of-tan/assets/js/2.82b804b0.js" defer></script><script src="/notes-of-tan/assets/js/26.8a5b1dec.js" defer></script>
  </body>
</html>
