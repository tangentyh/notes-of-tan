<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis | Notes of Tan</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="https://v1.vuepress.vuejs.org/hero.png">
    <meta name="description" content="Tan's notes.">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/notes-of-tan/assets/css/0.styles.9802d8bc.css" as="style"><link rel="preload" href="/notes-of-tan/assets/js/app.a20ae0e7.js" as="script"><link rel="preload" href="/notes-of-tan/assets/js/2.33f31c9b.js" as="script"><link rel="preload" href="/notes-of-tan/assets/js/27.01533c2a.js" as="script"><link rel="prefetch" href="/notes-of-tan/assets/js/10.2f572410.js"><link rel="prefetch" href="/notes-of-tan/assets/js/11.95d04f86.js"><link rel="prefetch" href="/notes-of-tan/assets/js/12.ef1d3621.js"><link rel="prefetch" href="/notes-of-tan/assets/js/13.a4adee88.js"><link rel="prefetch" href="/notes-of-tan/assets/js/14.c09755c2.js"><link rel="prefetch" href="/notes-of-tan/assets/js/15.34e0d1b9.js"><link rel="prefetch" href="/notes-of-tan/assets/js/16.3a783d6c.js"><link rel="prefetch" href="/notes-of-tan/assets/js/17.ed547b98.js"><link rel="prefetch" href="/notes-of-tan/assets/js/18.0d515c6a.js"><link rel="prefetch" href="/notes-of-tan/assets/js/19.e33438b9.js"><link rel="prefetch" href="/notes-of-tan/assets/js/20.31497e17.js"><link rel="prefetch" href="/notes-of-tan/assets/js/21.9e8708f6.js"><link rel="prefetch" href="/notes-of-tan/assets/js/22.a23fd2c0.js"><link rel="prefetch" href="/notes-of-tan/assets/js/23.7e43ade0.js"><link rel="prefetch" href="/notes-of-tan/assets/js/24.1ec9070f.js"><link rel="prefetch" href="/notes-of-tan/assets/js/25.fb06ec42.js"><link rel="prefetch" href="/notes-of-tan/assets/js/26.50dc7d2f.js"><link rel="prefetch" href="/notes-of-tan/assets/js/28.d9dbf10c.js"><link rel="prefetch" href="/notes-of-tan/assets/js/29.9de9cb08.js"><link rel="prefetch" href="/notes-of-tan/assets/js/3.f2118d7b.js"><link rel="prefetch" href="/notes-of-tan/assets/js/30.e497781c.js"><link rel="prefetch" href="/notes-of-tan/assets/js/31.e73197b9.js"><link rel="prefetch" href="/notes-of-tan/assets/js/32.061cf937.js"><link rel="prefetch" href="/notes-of-tan/assets/js/33.40fadf29.js"><link rel="prefetch" href="/notes-of-tan/assets/js/34.1cb87aa7.js"><link rel="prefetch" href="/notes-of-tan/assets/js/35.ffb66b35.js"><link rel="prefetch" href="/notes-of-tan/assets/js/36.5b4a09a3.js"><link rel="prefetch" href="/notes-of-tan/assets/js/37.4e57a711.js"><link rel="prefetch" href="/notes-of-tan/assets/js/4.379a9a10.js"><link rel="prefetch" href="/notes-of-tan/assets/js/5.b772f594.js"><link rel="prefetch" href="/notes-of-tan/assets/js/6.8136b6d3.js"><link rel="prefetch" href="/notes-of-tan/assets/js/7.1140570f.js"><link rel="prefetch" href="/notes-of-tan/assets/js/8.bd5a1ed5.js"><link rel="prefetch" href="/notes-of-tan/assets/js/9.98e24ffb.js">
    <link rel="stylesheet" href="/notes-of-tan/assets/css/0.styles.9802d8bc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes-of-tan/" class="home-link router-link-active"><!----> <span class="site-name">Notes of Tan</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaBasics.html" class="nav-link">
  Java Basics
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaUtils.html" class="nav-link">
  Java Utilities
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaConcurrency.html" class="nav-link">
  Java Concurrency
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaIO.html" class="nav-link">
  IO
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaMisc.html" class="nav-link">
  Java Miscellanea
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/JVM.html" class="nav-link">
  Java Virtual Machine
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend" class="dropdown-title"><span class="title">Backend</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend" class="mobile-dropdown-title"><span class="title">Backend</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/SpringNotes.html" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/OS-notes.html" class="nav-link">
  OS
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/database.html" class="nav-link">
  Database
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/SQL_notes.html" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/distributed.html" class="nav-link">
  Distributed System
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/redis-notes.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Frontend" class="dropdown-title"><span class="title">Frontend</span> <span class="arrow down"></span></button> <button type="button" aria-label="Frontend" class="mobile-dropdown-title"><span class="title">Frontend</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/CSS-notes.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/html-notes.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/todo/jsNotes.html" class="nav-link">
  JS, TS
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/BOM_DOM_notes.html" class="nav-link">
  BOM, DOM, Web API
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/todo/react_notes.html" class="nav-link">
  React
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><span class="title">Other</span> <span class="arrow down"></span></button> <button type="button" aria-label="Other" class="mobile-dropdown-title"><span class="title">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/algo_notes.html" class="nav-link">
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/git_notes.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/DesignPatternNotes.html" class="nav-link">
  Design Pattern
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/HTTP.html" class="nav-link">
  HTTP
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/mac-notes.html" class="nav-link">
  MacOS
</a></li></ul></div></div> <a href="https://github.com/tangentyh/notes-of-tan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaBasics.html" class="nav-link">
  Java Basics
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaUtils.html" class="nav-link">
  Java Utilities
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaConcurrency.html" class="nav-link">
  Java Concurrency
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaIO.html" class="nav-link">
  IO
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaMisc.html" class="nav-link">
  Java Miscellanea
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/JVM.html" class="nav-link">
  Java Virtual Machine
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend" class="dropdown-title"><span class="title">Backend</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend" class="mobile-dropdown-title"><span class="title">Backend</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/SpringNotes.html" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/OS-notes.html" class="nav-link">
  OS
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/database.html" class="nav-link">
  Database
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/SQL_notes.html" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/distributed.html" class="nav-link">
  Distributed System
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/redis-notes.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Frontend" class="dropdown-title"><span class="title">Frontend</span> <span class="arrow down"></span></button> <button type="button" aria-label="Frontend" class="mobile-dropdown-title"><span class="title">Frontend</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/CSS-notes.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/html-notes.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/todo/jsNotes.html" class="nav-link">
  JS, TS
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/BOM_DOM_notes.html" class="nav-link">
  BOM, DOM, Web API
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/todo/react_notes.html" class="nav-link">
  React
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><span class="title">Other</span> <span class="arrow down"></span></button> <button type="button" aria-label="Other" class="mobile-dropdown-title"><span class="title">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/algo_notes.html" class="nav-link">
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/git_notes.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/DesignPatternNotes.html" class="nav-link">
  Design Pattern
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/HTTP.html" class="nav-link">
  HTTP
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/mac-notes.html" class="nav-link">
  MacOS
</a></li></ul></div></div> <a href="https://github.com/tangentyh/notes-of-tan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-of-tan/backend/redis-notes.html#Introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#Data-Types-And-Data-Structures" class="sidebar-link">Data Types And Data Structures</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/redis-notes.html#Data-Structures" class="sidebar-link">Data Structures</a></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/redis-notes.html#Data-Types" class="sidebar-link">Data Types</a></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/redis-notes.html#Sort" class="sidebar-link">Sort</a></li></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#Server-and-Client" class="sidebar-link">Server and Client</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#Events" class="sidebar-link">Events</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#Publish-and-Subscribe" class="sidebar-link">Publish and Subscribe</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#Persistence" class="sidebar-link">Persistence</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#Clustering" class="sidebar-link">Clustering</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/redis-notes.html#Replication" class="sidebar-link">Replication</a></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/redis-notes.html#Sentinel" class="sidebar-link">Sentinel</a></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/redis-notes.html#Redis-Cluster" class="sidebar-link">Redis Cluster</a></li></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#Transaction" class="sidebar-link">Transaction</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes-of-tan/backend/redis-notes.html#Other" class="sidebar-link">Other</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="Redis"><a href="#Redis" class="header-anchor">#</a> Redis</h1> <h2 id="Introduction"><a href="#Introduction" class="header-anchor">#</a> Introduction</h2> <ol><li><p>Redis — REmote DIctionary Server</p></li> <li><p>docs</p> <ul><li><a href="https://redis.io/documentation" target="_blank" rel="noopener noreferrer">Redis official<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/redis/redis" target="_blank" rel="noopener noreferrer">Redis GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.redislabs.com/latest/index.html" target="_blank" rel="noopener noreferrer">Redis Labs Documentation | Redis Labs Documentation Center<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://redisdoc.com/" target="_blank" rel="noopener noreferrer">Redis 命令参考 — Redis 命令参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>books
<ul><li><a href="https://redislabs.com/ebooks" target="_blank" rel="noopener noreferrer">e-Books - Redis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://redisbook.com/" target="_blank" rel="noopener noreferrer">Redis 设计与实现 — Redis 设计与实现<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://redisinaction.com/" target="_blank" rel="noopener noreferrer">Redis实战 — Redis 实战<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://redisguide.com/" target="_blank" rel="noopener noreferrer">Redis使用手册<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://learnredis.com/" target="_blank" rel="noopener noreferrer">《Redis入门与实战》 — LearnRedis.com 1.0 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></li> <li><p>online CLI — on redis.io, like <a href="https://redis.io/commands/del" target="_blank" rel="noopener noreferrer">DEL – Redis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>CLI</p> <ul><li><code>redis-server</code> <ul><li><code>redis-sentinel</code></li></ul></li> <li><code>redis-cli</code> — <a href="https://redis.io/topics/rediscli" target="_blank" rel="noopener noreferrer">tbd<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>redis-benchmark</code> — <a href="https://redis.io/topics/benchmarks" target="_blank" rel="noopener noreferrer">tbd<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>redis-trib</code></li></ul></li></ol> <h2 id="Data-Types-And-Data-Structures"><a href="#Data-Types-And-Data-Structures" class="header-anchor">#</a> Data Types And Data Structures</h2> <h3 id="Data-Structures"><a href="#Data-Structures" class="header-anchor">#</a> Data Structures</h3> <ol><li><p>string</p> <ul><li><code>c_str</code> — used in string literal, like when <code>serverLog</code></li> <li>simple dynamic string, SDS — used as keys, <code>OBJ_STRING</code>, and buffers<div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sdshdr</span> <span class="token punctuation">{</span> <span class="token comment">// old implementation</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">;</span> <span class="token comment">// 记录 buf 数组中已使用字节的数量</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> free<span class="token punctuation">;</span> <span class="token comment">// 记录 buf 数组中未使用字节的数量</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// c_str, '\0' ended, which is not counted in len</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>capacity grow policy — if <code>len</code> &lt; 1 MB, <code>free</code> = <code>len</code>; else, <code>free</code> = 1 MB</li> <li>lazy reclaim of <code>free</code> — reclaim on demand</li> <li>binary-safe — <code>len</code> as end, instead of <code>'\0'</code> as end
<ul><li><code>'\0'</code> as end — for C API reuse, partially supported</li></ul></li> <li>new version, simplified<div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// also sdshdr8, sdshdr16, sdshdr64 for uint8_t, uint16_t, uint64_t</span>
<span class="token keyword">struct</span> <span class="token class-name">sdshdr32</span> <span class="token punctuation">{</span>
    uint32_t len<span class="token punctuation">;</span> <span class="token comment">/* used, `\0` not counted */</span>
    uint32_t alloc<span class="token punctuation">;</span> <span class="token comment">/* excluding the header and null terminator */</span>
    <span class="token comment">// #define SDS_TYPE_8  1 ... #define SDS_TYPE_64 4</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment">/* 3 lsb of type, 5 unused bits */</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// c_str, '\0' ended, which is not counted in len</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>max <code>alloc</code> — 0.5 GB</li></ul></li></ul></li></ul></li> <li><p>dictionary, hash table — used in <code>OBJ_HASH</code> and database implementation, and more</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dict</span> <span class="token punctuation">{</span>
    dictType <span class="token operator">*</span>type<span class="token punctuation">;</span> <span class="token comment">// functions for a specific type</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">;</span> <span class="token comment">// parameter for functions in dictType</span>
    dictht ht<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> rehashidx<span class="token punctuation">;</span> <span class="token comment">/* rehashing not in progress if rehashidx == -1 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> iterators<span class="token punctuation">;</span> <span class="token comment">/* number of iterators currently running */</span>
<span class="token punctuation">}</span> dict<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>dictType</code> — <code>setDictType</code>, <code>zsetDictType</code>, <code>dbDictType</code>, etc. predefined in <code>server.c</code><div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictType</span> <span class="token punctuation">{</span>
    <span class="token function">uint64_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>hashFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>keyDup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>valDup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>keyCompare<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>keyDestructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>valDestructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> dictType<span class="token punctuation">;</span>
</code></pre></div></li> <li><code>dictht</code> — dictionary hash table<div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictht</span> <span class="token punctuation">{</span>
    dictEntry <span class="token operator">*</span><span class="token operator">*</span>table<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span> <span class="token comment">// capacity</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sizemask<span class="token punctuation">;</span> <span class="token comment">// size - 1</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> used<span class="token punctuation">;</span>
<span class="token punctuation">}</span> dictht<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>dictEntry</code> — key-value pair<div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictEntry</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>
        uint64_t u64<span class="token punctuation">;</span>
        int64_t s64<span class="token punctuation">;</span>
        <span class="token keyword">double</span> d<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> v<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">dictEntry</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span> dictEntry<span class="token punctuation">;</span>
</code></pre></div></li> <li>hash value — <code>hashFunction(key) &amp; sizemask</code></li> <li>hash collision — chaining with <code>*next</code>, new nodes added at head</li></ul></li> <li>rehash
<ul><li>expand — when not executing <code>BGSAVE</code> or <code>BGREWRITEAOF</code> and load factor &gt;= 1, or when executing either one and load factor &gt;= 5; expand to the size of the first 2^n that &gt;= <code>ht[0].used * 2</code></li> <li>shrink — when load factor &lt; 0.1; shrink to the size of the first 2^n that &gt;= <code>ht[0].used</code></li> <li>progressive rehash — set <code>rehashidx</code> to 0, and increment by 1 for every CRUD operation, reset to -1 when completed and swap <code>ht[0]</code> and <code>ht[1]</code></li></ul></li></ul></li> <li><p>skiplist — used in <code>OBJ_ZSET</code></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">zskiplist</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token operator">*</span>header<span class="token punctuation">,</span> <span class="token operator">*</span>tail<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> level<span class="token punctuation">;</span>
<span class="token punctuation">}</span> zskiplist<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>zskiplistNode</code><div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token punctuation">{</span>
    sds ele<span class="token punctuation">;</span>
    <span class="token keyword">double</span> score<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token operator">*</span>backward<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">zskiplistLevel</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token operator">*</span>forward<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> span<span class="token punctuation">;</span> <span class="token comment">// rank starting from 1</span>
    <span class="token punctuation">}</span> level<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> zskiplistNode<span class="token punctuation">;</span>
</code></pre></div><ul><li>level — height generated between 1 to 32 according to power law</li> <li>score — for sort, ascending, sort by <code>ele</code> lexicographically when equality</li></ul></li></ul></li> <li><p>int set — encoding-adapting ordered distinct array, used in <code>OBJ_SET</code> if the cardinality is low</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">intset</span> <span class="token punctuation">{</span>
    uint32_t encoding<span class="token punctuation">;</span>
    uint32_t length<span class="token punctuation">;</span>
    int8_t contents<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// ordered</span>
<span class="token punctuation">}</span> intset<span class="token punctuation">;</span>
</code></pre></div><ul><li>add element — O(N)
<ul><li>space saving — <code>contents</code> is of the smallest encoding possible, upgrade and reallocate if necessary</li> <li>upgrade — if one encoding not enough, upgrade encoding of <code>contents</code> from <code>INTSET_ENC_INT16</code> to <code>INTSET_ENC_INT32</code> to <code>INTSET_ENC_INT64</code>, new element added at head or tail</li></ul></li></ul></li> <li><p>list — doubly linked list, used internally such as struct fields</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span> listNode<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">list</span> <span class="token punctuation">{</span>
    listNode <span class="token operator">*</span>head<span class="token punctuation">;</span>
    listNode <span class="token operator">*</span>tail<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>dup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// duplication</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>free<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>match<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// comparison</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">;</span>
<span class="token punctuation">}</span> list<span class="token punctuation">;</span>
</code></pre></div></li> <li><p>ziplist — a sequential data structure that is continuous on memory (<code>unsigned char</code> array), used in <code>OBJ_LIST</code> and <code>OBJ_HASH</code></p> <div class="language- extra-class"><pre class="language-text"><code>zlbytes zltail zllen [entries] zlend
 4b       4b    2b              0xFF
</code></pre></div><ul><li><code>zlbytes</code> — total size</li> <li><code>zltail</code> — offset between the start of the ziplist and the start of the last entry</li> <li><code>zllen</code> — total entry count, can only hold within <code>UINT16_MAX</code></li> <li><code>zlend</code> — end mark</li> <li>entry — a byte array or a number<div class="language- extra-class"><pre class="language-text"><code>previous_entry_length encoding content
</code></pre></div><ul><li><code>previous_entry_length</code> — 1 byte when &lt; <code>0xFE</code> otherwise 5 byte starting with <code>0xFE</code>, for iterating</li> <li><code>encoding</code> — type and length of <code>content</code></li> <li>operations like push an entry — O(N), the possibility of long cascade update is low, which needs consecutive entries of length between 250 to 253b
<ul><li>cascade update — <code>previous_entry_length</code> of an entry updates from 1b to 5b, triggering the <code>previous_entry_length</code> update of the next entry, O(N^2) in the worst case</li></ul></li></ul></li></ul></li> <li><p>quicklist — doubly linked list of ziplists, used in <code>OBJ_LIST</code>, tbd</p></li> <li><p>listpack — <code>unsigned char</code> array like ziplist, designed to replace ziplist, currently only used in <code>OBJ_STREAM</code>, tbd</p></li> <li><p>radix tree — used in <code>OBJ_STREAM</code> and more, tbd</p></li> <li><p>zipmap — String -&gt; String Map data structure optimized for size</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;zmlen&gt;&lt;len&gt;&quot;foo&quot;&lt;len&gt;&lt;free&gt;&quot;bar&quot;&lt;len&gt;&quot;hello&quot;&lt;len&gt;&lt;free&gt;&quot;world&quot;
</code></pre></div></li></ol> <h3 id="Data-Types"><a href="#Data-Types" class="header-anchor">#</a> Data Types</h3> <ol><li><p>object — wrapper for data structures, with timestamp, with reference count for object sharing and GC</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">LRU_BITS <span class="token number">24</span></span></span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisObject</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> type<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> encoding<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> lru<span class="token operator">:</span>LRU_BITS<span class="token punctuation">;</span> <span class="token comment">/* LRU time (relative to global lru_clock) or
                            * LFU data (least significant 8 bits frequency
                            * and most significant 16 bits access time). */</span>
    <span class="token keyword">int</span> refcount<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span> robj<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>type</code> — <code>OBJ_STRING</code>, <code>OBJ_LIST</code>, <code>OBJ_SET</code>, <code>OBJ_ZSET</code>, <code>OBJ_HASH</code>, <code>OBJ_MODULE</code>, <code>OBJ_STREAM</code></li> <li><code>encoding</code><div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">OBJ_ENCODING_RAW <span class="token number">0</span>     </span><span class="token comment">/* Raw representation */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">OBJ_ENCODING_INT <span class="token number">1</span>     </span><span class="token comment">/* Encoded as integer */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">OBJ_ENCODING_HT <span class="token number">2</span>      </span><span class="token comment">/* Encoded as hash table */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">OBJ_ENCODING_ZIPMAP <span class="token number">3</span>  </span><span class="token comment">/* Encoded as zipmap */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">OBJ_ENCODING_LINKEDLIST <span class="token number">4</span> </span><span class="token comment">/* No longer used: old list encoding. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">OBJ_ENCODING_ZIPLIST <span class="token number">5</span> </span><span class="token comment">/* Encoded as ziplist */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">OBJ_ENCODING_INTSET <span class="token number">6</span>  </span><span class="token comment">/* Encoded as intset */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">OBJ_ENCODING_SKIPLIST <span class="token number">7</span>  </span><span class="token comment">/* Encoded as skiplist */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">OBJ_ENCODING_EMBSTR <span class="token number">8</span>  </span><span class="token comment">/* Embedded sds string encoding */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">OBJ_ENCODING_QUICKLIST <span class="token number">9</span> </span><span class="token comment">/* Encoded as linked list of ziplists */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">OBJ_ENCODING_STREAM <span class="token number">10</span> </span><span class="token comment">/* Encoded as a radix tree of listpacks */</span></span>
</code></pre></div></li> <li>polymorphism — the same command works for different types and/or encodings</li> <li>GC — reference counting</li> <li><code>lru</code> — last accessed timestamp, see <a href="#Other">Other</a></li> <li>flyweight — for integers from 0 to 9999</li> <li>empty collections — when add like <code>LPUSH</code>, an empty collection is prepared; empty collections will be garbage collected, except stream; read commands like <code>LLEN</code> and some write commands on an empty key behave like an empty collection held on the key</li> <li>related commands
<ul><li><code>OBJECT subcommand [arguments [arguments ...]]</code> — see <code>OBJECT HELP</code> <ul><li><code>OBJECT ENCODING</code></li> <li><code>OBJECT REFCOUNT</code></li> <li><code>OBJECT IDLETIME</code></li> <li><code>OBJECT FREQ</code> — available when <code>maxmemory-policy</code> is set to an LFU policy</li> <li><code>DEBUG OBJECT</code></li></ul></li> <li><code>TYPE</code></li> <li>see <a href="#Server-and-Client"><code>redisDb</code></a></li></ul></li></ul></li> <li><p><code>OBJ_STRING</code></p> <ul><li>corresponding <code>encoding</code> <ul><li><code>OBJ_ENCODING_INT</code> — <code>long long</code>, for numbers within range</li> <li><code>OBJ_ENCODING_EMBSTR</code> — an object where the sds string is actually an unmodifiable string allocated in the same chunk as the object itself, used when string length &lt;= 44 bytes (<code>OBJ_ENCODING_EMBSTR_SIZE_LIMIT</code>) and when <code>long double</code></li> <li><code>OBJ_ENCODING_RAW</code> — SDS, used when string length &gt; 44 bytes</li></ul></li> <li>related commands
<ul><li>plain set and get
<ul><li><code>SET key value [EX seconds|PX milliseconds|KEEPTTL] [NX|XX] [GET]</code> <ul><li><code>GETSET</code></li> <li><code>SETEX</code>, <code>PSETEX</code></li> <li><code>SETNX</code></li></ul></li> <li><code>MSET</code> <ul><li><code>MSETNX</code> — no operation even if just one single key already exists</li></ul></li> <li><code>GET</code>, <code>MGET</code></li></ul></li> <li><code>APPEND</code> — amortized O(1)</li> <li><code>INCRBY</code>, <code>DECRBY</code>, <code>INCR</code>, <code>DECR</code> — only for signed 64 bit, start with 0 if key does not exist
<ul><li><code>INCRBYFLOAT</code> — output precision fixed to 17 digits</li></ul></li> <li><code>SETRANGE</code>, <code>GETRANGE</code> — zero byte padded</li> <li><code>BITFIELD</code> — capable of addressing specific integer fields of varying bit widths and arbitrary non (necessary) aligned offset</li> <li><code>STRLEN</code></li> <li><code>STRALGO LCS</code></li></ul></li></ul></li> <li><p>data structure with <code>redisObject.type</code> of <code>OBJ_STRING</code></p> <ul><li>bitmap
<ul><li>implementation — like <code>java.util.BitSet</code>, but one byte (<code>char</code>) each word</li> <li>related commands
<ul><li><code>SETBIT</code></li> <li><code>GETBIT</code></li> <li><code>BITCOUNT</code></li> <li><code>BITOP</code> — <code>AND</code>, <code>OR</code>, <code>XOR</code> and <code>NOT</code></li> <li><code>BITPOS</code> — return the position of the first bit set to 1 or 0 in a string</li></ul></li></ul></li> <li>HyperLogLog — probabilistic, count unique elements like a set, memory footprint of 12KB in worst case, standard error of 0.81%
<ul><li>implementation — <a href="https://en.wikipedia.org/wiki/HyperLogLog" target="_blank" rel="noopener noreferrer">HyperLogLog - Wikipedia<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/redis/redis/blob/c1aaad06d85c89ab7abebd5cefab026bdcb086ab/src/hyperloglog.c#L37-L180" target="_blank" rel="noopener noreferrer"><code>hyperloglog.c</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://redis.io/commands/pfcount#hyperloglog-representation" target="_blank" rel="noopener noreferrer">redis.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>sparse representation</li> <li>dense representation</li> <li><code>PFCOUNT</code> cache — last 8 bytes encode the latest computed cardinality for caching purposes</li></ul></li> <li>related commands
<ul><li><code>PFADD</code></li> <li><code>PFCOUNT</code> — slow if merge</li> <li><code>PFMERGE</code></li></ul></li></ul></li></ul></li> <li><p><code>OBJ_LIST</code></p> <ul><li>corresponding <code>encoding</code> <ul><li><code>OBJ_ENCODING_ZIPLIST</code> — when each element size &lt; 64 bytes and list size &lt; 512, <code>list-max-ziplist-value</code> and <code>list-max-ziplist-entries</code> in configurations</li> <li><code>OBJ_ENCODING_QUICKLIST</code> — <code>list-max-ziplist-size</code>, <code>list-compress-depth</code> in configurations</li></ul></li> <li>related commands
<ul><li><code>LPUSH</code>, <code>RPUSH</code> <ul><li><code>LPUSHX</code>, <code>RPUSHX</code> — no operation if key does not exist</li></ul></li> <li><code>LPOP</code>, <code>RPOP</code> — <code>null</code> when empty
<ul><li><code>BRPOP</code>, <code>BLPOP</code> — block with timeout (infinitely if <code>0</code>) when all keys are empty, first come first serve for clients</li></ul></li> <li><code>LSET</code></li> <li>get
<ul><li><code>LINDEX</code> — get by index</li> <li><code>LRANGE</code> — inclusive, support <code>-1</code></li></ul></li> <li><code>LLEN</code></li> <li>find
<ul><li><code>LINSERT</code> — find and insert</li> <li><code>LPOS</code> — find</li> <li><code>LREM</code></li></ul></li> <li><code>LTRIM key start stop</code></li> <li><code>LMOVE source destination LEFT|RIGHT LEFT|RIGHT</code> — since 6.2.0, can be used for reliable queue and circular list
<ul><li><code>BLMOVE</code></li> <li><code>RPOPLPUSH</code>, <code>BRPOPLPUSH</code></li></ul></li></ul></li></ul></li> <li><p><code>OBJ_HASH</code></p> <ul><li>corresponding <code>encoding</code> <ul><li><code>OBJ_ENCODING_ZIPLIST</code> — when all keys and values &lt; 64 bytes, and list size &lt; 512, <code>hash-max-ziplist-value</code> and <code>hash-max-ziplist-entries</code> in configurations
<ul><li>difference with top level keystore — use more small hashes with fields in lieu of keys to save memory, but no functions like <code>EXPIRE</code> for fields</li></ul></li> <li><code>OBJ_ENCODING_HT</code></li></ul></li> <li>related commands
<ul><li><code>HSET</code>, <code>HSETNX</code> <ul><li><code>HMSET</code>, deprecated</li></ul></li> <li><code>HGET</code>, <code>HMGET</code>, <code>HGETALL</code></li> <li><code>HEXISTS</code></li> <li><code>HDEL</code></li> <li><code>HLEN</code></li> <li><code>HINCRBY</code>, <code>HINCRBYFLOAT</code></li> <li><code>HSTRLEN</code></li> <li><code>HKEYS</code>, <code>HVALS</code></li> <li><code>HSCAN</code></li></ul></li></ul></li> <li><p><code>OBJ_SET</code></p> <ul><li>corresponding <code>encoding</code> <ul><li><code>OBJ_ENCODING_INTSET</code> — when only integer elements and cardinality &lt; 512, <code>set-max-intset-entries</code> in configurations</li> <li><code>OBJ_ENCODING_HT</code> — <code>setDictType</code>, <code>null</code> as value</li></ul></li> <li>related commands
<ul><li><code>SADD</code></li> <li><code>SCARD</code></li> <li>between sets
<ul><li><code>SDIFF key [key ...]</code>, <code>SDIFFSTORE destination key [key ...]</code></li> <li><code>SINTER key [key ...]</code>, <code>SINTERSTORE</code></li> <li><code>SUNION</code>, <code>SUNIONSTORE</code></li> <li><code>SMOVE</code></li></ul></li> <li><code>SISMEMBER</code>, <code>SMISMEMBER</code></li> <li><code>SMEMBERS</code></li> <li><code>SPOP</code> — Knuth sampling and Floyd sampling, not uniform distribution</li> <li><code>SRANDMEMBER</code> — bucket based: an element alone in a bucket is much more likely to be returned than an element in a bucket with chained elements</li> <li><code>SREM</code></li> <li><code>SSCAN</code></li></ul></li></ul></li> <li><p><code>OBJ_ZSET</code> — ordered set, sort by <code>memcmp()</code> if score is the same</p> <ul><li>corresponding <code>encoding</code> <ul><li><code>OBJ_ENCODING_ZIPLIST</code> — when cardinality &lt; 128 and all elements &lt; 64 bytes, <code>zset-max-ziplist-entries</code> and <code>zset-max-ziplist-value</code> in configurations</li> <li><code>OBJ_ENCODING_SKIPLIST</code> — use <code>zset</code>: like <code>java.util.LinkedHashMap</code> but with skiplist in lieu of linked list<div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">zset</span> <span class="token punctuation">{</span>
    zskiplist <span class="token operator">*</span>zsl<span class="token punctuation">;</span>
    dict <span class="token operator">*</span>dict<span class="token punctuation">;</span> <span class="token comment">// member to score</span>
<span class="token punctuation">}</span> zset<span class="token punctuation">;</span>
</code></pre></div></li></ul></li> <li>use
<ul><li>graph query — <a href="https://redis.io/topics/indexes#representing-and-querying-graphs-using-an-hexastore" target="_blank" rel="noopener noreferrer">Hexastore<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://redis.io/topics/indexes#multi-dimensional-indexes" target="_blank" rel="noopener noreferrer">multi dimensional index<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li> <li>related commands
<ul><li><code>ZADD key [NX|XX] [GT|LT] [CH] [INCR] score member [score member ...]</code></li> <li>count
<ul><li><code>ZCARD</code> — cardinality</li> <li><code>ZCOUNT key min max</code></li> <li><code>ZLEXCOUNT key min max</code></li></ul></li> <li><code>ZSCORE</code>, <code>ZMSCORE</code> — get score</li> <li>get members by range
<ul><li><code>ZRANGE key start stop [WITHSCORES]</code>, <code>ZREVRANGE</code> — get members by index, inclusive ranges, can be <code>-1</code></li> <li><code>ZRANGEBYLEX</code>, <code>ZREVRANGEBYLEX</code> — <code>(</code>, <code>[</code> prefixed ranges, or <code>+</code> and <code>-</code></li> <li><code>ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]</code>, <code>ZREVRANGEBYSCORE</code> — inclusive ranges, <code>(</code> for exclusive, can be <code>-inf</code>, <code>+inf</code>, can be used for weighted random selection of an element</li></ul></li> <li><code>ZRANK</code>, <code>ZREVRANK</code></li> <li>remove
<ul><li><code>ZREM</code></li> <li><code>ZREMRANGEBYLEX</code></li> <li><code>ZREMRANGEBYRANK</code></li> <li><code>ZREMRANGEBYSCORE</code></li></ul></li> <li>intersection, union
<ul><li><code>ZINTER</code>, <code>ZINTERSTORE</code></li> <li><code>ZUNION</code>, <code>ZUNIONSTORE</code></li></ul></li> <li><code>ZINCRBY key increment member</code></li> <li><code>ZPOPMAX key [count]</code>, <code>ZPOPMIN</code> — a <code>count</code> value that is higher than the sorted set's cardinality will not produce an error
<ul><li><code>BZPOPMAX</code>, <code>BZPOPMIN</code></li></ul></li> <li><code>ZSCAN</code></li> <li>lexicographically — <code>ZRANGEBYLEX</code>, <code>ZREVRANGEBYLEX</code>, <code>ZREMRANGEBYLEX</code> and <code>ZLEXCOUNT</code> <ul><li>if different score — if the elements in the sorted set have different scores, the returned elements are unspecified</li></ul></li></ul></li></ul></li> <li><p>Geo related — of type <code>OBJ_ZSET</code></p> <ul><li><a href="https://en.wikipedia.org/wiki/Geohash" target="_blank" rel="noopener noreferrer">Geohash - Wikipedia<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> — latitude and longitude bits are interleaved in order to form an unique 52 bit integer, which does not lose precision when converted to <code>double</code></li> <li>limitation — areas very near to the poles are not indexable; radiuses are approximated by perfect sphere model</li> <li>related commands
<ul><li><code>GEOADD key longitude latitude member [longitude latitude member ...]</code></li> <li><code>GEODIST</code></li> <li><code>GEOHASH</code> — standard Geohash instead of the Redis internal one</li> <li><code>GEOPOS</code> — return the positions (longitude,latitude)</li> <li><code>GEORADIUS</code> — get members within a specified circle</li> <li><code>GEORADIUSBYMEMBER</code> — like <code>GEORADIUS</code> but the center of the circle is the specified member</li> <li>delete — <code>ZREM</code></li></ul></li></ul></li> <li><p><code>OBJ_STREAM</code> — log data structure, append only, allow consumers block waiting and has consumer groups, since 5.0</p> <ul><li>corresponding <code>encoding</code> - <code>OBJ_ENCODING_STREAM</code>, radix tree of listpacks<div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">stream</span> <span class="token punctuation">{</span>
    rax <span class="token operator">*</span>rax<span class="token punctuation">;</span>               <span class="token comment">/* The radix tree holding the stream. */</span>
    uint64_t length<span class="token punctuation">;</span>        <span class="token comment">/* Number of elements inside this stream. */</span>
    streamID last_id<span class="token punctuation">;</span>       <span class="token comment">/* Zero if there are yet no items. */</span>
    rax <span class="token operator">*</span>cgroups<span class="token punctuation">;</span>           <span class="token comment">/* Consumer groups dictionary: name -&gt; streamCG */</span>
<span class="token punctuation">}</span> stream<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>streamID</code> — <code>&lt;millisecondsTime&gt;-&lt;64b-sequenceNumber&gt;</code>, monotonically incrementing, usually auto generated by passing <code>*</code><div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* Stream item ID: a 128 bit number composed of a milliseconds time and
 * a sequence counter. IDs generated in the same millisecond (or in a past
 * millisecond if the clock jumped backward) will use the millisecond time
 * of the latest generated ID and an incremented sequence. */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">streamID</span> <span class="token punctuation">{</span>
    uint64_t ms<span class="token punctuation">;</span>        <span class="token comment">/* Unix time in milliseconds. */</span>
    uint64_t seq<span class="token punctuation">;</span>       <span class="token comment">/* Sequence number. */</span>
<span class="token punctuation">}</span> streamID<span class="token punctuation">;</span>
</code></pre></div><ul><li>special forms in some commands — <code>*</code>, <code>+</code>, <code>-</code>, <code>$</code>, <code>&gt;</code>, see below</li></ul></li></ul></li> <li>use
<ul><li>fan out messages to multiple clients — multiple consumers see the new messages appended to the stream (the same way many <code>tail -f</code> processes can see what is added to a log)</li> <li>time series store — get messages by ranges of time, or alternatively to iterate the messages using a cursor to incrementally check all the history; consumers will know what is a new message by remembering last <code>streamID</code></li> <li>consumer groups, like in Kafka but logical partitions — a stream of messages that can be partitioned to multiple consumers, possible to scale the message processing across different consumers; explicit acknowledgment of processed items, ability to inspect the pending items, claiming of unprocessed messages, and coherent history visibility for each single client
<ul><li>latency — minimal, before returning to the event loop both the client calling <code>XADD</code> and the clients blocked to consume messages, will have their reply in the output buffers</li></ul></li></ul></li> <li>consumer group — like a pseudo consumer that gets data from a stream, and actually serves multiple consumers; within a consumer group:<div class="language- extra-class"><pre class="language-text"><code>+----------------------------------------+
| consumer_group_name: mygroup           |
| consumer_group_stream: somekey         |
| last_delivered_id: 1292309234234-92    |
|                                        |
| consumers:                             |
|    &quot;consumer-1&quot; with pending messages  |
|       1292309234234-4                  |
|       1292309234232-8                  |
|    &quot;consumer-42&quot; with pending messages |
|       ... (and so forth)               |
+----------------------------------------+
</code></pre></div><ul><li>stable consumer name — consumers identified by case-sensitive names, which stay unchanged even after reconnection</li> <li>cursor — each consumer group has the concept of the first ID never consumed</li> <li>explicit consumer ACK — consuming a message requires an explicit acknowledgment using <code>XACK</code>, then Redis can evict ACKed message from the consumer group</li> <li>pending tracked — a consumer group tracks all the messages that are currently pending, i.e. delivered but not yet ACKed messages</li> <li>one message one customer</li></ul></li> <li>observability — see <code>XINFO</code>, get info like who is consuming messages, what messages are pending, the set of consumer groups active in a given stream
<ul><li>dead letter — when delivery count is abnormally height, it is probably wiser to put such messages in another stream and send a notification to the system administrator</li></ul></li> <li>zero-length streams — zero-length stream keys are not deleted in contrast to keys of other collections, to preserve the state of customer groups</li> <li>related commands
<ul><li><code>XADD key ID field value [field value ...]</code> <ul><li><code>MAXLEN</code> option — capped stream, with <code>~</code> for approximated cap but more efficient</li></ul></li> <li><code>XTRIM key MAXLEN [~] count</code></li> <li><code>XDEL</code> — mark delete</li> <li><code>XLEN</code></li> <li><code>XRANGE key start end [COUNT count]</code>, <code>XREVRANGE</code> <ul><li>special <code>streamID</code> — <code>-</code>, <code>+</code></li> <li>iterate — streamID which is <code>streamID.seq + 1</code> from previous returned <code>streamID</code> as <code>start</code>, and <code>+</code> as <code>end</code>, with <code>COUNT</code> limit</li></ul></li> <li><code>XREAD [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] id [id ...]</code> <ul><li><code>$</code> as <code>id</code> — the maximum ID already stored in the stream</li> <li><code>BLOCK</code> — block until any listened <code>key</code> has new data, and blocking clients are FIFO</li></ul></li> <li><code>XINFO STREAM</code>, <code>XINFO HELP</code></li> <li>consumer group
<ul><li><code>XREADGROUP</code> — <code>XREAD</code> consumer group version, not a readonly command due to side effects<div class="language- extra-class"><pre class="language-text"><code>XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]
</code></pre></div><ul><li>special <code>ID</code> <code>&gt;</code> — messages never delivered to other consumers so far</li> <li>other valid <code>ID</code> — return pending messages</li></ul></li> <li><code>XGROUP</code> — create, destroy and manage consumer groups
<ul><li>consumer auto creation — consumers are auto-created the first time they are mentioned, no need for explicit creation</li></ul></li> <li><code>XACK</code></li> <li><code>XPENDING</code> — inspect the list of pending messages, specify range to see idle time and delivery count</li> <li><code>XCLAIM</code> — changes the ownership of a pending message to the specified customer, claiming a message will reset its idle time, also increment its delivery count if not <code>JUSTID</code>; can be used in case of permanent consumer failure</li> <li><code>XINFO</code> — see <code>XINFO HELP</code> <ul><li><code>XINFO CONSUMERS key groupname</code></li> <li><code>XINFO GROUPS key</code></li></ul></li></ul></li></ul></li></ul></li></ol> <h3 id="Sort"><a href="#Sort" class="header-anchor">#</a> Sort</h3> <ol><li>sort<div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_redisSortObject</span> <span class="token punctuation">{</span>
    robj <span class="token operator">*</span>obj<span class="token punctuation">;</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> score<span class="token punctuation">;</span>
        robj <span class="token operator">*</span>cmpobj<span class="token punctuation">;</span> <span class="token comment">// for BY ALPHA</span>
    <span class="token punctuation">}</span> u<span class="token punctuation">;</span>
<span class="token punctuation">}</span> redisSortObject<span class="token punctuation">;</span>
</code></pre></div><ul><li>steps
<ol><li>create an array of <code>redisSortObject</code></li> <li>populate <code>redisSortObject-&gt;obj</code></li> <li>populate scores, skipped when <code>ALPHA</code>, according to the pattern when <code>BY</code>;otherwise populate <code>cmpobj</code> if <code>BY</code> with <code>ALPHA</code></li> <li>sort, by quicksort</li> <li>return to the client</li></ol></li> <li>compare by<div class="language- extra-class"><pre class="language-text"><code>redis&gt; SADD fruits &quot;apple&quot; &quot;banana&quot; &quot;cherry&quot;
redis&gt; MSET apple-price 8 banana-price 5.5 cherry-price 7
redis&gt; SORT fruits BY *-price
</code></pre></div></li> <li>related commands
<ul><li><code>SORT</code><div class="language- extra-class"><pre class="language-text"><code>SORT key [BY pattern] [LIMIT offset count] [GET pattern [GET pattern ...]] [ASC|DESC] [ALPHA] [STORE destination]
</code></pre></div><ul><li><code>ALPHA</code> — lexicographically</li> <li><code>ASC</code>, <code>DESC</code></li> <li><code>BY</code></li> <li><code>LIMIT</code></li> <li><code>GET</code> — get pattern</li> <li><code>STORE</code></li></ul></li></ul></li></ul></li></ol> <h2 id="Server-and-Client"><a href="#Server-and-Client" class="header-anchor">#</a> Server and Client</h2> <ol><li><p>server</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span> <span class="token comment">// db array</span>
  <span class="token keyword">int</span> dbnum<span class="token punctuation">;</span>                      <span class="token comment">/* Total number of configured DBs */</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// part of stats</span>
  <span class="token keyword">long</span> <span class="token keyword">long</span> stat_keyspace_hits<span class="token punctuation">;</span>   <span class="token comment">/* Number of successful lookups of keys */</span>
  <span class="token keyword">long</span> <span class="token keyword">long</span> stat_keyspace_misses<span class="token punctuation">;</span> <span class="token comment">/* Number of failed lookups of keys */</span>
  <span class="token comment">// ...</span>
  <span class="token comment">/* RDB persistence */</span>
  <span class="token keyword">long</span> <span class="token keyword">long</span> dirty<span class="token punctuation">;</span>                <span class="token comment">/* Changes to DB from the last save */</span>
  <span class="token keyword">long</span> <span class="token keyword">long</span> dirty_before_bgsave<span class="token punctuation">;</span>  <span class="token comment">/* Used to restore dirty on failed BGSAVE */</span>
  <span class="token comment">// ...</span>
  <span class="token comment">/* Networking */</span>
  list <span class="token operator">*</span>clients<span class="token punctuation">;</span>              <span class="token comment">/* List of active clients */</span>
  list <span class="token operator">*</span>clients_to_close<span class="token punctuation">;</span>     <span class="token comment">/* Clients to close asynchronously */</span>
  list <span class="token operator">*</span>clients_pending_write<span class="token punctuation">;</span> <span class="token comment">/* There is to write or install handler. */</span>
  list <span class="token operator">*</span>clients_pending_read<span class="token punctuation">;</span>  <span class="token comment">/* Client has pending read socket buffers. */</span>
  <span class="token comment">// ...</span>
  <span class="token comment">/* Scripting */</span>
  lua_State <span class="token operator">*</span>lua<span class="token punctuation">;</span> <span class="token comment">/* The Lua interpreter. We use just one for all clients */</span>
  client <span class="token operator">*</span>lua_client<span class="token punctuation">;</span>   <span class="token comment">/* The &quot;fake client&quot; to query Redis from Lua */</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>dbnum</code> — defaults to 16, <code>database</code> in configurations</li> <li>maintainence when reading or writing a keyspace
<ul><li>maintain statistics, like <code>stat_keyspace_hits</code>, <code>stat_keyspace_misses</code></li> <li>update <code>redisObject.lru</code></li> <li>delete a key if expired</li> <li>mark <code>WATCH</code>ed keys dirty</li> <li>increment <code>dirty</code> counters</li> <li>dispatch notifications</li></ul></li> <li>related commands
<ul><li><code>INFO [section]</code> <ul><li><code>INFO server</code>, <code>INFO clients</code></li> <li><code>INFO stats</code></li> <li>more</li> <li><code>CONFIG RESETSTAT</code></li> <li><code>DBSIZE</code></li></ul></li> <li><code>SHUTDOWN [NOSAVE|SAVE]</code></li> <li><code>DEBUG SEGFAULT</code></li> <li><code>TIME</code></li> <li><code>SWAPDB index1 index2</code> — swap db index</li> <li><code>MOVE key db</code> — between <code>redisServer.db</code></li> <li><code>FLUSHALL</code></li></ul></li></ul></li> <li><p><code>redisDb</code></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* Redis database representation. There are multiple databases identified
 * by integers from 0 (the default database) up to the max configured
 * database. The database number is the 'id' field in the structure. */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisDb</span> <span class="token punctuation">{</span>
    dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>                 <span class="token comment">/* The keyspace for this DB */</span>
    dict <span class="token operator">*</span>expires<span class="token punctuation">;</span>              <span class="token comment">/* Timeout of keys with a timeout set */</span>
    dict <span class="token operator">*</span>blocking_keys<span class="token punctuation">;</span>        <span class="token comment">/* Keys with clients waiting for data (BLPOP)*/</span>
    dict <span class="token operator">*</span>ready_keys<span class="token punctuation">;</span>           <span class="token comment">/* Blocked keys that received a PUSH */</span>
    dict <span class="token operator">*</span>watched_keys<span class="token punctuation">;</span>         <span class="token comment">/* WATCHED keys for MULTI/EXEC CAS */</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>                     <span class="token comment">/* Database ID */</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> avg_ttl<span class="token punctuation">;</span>          <span class="token comment">/* Average TTL, just for stats */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> expires_cursor<span class="token punctuation">;</span> <span class="token comment">/* Cursor of the active expire cycle. */</span>
    list <span class="token operator">*</span>defrag_later<span class="token punctuation">;</span>         <span class="token comment">/* List of key names to attempt to defrag one by one, gradually. */</span>
<span class="token punctuation">}</span> redisDb<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>expires</code> — a dict where keys are pointers to keys in keyspace, values are <code>long long</code> UNIX timestamps
<ul><li>expungement strategy
<ul><li>lazy — expunge when reading the key</li> <li>periodic — expunge in some frequency with a time limit, continue from the last expunged <code>redisDb</code>, cycling <code>redisServer.db</code> array: examine and expunge 20 keys randomly selected from <code>redisDb-&gt;expires</code> until no more than 25% of selected 20 keys expunged</li></ul></li> <li>key expiration in replicas — key expungement of followers is controlled by the master, who sends <code>DEL</code> commands to followers</li> <li>persistence related
<ul><li>RDB
<ul><li>when <code>SAVE</code> or <code>BGSAVE</code> — expired keys filtered</li> <li>when loading data — master will filter expired keys, followers will not (cleared when syncing with master)</li></ul></li> <li>AOF
<ul><li>when writing to AOF — when expunged, a <code>DEL</code> is explicitly appended</li> <li>when rewriting AOF — expired keys filtered</li></ul></li></ul></li> <li>related commands — <code>PEXPIREAT</code> under the hood
<ul><li><code>EXPIRE</code>, <code>PEXPIRE</code>, <code>SET</code> — TTL, in s or ms, untouched by altering commands like <code>INCR</code>, <code>LPUSH</code>, <code>HSET</code>, <code>RENAME</code>, overwritten for other write commands</li> <li><code>EXPIREAT</code>, <code>PEXPIREAT</code> — UNIX timestamp, in s or ms</li> <li><code>TTL</code>, <code>PTTL</code> — remaining time to live, in s or ms</li> <li><code>PERSIST</code> — remove expiration</li></ul></li></ul></li> <li>related commands
<ul><li><code>DEL</code> <ul><li><code>UNLINK</code> — GC left to do, asynchronously in another thread</li></ul></li> <li><code>DUMP</code>, <code>RESTORE</code> — serialize and deserialize, format is opaque and non-standard, with checksum and values are encoded in the same format used by RDB with RDB version
<ul><li><code>MIGRATE</code> — see <a href="#Clustering">Clustering</a></li></ul></li> <li><code>KEYS pattern</code> — support more glob pattern</li> <li><code>EXISTS key [key ...]</code>, <code>TOUCH key [key ...]</code></li> <li><code>FLUSHDB</code> — delete all the keys</li> <li><code>RANDOMKEY</code></li> <li><code>DBSIZE</code></li> <li><code>RENAME</code>, <code>RENAMENX</code></li> <li><code>SCAN</code> — incrementally iterate over a collection of elements</li></ul></li></ul></li> <li><p><code>redisCommand</code></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisCommand</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    redisCommandProc <span class="token operator">*</span>proc<span class="token punctuation">;</span>
    <span class="token keyword">int</span> arity<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>sflags<span class="token punctuation">;</span>   <span class="token comment">/* Flags as string representation, one char per flag. */</span>
    uint64_t flags<span class="token punctuation">;</span> <span class="token comment">/* The actual flags, obtained from the 'sflags' field. */</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> microseconds<span class="token punctuation">,</span> calls<span class="token punctuation">;</span> <span class="token comment">// statistics</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><code>name</code> — <code>client-&gt;argv[0]</code></li> <li><code>proc</code> — callback, called as <code>client-&gt;cmd-&gt;proc(client)</code></li> <li><code>sflags</code> — see <a href="https://redis.io/commands/command#flags" target="_blank" rel="noopener noreferrer">redis.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and <a href="https://github.com/redis/redis/blob/25f457c7f69e7f0254cc5d585eadd784dd30d91c/src/server.c#L113-L180" target="_blank" rel="noopener noreferrer"><code>server.c</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li><code>write</code> — write, like <code>SET</code>, <code>RPUSH</code>, <code>DEL</code></li> <li><code>read-only</code> — read, like <code>GET</code>, <code>STRLEN</code>, <code>EXISTS</code></li> <li><code>use-memory</code> — may increase memory usage once called, don't allow if out of memory, like <code>SET</code>, <code>APPEND</code>, <code>RPUSH</code>, <code>LPUSH</code>, <code>SADD</code>, <code>SINTERSTORE</code></li> <li>more</li></ul></li> <li>related commands
<ul><li><code>COMMAND</code> — details about all Redis commands</li> <li><code>COMMAND COUNT</code></li> <li><code>COMMAND INFO command-name [command-name ...]</code> — <code>COMMAND</code> for specific commands</li> <li><code>COMMAND GETKEYS</code> — keys parsed from a full Redis command</li></ul></li></ul></li> <li><p>client</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">client</span> <span class="token punctuation">{</span> <span class="token comment">// once called redisClient</span>
  uint64_t id<span class="token punctuation">;</span>            <span class="token comment">/* Client incremental unique ID. */</span>
  connection <span class="token operator">*</span>conn<span class="token punctuation">;</span> <span class="token comment">// fd, connection type, state, flags, callbacks</span>
  <span class="token comment">// ...</span>
  redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span>            <span class="token comment">/* Pointer to currently SELECTed DB. */</span>
  robj <span class="token operator">*</span>name<span class="token punctuation">;</span>             <span class="token comment">/* As set by CLIENT SETNAME. */</span>
  sds querybuf<span class="token punctuation">;</span>           <span class="token comment">/* Buffer we use to accumulate client queries. */</span>
  <span class="token comment">// ...</span>
  uint64_t flags<span class="token punctuation">;</span>         <span class="token comment">/* Client flags: CLIENT_* macros. */</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span> client<span class="token punctuation">;</span>
</code></pre></div><ul><li>query buffer (hard non-configurable limit) or reply buffer overflow — the client will be closed
<ul><li>hard limit — close immediately</li> <li>soft limit — close after the time elapsed since <code>client.obuf_soft_limit_reached_time</code> is beyond the configured, <code>client-output-buffer-limit</code> in configurations</li></ul></li> <li><code>querybuf</code> related fields<div class="language-c extra-class"><pre class="language-c"><code>size_t qb_pos<span class="token punctuation">;</span>          <span class="token comment">/* The position we have read in querybuf. */</span>
sds pending_querybuf<span class="token punctuation">;</span>   <span class="token comment">/* If this client is flagged as master, this buffer
                           represents the yet not applied portion of the
                           replication stream that we are receiving from
                           the master. */</span>
size_t querybuf_peak<span class="token punctuation">;</span>   <span class="token comment">/* Recent (100ms or more) peak of querybuf size. */</span>
<span class="token keyword">int</span> argc<span class="token punctuation">;</span>               <span class="token comment">/* Num of arguments of current command. */</span>
robj <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">;</span>            <span class="token comment">/* Arguments of current command. */</span>
<span class="token keyword">struct</span> <span class="token class-name">redisCommand</span> <span class="token operator">*</span>cmd<span class="token punctuation">,</span> <span class="token operator">*</span>lastcmd<span class="token punctuation">;</span>  <span class="token comment">/* Last command executed. */</span>
</code></pre></div></li> <li><code>flags</code><div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* Client flags */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_SLAVE</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>   </span><span class="token comment">/* This client is a repliaca */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_MASTER</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span>  </span><span class="token comment">/* This client is a master */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_MONITOR</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span> </span><span class="token comment">/* This client is a slave monitor, see MONITOR */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_MULTI</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span>   </span><span class="token comment">/* This client is in a MULTI context */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_BLOCKED</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span> </span><span class="token comment">/* The client is waiting in a blocking operation */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_DIRTY_CAS</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span> </span><span class="token comment">/* Watched keys modified. EXEC will fail. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_CLOSE_AFTER_REPLY</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span> </span><span class="token comment">/* Close after writing entire reply. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_UNBLOCKED</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span> </span><span class="token comment">/* This client was unblocked and is stored in
                                  server.unblocked_clients */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_LUA</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> </span><span class="token comment">/* This is a non connected client used by Lua */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_ASKING</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span>     </span><span class="token comment">/* Client issued the ASKING command */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_CLOSE_ASAP</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span></span><span class="token comment">/* Close this client ASAP */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">CLIENT_UNIX_SOCKET</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">)</span> </span><span class="token comment">/* Client connected via Unix domain socket */</span></span>
<span class="token comment">// more</span>
</code></pre></div></li> <li>client side caching — see <a href="#Publish-and-Subscribe">Publish and Subscribe</a></li> <li>more</li> <li>related commands
<ul><li><code>SELECT</code></li> <li><code>ECHO</code></li> <li><code>PING</code></li> <li><code>QUIT</code></li> <li><code>MONITOR</code> — a debugging command that streams back every command processed by the Redis server, <code>CLIENT_MONITOR</code> in <code>client.flags</code></li> <li><code>CLIENT</code> <ul><li><code>CLIENT LIST</code></li> <li><code>CLIENT GETNAME</code>, <code>CLIENT SETNAME</code></li> <li><code>CLIENT KILL</code></li> <li><code>CLIENT ID</code> — runtime unique and logical clock in terms of the time connected to the server</li> <li><code>CLIENT PAUSE</code> — suspend all the Redis clients for the specified amount of time (in milliseconds)</li> <li><code>CLIENT REPLY ON|OFF|SKIP</code></li> <li><code>CLIENT UNBLOCK</code></li> <li>client caching related commands, see <a href="#Publish-and-Subscribe">Publish and Subscribe</a></li></ul></li></ul></li></ul></li></ol> <h2 id="Events"><a href="#Events" class="header-anchor">#</a> Events</h2> <ol><li><p>event loop, <code>aeMain</code> in <code>ae.c</code> — <a href="https://zhuanlan.zhihu.com/p/144805500" target="_blank" rel="noopener noreferrer">zhihu<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>steps
<ol><li>in <code>beforesleep</code> call back
<ol><li>cluster and persistence logics like flush AOF buffer</li> <li><code>writeToClient</code></li></ol></li> <li><code>epoll_wait</code></li> <li>file events — sockets</li> <li>time events</li></ol></li> <li>limitations
<ul><li>single core</li> <li>big key throttling</li></ul></li></ul></li> <li><p>file events — Reactor model, I/O multiplexing, event queuing at event dispatcher</p> <ul><li>event handlers
<ul><li><code>acceptTcpHandler</code></li> <li><code>readQueryFromClient</code></li> <li><code>sendReplyToClient</code></li> <li>more</li></ul></li> <li>tbd</li></ul></li> <li><p>time events — tbd</p> <ul><li>one time scheduled events</li> <li>periodic events <code>serverCron</code> — <code>hz</code> in configurations, defaults to 10, update statistics, expunge expired keys, close and clear sessions, AOF and RDB, follower replication, cluster synchronization and heartbeat
<ul><li>update tasks
<ul><li>update timestamp cache — timestamp cached in <code>redisServer.unixtime</code> and <code>redisServer.mstime</code> to reduce system calls for timestamp insensitive tasks like logging, deciding persistence time point, <code>EXPIRE</code> and slow query log not included</li> <li>update <code>redisServer.lruclock</code> timestamp cache, defaults to once every 10s</li> <li>update stats</li></ul></li> <li>more tasks</li></ul></li></ul></li> <li><p>multithread IO, since 6.0 — <a href="https://zhuanlan.zhihu.com/p/144805500" target="_blank" rel="noopener noreferrer">zhihu<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, dispatch tasks to IO threads for <code>read()</code> and <code>write()</code> system calls, main thread also does one tasks and spinning waiting for the completion of IO threads</p></li></ol> <h2 id="Publish-and-Subscribe"><a href="#Publish-and-Subscribe" class="header-anchor">#</a> Publish and Subscribe</h2> <ol><li><p>publish and subscribe</p> <ul><li>channels<div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">/* Pubsub */</span>
    dict <span class="token operator">*</span>pubsub_channels<span class="token punctuation">;</span>  <span class="token comment">/* Map channels to list of subscribed clients */</span>
    list <span class="token operator">*</span>pubsub_patterns<span class="token punctuation">;</span>  <span class="token comment">/* A list of pubsub_patterns */</span>
    dict <span class="token operator">*</span>pubsub_patterns_dict<span class="token punctuation">;</span>  <span class="token comment">/* A dict of pubsub_patterns */</span>
    <span class="token keyword">int</span> notify_keyspace_events<span class="token punctuation">;</span> <span class="token comment">/* Events to propagate via Pub/Sub. This is an
                                   xor of NOTIFY_... flags. */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">client</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    dict <span class="token operator">*</span>pubsub_channels<span class="token punctuation">;</span>  <span class="token comment">/* channels a client is interested in (SUBSCRIBE) */</span>
    list <span class="token operator">*</span>pubsub_patterns<span class="token punctuation">;</span>  <span class="token comment">/* patterns a client is interested in (SUBSCRIBE) */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> client<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>pubsub_channels</code> — <code>dict</code>, key as channel name, value as a linked list of subscribed clients</li> <li><code>pubsub_patterns</code> — <code>list</code>, <code>pubsubPattern</code> as elements<div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">pubsubPattern</span> <span class="token punctuation">{</span>
    client <span class="token operator">*</span>client<span class="token punctuation">;</span>
    robj <span class="token operator">*</span>pattern<span class="token punctuation">;</span>
<span class="token punctuation">}</span> pubsubPattern<span class="token punctuation">;</span>
</code></pre></div></li></ul></li> <li>related commands
<ul><li><code>SUBSCRIBE</code></li> <li><code>PSUBSCRIBE</code> — glob-style pattern subscribe</li> <li><code>PUBLISH channel message</code> — O(N+M) where N is the number of clients subscribed to the receiving channel and M is the total number of subscribed patterns (by any client)</li> <li><code>PUBSUB</code> — inspect the state of the Pub/Sub subsystem
<ul><li><code>PUBSUB CHANNELS [pattern]</code></li> <li><code>PUBSUB NUMSUB [channel-1 ... channel-N]</code></li> <li><code>PUBSUB NUMPAT</code></li></ul></li> <li><code>UNSUBSCRIBE</code></li> <li><code>PUNSUBSCRIBE</code></li></ul></li></ul></li> <li><p>keyspace event notifications</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>event<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> dbid<span class="token punctuation">)</span>
</code></pre></div><ul><li>event — all the commands generate events only if the target key is really modified, <code>notify-keyspace-events</code> in configurations
<ul><li>keyspace event — every key event in a keyspace</li> <li>key event — commands on keys</li></ul></li> <li>channel name
<ul><li>key-space notification — prefixed with <code>__keyspace@&lt;db&gt;__</code>, like <code>__keyspace@0__:foo</code></li> <li>key-event notification — prefixed with <code>__keyevent@&lt;db&gt;__</code></li> <li>example — when <code>DEL</code> <code>mykey</code><div class="language- extra-class"><pre class="language-text"><code>PUBLISH __keyspace@0__:mykey del
PUBLISH __keyevent@0__:del mykey
</code></pre></div></li> <li>test — use below <code>redis-cli</code> and another <code>redis-cli</code> to send key commands<div class="language-shell extra-class"><pre class="language-shell"><code>$ redis-cli config <span class="token builtin class-name">set</span> notify-keyspace-events KEA
$ redis-cli --csv psubscribe <span class="token string">'__key*__:*'</span>
Reading messages<span class="token punctuation">..</span>. <span class="token punctuation">(</span>press Ctrl-C to quit<span class="token punctuation">)</span>
<span class="token string">&quot;psubscribe&quot;</span>,<span class="token string">&quot;__key*__:*&quot;</span>,1
</code></pre></div></li></ul></li> <li>node-specific in a cluster — keyspace event notifications not broadcasted in a cluster to receive all keyspace events of a cluster, clients need to subscribe to all nodes</li> <li>parameters
<ul><li><code>event</code> — command name, like <code>del</code></li> <li><code>key</code>, <code>dbid</code> — related key and db</li> <li><code>type</code> — <code>redisServer.notify_keyspace_events</code>, at least <code>K</code> or <code>E</code> should present in <code>notify-keyspace-events</code> otherwise no event<div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* Keyspace changes notification classes. Every class is associated with a
 * character for configuration purposes. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_KEYSPACE</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>    </span><span class="token comment">/* K */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_KEYEVENT</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span>    </span><span class="token comment">/* E */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_GENERIC</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span>     </span><span class="token comment">/* g */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_STRING</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span>      </span><span class="token comment">/* $ */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_LIST</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span>        </span><span class="token comment">/* l */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_SET</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span>         </span><span class="token comment">/* s */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_HASH</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span>        </span><span class="token comment">/* h */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_ZSET</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span>        </span><span class="token comment">/* z */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_EXPIRED</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span>     </span><span class="token comment">/* x */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_EVICTED</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span>     </span><span class="token comment">/* e */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_STREAM</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span>     </span><span class="token comment">/* t */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_KEY_MISS</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">)</span>   </span><span class="token comment">/* m (Note: This one is excluded from NOTIFY_ALL on purpose) */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_LOADED</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">)</span>     </span><span class="token comment">/* module only key space notification, indicate a key loaded from rdb */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">NOTIFY_ALL</span> <span class="token punctuation">(</span>NOTIFY_GENERIC <span class="token operator">|</span> NOTIFY_STRING <span class="token operator">|</span> NOTIFY_LIST <span class="token operator">|</span> NOTIFY_SET <span class="token operator">|</span> NOTIFY_HASH <span class="token operator">|</span> NOTIFY_ZSET <span class="token operator">|</span> NOTIFY_EXPIRED <span class="token operator">|</span> NOTIFY_EVICTED <span class="token operator">|</span> NOTIFY_STREAM<span class="token punctuation">)</span> </span><span class="token comment">/* A flag */</span></span>
</code></pre></div></li></ul></li></ul></li> <li><p>tracking — assist client caching, since 6.0, specific improvement for the practice of leveraging the Pub/Sub system in order to send invalidation messages to invalidate stale cache</p> <ul><li>src — <code>tracking.c</code>, tbd</li> <li>two modes
<ul><li>default — the server remembers what keys a given client accessed in the tracking table, and send invalidation messages when the same keys are modified or evicted
<ul><li>invalidation message — clients remove the corresponding keys upon receiving</li></ul></li> <li>broadcasting — clients subscribe to key prefixes such as <code>object:</code> or <code>user:</code>, and will receive a notification message every time a key matching such prefix is touched, no memory cost for server</li></ul></li> <li>implementation
<ul><li>default mode
<ul><li>tracking table — keys to clients kept by server
<ul><li>eviction — random eviction, evict an older entry and send invalidation message if max reached; <code>tracking_table_max_keys</code> in configurations, defaults to no limit</li></ul></li> <li>store client ID instead of pointer — avoid GC; if a client disconnects, the information will be incrementally garbage collected as caching slots are invalidated</li> <li>single key space — modification to a key in database 2 can invalidate another key in database 3, reducing both the memory usage and the implementation complexity</li></ul></li> <li>broadcasting mode
<ul><li>prefix table — each prefix is associated to a list of clients</li></ul></li></ul></li> <li>connection
<ul><li>RESP3 — multiplexing, possible to run the data queries and receive the invalidation messages in the same connection</li> <li>RESP2 — can only use two separated connections: one for data, and one for invalidation messages (<code>_redis_:invalidate</code> channel, note that using Pub/Sub is entirely a trick to reuse old client implementations, but actually the message is not really sent to a channel)
<ul><li>race condition — possible when invalidation connection faster than data connection<div class="language- extra-class"><pre class="language-text"><code>[D] client -&gt; server: GET foo (server start tracking the key)
[I] server -&gt; client: Invalidate foo (somebody else touched it)
[D] server -&gt; client: &quot;bar&quot; (the reply of &quot;GET foo&quot;, which is not valid but will be cached)
</code></pre></div><ul><li>solution — populate the key in the local cache with null placeholder, do nothing if key missing upon getting result (<code>put</code> if present instead of just <code>put</code>)</li></ul></li></ul></li></ul></li> <li>tracking target
<ul><li>normally — keys in read only commands</li> <li>opt-in caching — <code>OPTIN</code> option, when broadcasting is NOT active, use <code>CLIENT CACHING yes</code> to track keys in read only commands, effective for the immediately next command/transaction/script</li> <li>opt-out caching — <code>OPTOUT</code> option, the contrary of <code>OPTIN</code>, in tandem with <code>CLIENT CACHING no</code></li></ul></li> <li>network partition — if connection lost, flush the local cache, can be in tandem with invalidation connection <code>PING</code> heartbeat to see if connection lost</li> <li>related commands
<ul><li><code>CLIENT TRACKING</code> <ul><li><code>NOLOOP</code> option — don't send notifications about keys modified by this connection itself</li></ul></li> <li><code>CLIENT CACHING YES|NO</code></li> <li><code>CLIENT GETREDIR</code> — returns the client ID we are redirecting our tracking notifications to</li></ul></li></ul></li></ol> <h2 id="Persistence"><a href="#Persistence" class="header-anchor">#</a> Persistence</h2> <ol><li><p>RDB — persistence of current snapshot in memory as a compressed binary file</p> <ul><li>expired key handling — see <a href="#Server-and-Client"><code>redisDb</code></a></li> <li>automatic load — if AOF switched off, RDB files are loaded automatically at start</li> <li>auto <code>BGSAVE</code> — <code>save &lt;seconds&gt; &lt;changes&gt;</code> in configurations, triggered if after <code>&lt;seconds&gt;</code> since <code>redisServer.lastsave</code> <code>redisServer.dirty</code> is more than <code>&lt;changes&gt;</code>, executed by <code>serverCron</code> function
<ul><li><code>redisServer.dirty</code> — counter for changes to keys since last <code>SAVE</code> or <code>BGSAVE</code>, for example, the counter will +3 after <code>SADD</code> 3 elements on a key</li> <li><code>redisServer.lastsave</code> — timestamp of last successful <code>SAVE</code> or <code>BGSAVE</code></li></ul></li> <li>RDB file format — tbd</li> <li>related commands
<ul><li><code>SAVE</code> — blocking</li> <li><code>BGSAVE</code> — non-blocking in a forked process, but reject other <code>SAVE</code>, <code>BGSAVE</code>, <code>BGREWRITEAOF</code> when executing</li> <li><code>LASTSAVE</code> — the UNIX TIME of the last DB save executed with success</li></ul></li></ul></li> <li><p>AOF — append only file, text file format, recording write commands</p> <ul><li>steps
<ul><li>append — write to buffer <code>redisServer.aof_buf</code>, whose type is <code>sds</code></li> <li>write and sync — at the end of every event loop, <code>flushAppendOnlyFile</code> executed, which writes to AOF and sync as <code>appendfsync</code> in configurations</li></ul></li> <li><code>appendfsync</code> in configurations
<ul><li><code>always</code> — also depends on <code>no-appendfsync-on-rewrite</code>, which defaults to false</li> <li><code>everysec</code>, default — if over 1 sec since last sync; by a dedicated thread</li> <li><code>no</code> — no sync, sync handled by OS</li></ul></li> <li>AOF loading — fake client created, from which commands in AOF executed</li> <li>AOF rewrite — deduplicate AOF, implemented by generating commands from current database state with care for client input buffer overflow
<ul><li>non-blocking — AOF rewrite is executed in a forked process, new commands during AOF rewrite are simultaneously saved in a separate buffer besides the normal AOF buffer, which is flushed to the new AOF before the new AOF replace the previous one</li></ul></li> <li>expired key handling — see <a href="#Server-and-Client"><code>redisDb</code></a></li> <li>related commands
<ul><li><code>BGREWRITEAOF</code> — non-blocking, but reject <code>BGSAVE</code> and another <code>BGREWRITEAOF</code> when executing</li></ul></li></ul></li></ol> <h2 id="Clustering"><a href="#Clustering" class="header-anchor">#</a> Clustering</h2> <h3 id="Replication"><a href="#Replication" class="header-anchor">#</a> Replication</h3> <ol><li><p>replication</p> <ul><li>tree structure — replicas can also be connected to other replicas, forming sub-replicas; all the sub-replicas will receive exactly the same replication stream from the master since 4.0</li> <li>read write
<ul><li>readonly replica — <code>replica-read-only</code> in configurations</li> <li>write master only when — <code>min-replicas-to-write</code> and <code>min-replicas-max-lag</code> in configurations: if there are at least N replicas, with a lag less than M seconds, then the write will be accepted</li></ul></li> <li>related commands
<ul><li><code>SLAVEOF</code>, <code>REPLICAOF</code>, <code>slaveof</code> in configurations</li> <li><code>SYNC</code>, <code>PSYNC</code> — internal command</li> <li><code>REPLCONF</code></li> <li><code>INFO replication</code></li> <li><code>WAIT</code> — blocks the current client until all the previous write commands are successfully transferred and acknowledged by at least the specified number of replicas</li> <li><code>ROLE</code></li></ul></li></ul></li> <li><p>synchronization — initial sync and then command propagate</p> <ul><li>initial sync
<ul><li><code>SYNC</code> — used in old version, slave send <code>SYNC</code> to master, the master starts recording commands while <code>BGSAVE</code> for RDB file and send it to the slave, the slave load the file, and the master send commands since <code>BGSAVE</code> to the slave</li> <li><code>PSYNC</code> — full resynchronization as <code>SYNC</code> for initial replication, partial resynchronization as recovery, see below</li> <li>diskless support — the master can send RDB file to replicas without persisting it on the disk, <code>repl-diskless-sync</code> in configurations</li></ul></li> <li>command propagate — after initial sync, asynchronously propagate commands which are with side effects, use <code>WAIT</code> for synchronous replication</li> <li>heartbeat — update replication offset, and last heartbeat time for lag
<ul><li>heartbeat detail — slaves will ping master with <code>REPLCONF ACK replication_offset</code> periodically, defaults to 1 Hz, <code>lag</code> in the output of <code>INFO replication</code></li> <li>anti-entropy — reconcile if the <code>replication_offset</code> received by master does not match its own, e.g. some command propagate message lost</li></ul></li> <li>data safety
<ul><li>persistence and restart — it is strongly advised to have persistence turned on in the master and in the replicas, if not possible instances should be configured to avoid restarting automatically after a reboot, to avoid replication of the initial empty state after restart</li> <li>expire — replicas wait for <code>DEL</code> from the master for expiration, and the replica uses its logical clock to report that a key does not exist only for read operations that don't violate the consistency of the data set</li></ul></li></ul></li> <li><p>partial resynchronization implementation — by replication offset in master and slave, replication backlog in master as buffer, and replication ID</p> <ul><li>replication offset — master adds n to its offset upon n bytes propagated, slave adds n to its offset upon n bytes received</li> <li>replication backlog — fixed size FIFO queue defaults to 1 MB, saving propagated commands; if the command the replication offset in slave points to no longer in the queue, resort to full resynchronization</li> <li>replication ID — random string, marks a given history of the data set, generated every time an instance restarts from scratch as a master, or a replica is promoted to master (but also keep one old ID for partial sync since 4.0); slave will persist the ID after handshake, send back to master upon recovering, full resynchronization if no replication ID match
<ul><li>change replication ID after promotion — in case the old master is still working as a master because of some network partition</li></ul></li></ul></li></ol> <h3 id="Sentinel"><a href="#Sentinel" class="header-anchor">#</a> Sentinel</h3> <ol><li><p>sentinel — monitor masters and slaves, and pick new leader</p> <ul><li>state<div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sentinelState</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    uint64_t current_epoch<span class="token punctuation">;</span>         <span class="token comment">/* Current epoch. */</span>
    dict <span class="token operator">*</span>masters<span class="token punctuation">;</span>      <span class="token comment">/* Dictionary of master sentinelRedisInstances.
                           Key is the instance name, value is the
                           sentinelRedisInstance structure pointer. */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> sentinel<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>sentinelRedisInstance</code> — states of master, slave or another sentinel</li></ul></li> <li>configurations — <code>sentinel</code>, see <a href="https://redis.io/topics/sentinel#configuring-sentinel" target="_blank" rel="noopener noreferrer">redis.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>commands, see <a href="https://redis.io/topics/sentinel#sentinel-commands" target="_blank" rel="noopener noreferrer">redis.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>related command
<ul><li><code>SENTINEL</code> — monitor and configuration provider</li> <li><code>ROLE</code></li></ul></li> <li>available commands — <code>PING</code>, pub/sub etc., also see <code>sentinelcmds[]</code> in <code>sentinel.c</code></li></ul></li></ul></li> <li><p>links — command link and subscribe link, first established to the master and then slaves</p> <ul><li>channel — sentinels publish and subscribe via the channel <code>__sentinel__:hello</code></li> <li>inter-sentinel communication — discovery each other sentinel by pub/sub (see below), then establish command links to each other</li> <li>sentinel as a Redis-compatible Pub/Sub server — for clients to get notified about sentinel events, see <a href="https://redis.io/topics/sentinel#pubsub-messages" target="_blank" rel="noopener noreferrer">redis.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for event list and message format</li></ul></li> <li><p>sentinel recovery, downgrade and anti-entropy</p> <ul><li>persistent state — sentinel state is persisted in the sentinel configuration file: every time a new configuration is received, or created (leader Sentinels), for a master, the configuration is persisted on disk together with the configuration epoch</li> <li>TILT mode: time drift protection — in TILT mode the Sentinel will continue to monitor everything, but stop acting at all
<ul><li>trigger — the Sentinel timer interrupt is normally called 10 times per second, if the call time difference is negative or over 2s, TILT mode entered for 30s or prolonged if already entered</li></ul></li> <li>anti-entropy — periodically, see below
<ul><li>eventual consistency — as configuration propagation, every partition will converge to the higher <code>configEpoch</code> configuration available (last-write-wins), use <code>min-replicas-to-write</code> and <code>min-replicas-max-lag</code> to bound the divergence
<ul><li>proxies using CRDT — <a href="https://github.com/soundcloud/roshi" target="_blank" rel="noopener noreferrer">Roshi<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/Netflix/dynomite" target="_blank" rel="noopener noreferrer">Dynomite<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></li></ul></li> <li><p>heartbeat</p> <ul><li>refresh <code>INFO</code>: <code>INFO</code> master and slaves — sentinel will send <code>INFO</code> to master in 0.1 Hz, refreshing <code>run_id</code> and <code>slaves</code> accordingly, for newly added slaves, sentinel will create link to them and thereafter send heartbeats in the same manner, and extract <code>run_id</code>, <code>role</code>, <code>master_link_status</code>, <code>slave_priority</code>, <code>slave_repl_offset</code> etc. from <code>INFO</code></li> <li>reconcile and discover other sentinels: make master and slaves <code>PUBLISH</code> and piggyback — sentinel send <code>PUBLISH</code> to master and slave, defaults to 0.5 Hz<div class="language- extra-class"><pre class="language-text"><code>PUBLISH __sentinel__:hello &quot;&lt;s_ip&gt;,&lt;s_port&gt;,&lt;s_runid&gt;,&lt;s_epoch&gt;,&lt;m_name&gt;,&lt;m_id&gt;,&lt;m_port&gt;,&lt;m_epoch&gt;
</code></pre></div><ul><li><code>s_</code> for sentinel, <code>m_</code> for master</li> <li>loop: perception of other sentinels — sentinels can <code>PUBLISH</code> via command link and receive via their subscription, for piggybacked message, ignore if same ID as self in the message, update states according to the message if other sentinels</li> <li>configuration propagation — as the above <code>__sentinel__:hello</code> loop, but only accept configurations with larger Raft epoch (see anti-entropy above)</li></ul></li> <li>failure detection: to master, slaves and other sentinels — sentinel <code>PING</code> other servers in 1 Hz, with possible response <code>+PONG</code>, <code>-LOADING</code>, <code>-MASTERDOWN</code> <ul><li>subjective down — if no valid response for <code>down-after-milliseconds</code> in sentinel configurations, <code>SRI_S_DOWN</code> will be ORed to flags; opinions may vary among sentinels</li> <li>objective down — after <code>SRI_S_DOWN</code> detected, the sentinel asks other sentinels, <code>SRI_O_DOWN</code> ORed if down for a quorum, <code>quorum</code> set in sentinel configurations and can vary among sentinels<div class="language- extra-class"><pre class="language-text"><code>SENTINEL is-master-down-by-addr &lt;ip&gt; &lt;port&gt; &lt;current_epoch&gt; &lt;run_id_or_star&gt;
</code></pre></div>response, where the last two only used for leader election<div class="language- extra-class"><pre class="language-text"><code>1) &lt;down_state&gt;
2) &lt;leader_runid&gt;
3) &lt;leader_epoch&gt;
</code></pre></div></li></ul></li></ul></li> <li><p>failover when objective down</p> <ul><li>sentinel leader election (Raft) — after master server objective down, a sentinel will <code>SENTINEL is-master-down-by-addr</code> to other sentinels but with own <code>run_id</code>, the following runs like Raft</li> <li>promotion — after master failure, the leader sentinel selects a slave as the new master by sending <code>SLAVEOF no one</code>, then <code>INFO</code> in 1 Hz to see if <code>role</code> in response becomes <code>master</code>, and the <code>SLAVEOF</code> other slaves to set the new master, also <code>SLAVEOF</code> the old master once it come back
<ul><li>selection for promotion — filter out down slaves, slaves with no response for <code>INFO</code> for 5s, slaves whose link with the old master broke for <code>down-after-milliseconds * 10</code>; then sort by <code>slave_priority</code>, <code>slave_repl_offset</code>, <code>run_id</code> and choose the best</li></ul></li> <li>enforce configuration — even when no failover is in progress, sentinels will always try to set the current configuration on monitored instances with a delay, helping recovered instances to catch up
<ul><li>delay — to reconfigure, the wrong configuration must be observed for some time, that is greater than the period used to broadcast new configurations</li></ul></li></ul></li></ol> <h3 id="Redis-Cluster"><a href="#Redis-Cluster" class="header-anchor">#</a> Redis Cluster</h3> <ol><li><p>cluster — database sharding</p> <ul><li>enable cluster — <code>cluster-enabled</code> in configurations, other cluster configurations are similarly <code>cluster–</code> prefixed, a node can only <code>SELECT</code> 0, cluster bus port is always command port plus 1000</li> <li>add node to cluster — three way handshake after <code>CLUSTER MEET</code> from the client: <code>MEET</code>, <code>PONG</code>, <code>PING</code>; then disseminate to other nodes via Gossip (heartbeats) to let them handshake the new node
<ul><li>set slave — <code>CLUSTER REPLICATE</code>, set <code>clusterState.myself.slaveof</code> and turn off <code>CLUSTER_NODE_MASTER</code> and turn on <code>CLUSTER_NODE_SLAVE</code> in <code>clusterState.myself.flags</code>, then information disseminated via heartbeats, and other nodes update information in <code>clusterNode-&gt;slaves</code>, <code>clusterNode.numslaves</code></li></ul></li> <li>related commands
<ul><li><code>MIGRATE</code> — <code>DUMP</code> + <code>DEL</code> in the source, <code>RESTORE</code> in the sink: atomically transfer a key from a source Redis instance to a destination Redis instance</li> <li><code>READONLY</code> — enables read queries for a connection to a Redis Cluster replica node, indicate the client is fine with possible stale data and will not write</li> <li><code>READWRITE</code> — reverse of <code>READONLY</code></li> <li><code>CLUSTER</code> <ul><li><code>CLUSTER MEET</code></li> <li><code>CLUSTER NODES</code></li> <li><code>CLUSTER INFO</code></li> <li><code>CLUSTER ADDSLOTS</code>, <code>SETSLOT</code></li> <li><code>CLUSTER KEYSLOT</code></li> <li><code>CLUSTER GETKEYSINSLOT</code></li> <li><code>CLUSTER REPLICATE</code></li> <li><code>CLUSTER FAILOVER</code></li></ul></li></ul></li></ul></li> <li><p>nodes</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterState</span> <span class="token punctuation">{</span>
    clusterNode <span class="token operator">*</span>myself<span class="token punctuation">;</span>  <span class="token comment">/* This node */</span>
    <span class="token comment">// ...</span>
    dict <span class="token operator">*</span>nodes<span class="token punctuation">;</span>          <span class="token comment">/* Hash table of name -&gt; clusterNode structures */</span>
    dict <span class="token operator">*</span>nodes_black_list<span class="token punctuation">;</span> <span class="token comment">/* Nodes we don't re-add for a few seconds. */</span>
    clusterNode <span class="token operator">*</span>migrating_slots_to<span class="token punctuation">[</span>CLUSTER_SLOTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    clusterNode <span class="token operator">*</span>importing_slots_from<span class="token punctuation">[</span>CLUSTER_SLOTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    clusterNode <span class="token operator">*</span>slots<span class="token punctuation">[</span>CLUSTER_SLOTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    uint64_t slots_keys_count<span class="token punctuation">[</span>CLUSTER_SLOTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    rax <span class="token operator">*</span>slots_to_keys<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> clusterState<span class="token punctuation">;</span>
</code></pre></div><div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterNode</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> slots<span class="token punctuation">[</span>CLUSTER_SLOTS<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* slots handled by this node */</span>
    <span class="token keyword">int</span> numslots<span class="token punctuation">;</span>   <span class="token comment">/* Number of slots handled by this node */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> clusterNode<span class="token punctuation">;</span>
</code></pre></div> <ul><li>node attributes (<code>clusterState</code>) — own persistent ID, and information about other nodes such as ID, epoch, slots</li> <li>complete graph link — all the cluster nodes are connected using a TCP bus and a binary protocol, called Redis Cluster Bus; but use Gossip to avoid exchanging too many messages between nodes during normal conditions</li> <li>slots — <code>1 &lt;&lt; 14</code> = 16384 slots, suggested max size of nodes is in the order of ~ 1000 nodes
<ul><li>delegate slots to a node — <code>CLUSTER ADDSLOTS</code></li> <li>broadcast <code>slots</code> — a node will broadcast its <code>slots</code> to other nodes, which is kept in <code>clusterState.slots</code> and <code>clusterNode.slots</code> in <code>clusterState-&gt;nodes</code></li> <li>hash function — <code>CRC16(key) &amp; 0x3fff</code>, command <code>CLUSTER KEYSLOT</code> <ul><li><code>0x3fff</code> — bitmap for a node will be of size 2 KB, which saves bandwidth compared to 65536 slots, and 16384 slots are enough for clusters under 1000 nodes</li></ul></li> <li><code>slots_to_keys</code> — slot to key mapping as radix trees, support for commands like <code>CLUSTER GETKEYSINSLOT</code></li> <li>multiple key operations — supported as long as all the keys involved all belong to the same hash slot, use hash tags to ensure</li> <li>hash tags — only hash the non-empty substring between the first <code>{}</code> in a key if possible, e.g., <code>this{foo}key</code> and <code>another{foo}key</code> are guaranteed to be in the same hash slot</li></ul></li></ul></li> <li><p>redirect and re-sharding</p> <ul><li>redirect — execute if the right slot, otherwise redirect the client to the node the slot belongs to by a <code>-MOVED</code> error; eventually clients obtain an up-to-date representation of the cluster and directly contact the right nodes, by memorizing received <code>-MOVED</code> or issuing <code>CLUSTER NODE</code> or <code>CLUSTER SLOTS</code> upon every <code>-MOVED</code></li> <li>re-sharding — adjust slot distribution and migrate slots</li> <li>migrate slots — executed online by cluster management utility <code>redis-trib</code>, one slot by one slot
<ol><li>send <code>CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;source_id&gt;</code> to target node, setting its <code>clusterState.importing_slots_from[slot]</code> to source node</li> <li>send <code>CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;target_id&gt;</code> to source node, setting its <code>clusterState.migrating_slots_to[slot]</code> to target node</li> <li>send <code>CLUSTER GETKEYSINSLOT</code> to source node, for keys responded, send <code>MIGRATE</code> to source node; repeat until all keys migrated</li> <li>send <code>CLUSTER SETSLOT &lt;slot&gt; NODE &lt;target_id&gt;</code> to any node to disseminate the information to the cluster</li></ol></li> <li>command executing when migrating
<ul><li><code>-ASK</code> error — if the key does not exist on the source node, send <code>-ASK</code> error to redirect the client to the target node, and client send <code>ASKING</code> to the redirected node before resending command</li> <li><code>ASKING</code> — turn on <code>REDIS_ASKING</code> in <code>client.flags</code> for next command; a node will refrain from send <code>-MOVED</code> error and try to execute the command even if the slot is not delegated to the node if <code>REDIS_ASKING</code> on the client and <code>clusterState.importing_slots_from[slot]</code> is not <code>NULL</code></li> <li><code>-TRYAGAIN</code> error — if keys split between the source and destination nodes for multiple key operations, clients can try again later or report the error</li></ul></li></ul></li> <li><p>messages</p> <ul><li>message types
<ul><li><code>MEET</code></li> <li><code>PING</code> — in 1 Hz, every node selects 5 other random nodes to <code>PING</code>; besides, every node <code>PING</code> nodes whose last <code>PONG</code> till now is over half of <code>cluster-node-timeout</code></li> <li><code>PONG</code> — response to <code>MEET</code> and <code>PING</code>, or voluntary broadcast</li> <li><code>FAIL</code> — broadcasted ASAP</li> <li><code>UPDATE</code> — if a receiver of a heartbeat packet finds the sender information is stale, it will <code>UPDATE</code> the stale node</li> <li><code>PUBLISH</code> — clients can subscribe to every node, and can also publish to every other node; the current implementation will simply broadcast each published message to all other nodes, but at some point this will be optimized either using Bloom filters or other algorithms</li></ul></li> <li>message header common to all messages — <code>clusterMsg</code> in <code>cluster.h</code>, includes the sender's ID, <code>currentEpoch</code>, <code>configEpoch</code>, flags, slot bitmap, port, master ID, cluster state POV (<code>CLUSTER_OK</code> or <code>CLUSTER_FAIL</code>)</li> <li>heartbeat — <code>PING</code>, <code>PONG</code>, also contain a Gossip section</li> <li>Gossip section — for <code>MEET</code>, <code>PING</code> and <code>PONG</code> messages, offering a view of some random nodes from the cluster, including ID, address and flags, where the number of random nodes is proportional to the cluster size<div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* PING, MEET and PONG */</span>
<span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">/* Array of N clusterMsgDataGossip structures */</span>
    clusterMsgDataGossip gossip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> ping<span class="token punctuation">;</span>
</code></pre></div></li></ul></li> <li><p>failover — use replication for each node and select a slave as the new master if the original master is down</p> <ul><li>eventual consistency — due to asynchronous replication and partition like the one documented in sentinel above</li> <li>failure states
<ul><li>cluster fail — <code>CLUSTER_FAIL</code> even if only one slot not handled</li> <li>heartbeat and <code>CLUSTER_NODE_PFAIL</code> (probable fail) — nodes (masters and slaves) in cluster will periodically <code>PING</code> each other, if no <code>PONG</code> for more than <code>cluster-node-timeout</code>, mark <code>CLUSTER_NODE_PFAIL</code> for target node in <code>clusterState.nodes</code> and disseminate via heartbeat message; upon receiving such message, a node will append it to <code>clusterNode-&gt;fail_reports</code> in <code>clusterState.nodes</code> <ul><li>reconnect — nodes also try to reconnect the TCP link to avoid marking <code>CLUSTER_NODE_PFAIL</code> only because a TCP link problem</li> <li>self protection — nodes refuse writes if cannot reach the majority for more than <code>cluster-node-timeout</code></li></ul></li> <li><code>CLUSTER_NODE_FAIL</code> — if a majority of master nodes mark one master node <code>CLUSTER_NODE_PFAIL</code> or <code>CLUSTER_NODE_FAIL</code> within <code>cluster-node-timeout</code> multiplied by a factor (2 currently), then that node will be marked <code>CLUSTER_NODE_FAIL</code>, and a <code>FAIL</code> message will be broadcasted</li></ul></li> <li>failover — when the master fails, slaves can start elections and if a slave is elected, it is elected to <code>SLAVEOF no one</code>, cancel slots in the original master and add those slots for itself, then broadcast a <code>PONG</code> to inform the cluster
<ul><li>prerequisites for a slave to start an election — when the master with positive <code>numslots</code> failed from the POV of the slave, and the time since slave's last interaction with the master is less than an amount configurable by <code>cluster-replica-validity-factor</code>, a slave node can start election after a jittered delay computed with slave rank</li> <li>slave rank — slaves exchange messages when the master is failing in order to establish a (best effort) rank, ranked by how updated the replication offset is. In this way the most updated slaves try to get elected before others.</li> <li>new master election — Raft like, other master nodes can vote but behave <a href="https://redis.io/topics/cluster-spec#masters-reply-to-slave-vote-request" target="_blank" rel="noopener noreferrer">a little differently<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> compared to Raft, <code>currentEpoch</code> as term, upon winning a new unique and incremental <code>configEpoch</code> higher than any other master is created and new configuration is broadcasted to overwrite configurations with old ones</li></ul></li> <li>replica migration — guarantees that eventually every master will be backed by at least one slave
<ul><li>process — if singled master detected, the slave among the masters with the maximum number of attached slaves, that is not in FAIL state and has the smallest node ID, will migrate to the singled master</li> <li>can try to migrate only when enough slaves left — <code>cluster-migration-barrier</code> in configurations</li></ul></li> <li>recover and clear <code>CLUSTER_NODE_FAIL</code> — if failed nodes reachable again for some time, clear directly if slave or no slot, otherwise rejoin the cluster
<ul><li>rejoin — rejoining master nodes will be slave of the node that stole its last hash slot, rejoining slave nodes will be slave of the node that stole the last hash slot of its former master</li></ul></li></ul></li> <li><p>proxy based</p> <ul><li><a href="https://github.com/twitter/twemproxy" target="_blank" rel="noopener noreferrer">twitter/twemproxy: A fast, light-weight proxy for memcached and redis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ol> <h2 id="Transaction"><a href="#Transaction" class="header-anchor">#</a> Transaction</h2> <ol><li><p>transaction — queue commands and execute them atomically, no rollback</p> <ul><li>command queue — all commands except transaction related commands will be validated and queued, all the other commands will be executed even if some command fails during the transaction<div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">multiState</span> <span class="token punctuation">{</span>
    multiCmd <span class="token operator">*</span>commands<span class="token punctuation">;</span>     <span class="token comment">/* Array of MULTI commands */</span>
    <span class="token keyword">int</span> count<span class="token punctuation">;</span>              <span class="token comment">/* Total number of MULTI commands */</span>
    <span class="token keyword">int</span> cmd_flags<span class="token punctuation">;</span>          <span class="token comment">/* The accumulated command flags OR-ed together.
                               So if at least a command has a given flag, it
                               will be set in this field. */</span>
    <span class="token keyword">int</span> cmd_inv_flags<span class="token punctuation">;</span>      <span class="token comment">/* Same as cmd_flags, OR-ing the ~flags. so that it
                               is possible to know if all the commands have a
                               certain flag. */</span>
    <span class="token keyword">int</span> minreplicas<span class="token punctuation">;</span>        <span class="token comment">/* MINREPLICAS for synchronous replication */</span>
    time_t minreplicas_timeout<span class="token punctuation">;</span> <span class="token comment">/* MINREPLICAS timeout as unixtime. */</span>
<span class="token punctuation">}</span> multiState<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">client</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    multiState mstate<span class="token punctuation">;</span>      <span class="token comment">/* MULTI/EXEC state */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> client<span class="token punctuation">;</span>
</code></pre></div></li> <li>optimistic lock — <code>WATCH</code>, transaction aborted if any <code>WATCH</code>ed key is modified before <code>EXEC</code> <ul><li>implementation — <code>redisDb-&gt;watched_keys</code>, <code>dict</code> of key to client linked list; add <code>CLIENT_DIRTY_CAS</code> in <code>client.flags</code> if a command with <code>w</code> in <code>redisCommand.sflags</code> modified watched keys</li></ul></li> <li>ACID — guaranteed by single thread, except durability
<ul><li>force durability — <code>SAVE</code> before <code>EXEC</code>, but low performance</li></ul></li></ul></li> <li><p>related commands</p> <ul><li><code>MULTI</code> — start transaction, <code>CLIENT_MULTI</code> in <code>client.flags</code></li> <li><code>EXEC</code> — executes all previously queued commands</li> <li><code>WATCH</code>, <code>UNWATCH</code></li> <li><code>DISCARD</code> — also <code>UNWATCH</code> all keys</li></ul></li> <li><p>Lua scripts — Lua 5.1, transactional by definition</p> <ul><li>create Lua environment
<ol><li>创建一个基础的 Lua 环境 by <code>lua_open</code>， 之后的所有修改都是针对这个环境进行的。</li> <li>载入多个函数库到 Lua 环境里面， 让 Lua 脚本可以使用这些函数库来进行数据操作。 — tbd</li> <li>创建全局表格 <code>redis</code> ， 这个表格包含了对 Redis 进行操作的函数， 比如用于在 Lua 脚本中执行 Redis 命令的 <code>redis.call</code> 函数。</li> <li>使用 Redis 自制的随机函数来替换 Lua 原有的带有副作用的随机函数， 从而避免在脚本中引入副作用。</li> <li>创建排序辅助函数， Lua 环境使用这个辅佐函数来对一部分 Redis 命令的结果进行排序， 从而消除这些命令的不确定性。</li> <li>创建 <code>redis.pcall</code> 函数的错误报告辅助函数， 这个函数可以提供更详细的出错信息。</li> <li>对 Lua 环境里面的全局环境进行保护， 防止用户在执行 Lua 脚本的过程中， 将额外的全局变量添加到了 Lua 环境里面。</li> <li>将完成修改的 Lua 环境保存到服务器状态的 <code>lua</code> 属性里面， 等待执行服务器传来的 Lua 脚本。</li></ol></li> <li><code>redis.call</code> and <code>redis.pcall</code> — executed by <code>redisServer.lua_client</code>, arguments are arguments of Redis commands<div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'bar'</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>error handling — if a Redis command call will result in an error, <code>redis.call()</code> will raise a Lua error that in turn will force <code>EVAL</code> to return an error to the command caller, while <code>redis.pcall()</code> will trap the error and return a Lua table representing the error</li> <li>keys must be passed explicitly — in order to be compatible with cluster</li></ul></li> <li>SHA1
<ul><li>as key — <code>redisServer-&gt;lua_scripts</code>, which is <code>dict</code> with SHA1 as key, function body as value</li> <li>as Lua function name — function <code>f_&lt;SHA1&gt;()</code> is defined with the arguments of <code>EVAL</code></li></ul></li> <li><a href="https://redis.io/commands/eval#conversion-between-lua-and-redis-data-types" target="_blank" rel="noopener noreferrer">tbd from type conversion<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>related commands
<ul><li><code>EVAL script numkeys key [key ...] arg [arg ...]</code></li> <li><code>EVALSHA</code> — arguments as <code>EVAL</code>, scripts cached using <code>SCRIPT LOAD</code></li> <li><code>SCRIPT</code> — tbd
<ul><li><code>SCRIPT DEBUG</code></li> <li><code>SCRIPT EXISTS</code></li> <li><code>SCRIPT FLUSH</code></li> <li><code>SCRIPT KILL</code></li> <li><code>SCRIPT LOAD</code></li></ul></li></ul></li></ul></li> <li><p>other non-transactional batch</p> <ul><li>pipeline — batch commands but not in a transaction</li> <li>mass insertion — <code>redis-cli --pipe</code> pipe mode<div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">cat</span> data.txt <span class="token operator">|</span> redis-cli --pipe
</code></pre></div><ul><li><code>data.txt</code> — sequence of commands in the Redis protocol format, see <a href="https://redis.io/topics/mass-insert" target="_blank" rel="noopener noreferrer">Redis Mass Insertion<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for scripts for generating</li></ul></li></ul></li></ol> <h2 id="Other"><a href="#Other" class="header-anchor">#</a> Other</h2> <ol><li><p>config</p> <ul><li>config file — <code>/etc/redis/redis.conf</code> or as CLI options prefixed with <code>--</code></li> <li>related command — <code>CONFIG</code> <ul><li><code>CONFIG GET</code> — support <code>*</code> glob pattern</li> <li><code>CONFIG SET</code></li> <li><code>CONFIG REWRITE</code> — rewrites the <code>redis.conf</code> to current configurations</li></ul></li></ul></li> <li><p><code>maxmemory-policy</code> in configurations — eviction policy when <code>maxmemory</code> reached, which defaults to 0 which means no limit for 64 bit systems</p> <ul><li><code>noeviction</code> — no eviction, return errors instead</li> <li>LRU — approximated of LRU, by sampling <code>maxmemory-samples</code> of keys, and evicting the one least recently used; pooling since 3.0, when the N keys sampling was performed, keys are used to populate a larger pool of keys (just 16 keys by default) sorted by idle time, if the keys are less recently used
<ul><li><code>allkeys-lru</code> — all keys</li> <li><code>volatile-lru</code> — only among keys that have an expire set, return errors instead if no eviction</li></ul></li> <li>random
<ul><li><code>allkeys-random</code></li> <li><code>volatile-random</code></li></ul></li> <li><code>volatile-ttl</code> — evict keys with an expire set, and try to evict keys with a shorter TTL first, return errors instead if no eviction</li> <li>LFU — since 4.0, reuse <code>redisObject.lru</code>, uses Morris counter (the greater the counter, the less likely to be incremented) to estimate access frequency, combined with a decay period so that the counter is reduced over time; sampled similarly to LRU
<ul><li><a href="https://github.com/redis/redis/blob/204a14b8cffba6a23e4e313e248bed7ef5cd8260/src/evict.c#L242-L277" target="_blank" rel="noopener noreferrer">src<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>tune
<ul><li><code>lfu-log-factor 10</code> – defaults to saturate (255) at around 1M hits</li> <li><code>lfu-decay-time 1</code></li></ul></li> <li><code>allkeys-lfu</code></li> <li><code>volatile-lfu</code></li></ul></li> <li>related commands — <code>MEMORY</code>, see <code>MEMORY HELP</code> <ul><li><code>MEMORY DOCTOR</code></li> <li><code>MEMORY MALLOC-STATS</code></li> <li><code>MEMORY PURGE</code></li> <li><code>MEMORY STATS</code> — some overlap with <code>INFO</code></li> <li><code>MEMORY USAGE</code> — the number of bytes that a key and its value require to be stored in RAM</li> <li><code>OBJECT FREQ</code> — available when <code>maxmemory-policy</code> is set to an LFU policy</li> <li><code>TOUCH key [key ...]</code> — alters the last access time of keys</li></ul></li></ul></li> <li><p>slow log</p> <ul><li>configurations — <code>slowlog-log-slower-than</code>, <code>slowlog-max-len</code></li> <li>log entry id — <code>long long</code> <code>redisServer.slowlog_entry_id</code>, +1 every time</li> <li>latency
<ul><li>enable latency monitor — <code>LATENCY</code>, <code>latency-monitor-threshold</code> in configurations</li> <li><a href="https://redis.io/topics/latency" target="_blank" rel="noopener noreferrer">Redis latency problems troubleshooting – Redis.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li> <li>related commands
<ul><li><code>SLOWLOG</code> <ul><li><code>SLOWLOG GET</code></li> <li><code>SLOWLOG LEN</code></li> <li><code>SLOWLOG RESET</code></li></ul></li> <li><code>LATENCY</code> — see <code>LATENCY HELP</code> <ul><li><code>LATENCY LATEST</code> — returns the latest latency samples for all events</li> <li><code>LATENCY HISTORY</code> — returns latency time series for a given event</li> <li><code>LATENCY RESET</code> — resets latency time series data for one or more events</li> <li><code>LATENCY GRAPH</code> — renders an ASCII-art graph of an event's latency samples</li> <li><code>LATENCY DOCTOR</code> — replies with a human-readable latency analysis report</li></ul></li></ul></li></ul></li> <li><p>distributed locks — see <a href="/notes-of-tan/backend/distributed.html#Distributed-Locks">distributed</a></p></li> <li><p>big keys</p> <ul><li>find big keys — <code>redis-cli --bigkeys</code>, <code>SCAN</code></li> <li>check whether big key — <code>DEBUG OBJECT</code>, <code>STRLEN</code>, etc.</li> <li>delete bigkeys — <code>UNLINK</code></li></ul></li> <li><p>Redis modules — since 4.0, dynamic libraries, <code>loadmodule</code> in configurations or use <code>MODULE LOAD</code></p> <ul><li><a href="https://redis.io/topics/modules-intro" target="_blank" rel="noopener noreferrer">tbd<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>related commands <code>MODULE</code> <ul><li><code>MODULE LIST</code></li> <li><code>MODULE LOAD</code></li> <li><code>MODULE UNLOAD</code></li></ul></li></ul></li> <li><p>security</p> <ul><li>command disabling — <code>rename-config</code> in configurations</li> <li>hash flooding protect — Redis uses a per-execution pseudo-random seed to the hash function</li> <li>ACL — allows certain connections to be limited in terms of the commands that can be executed and the keys that can be accessed, new connections are already authenticated with a &quot;default&quot; user</li> <li>TLS — see <a href="https://redis.io/topics/encryption" target="_blank" rel="noopener noreferrer">TLS Support – Redis.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>related commands
<ul><li><code>AUTH</code></li> <li><code>ACL</code></li></ul></li></ul></li> <li><p>RESP — Redis clients communicate with the Redis server using a protocol called REdis Serialization Protocol</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">{</span> <span class="token builtin class-name">echo</span> -e <span class="token string">'*1<span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span><span class="token variable">$4</span><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>PING<span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>'</span><span class="token punctuation">;</span> <span class="token function">sleep</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">|</span> netcat redis.host.com <span class="token number">6379</span>
</code></pre></div><ul><li>delimiter and section terminator — <code>\r\n</code></li> <li>data type — depends on the first byte, bulk strings and arrays are followed by byte count and <code>\r\n</code> if not <code>NULL</code> <ul><li><code>+</code> — simple strings</li> <li><code>-</code> — errors</li> <li><code>:</code> — integers</li> <li><code>$</code> — bulk strings</li> <li><code>*</code> — arrays</li> <li><code>NULL</code> — <code>&quot;$-1\r\n&quot;</code>, <code>&quot;*-1\r\n&quot;</code></li></ul></li> <li>client request and server reply — a client sends the Redis server a RESP Array consisting of just Bulk Strings; a Redis server replies to clients sending any valid RESP data type as reply</li> <li>inline mode — designed for utilities like <code>telnet</code><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">echo</span> PING <span class="token operator">|</span> <span class="token function">nc</span> localhost <span class="token number">6379</span>
</code></pre></div></li> <li>RESP3 — since 6.0, <a href="https://github.com/antirez/RESP3/blob/master/spec.md" target="_blank" rel="noopener noreferrer">specification<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>map data type</li> <li>multiplexing — possible to run the data queries and receive the invalidation messages in the same connection</li></ul></li> <li>related commands
<ul><li><code>HELLO</code> — since 6.0, switch protocol</li></ul></li></ul></li> <li><p>meme</p> <ul><li><code>LOLWUT</code></li></ul></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/tangentyh/notes-of-tan/edit/master/docs/backend/redis-notes.md" target="_blank" rel="noopener noreferrer">Edit This Page On GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/10/2021, 4:19:58 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><div class="vuepress-eqn"></div><span class="vuepress-eq"></span></div></div>
    <script src="/notes-of-tan/assets/js/app.a20ae0e7.js" defer></script><script src="/notes-of-tan/assets/js/2.33f31c9b.js" defer></script><script src="/notes-of-tan/assets/js/27.01533c2a.js" defer></script>
  </body>
</html>
