<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java Concurrency | Notes of Tan</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="https://v1.vuepress.vuejs.org/hero.png">
    <meta name="description" content="Tan's notes.">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/notes-of-tan/assets/css/0.styles.9802d8bc.css" as="style"><link rel="preload" href="/notes-of-tan/assets/js/app.bd5566f0.js" as="script"><link rel="preload" href="/notes-of-tan/assets/js/2.33f31c9b.js" as="script"><link rel="preload" href="/notes-of-tan/assets/js/23.49e69635.js" as="script"><link rel="prefetch" href="/notes-of-tan/assets/js/10.90ccce99.js"><link rel="prefetch" href="/notes-of-tan/assets/js/11.95d04f86.js"><link rel="prefetch" href="/notes-of-tan/assets/js/12.ef1d3621.js"><link rel="prefetch" href="/notes-of-tan/assets/js/13.a4adee88.js"><link rel="prefetch" href="/notes-of-tan/assets/js/14.c09755c2.js"><link rel="prefetch" href="/notes-of-tan/assets/js/15.3733f8dd.js"><link rel="prefetch" href="/notes-of-tan/assets/js/16.45186f0f.js"><link rel="prefetch" href="/notes-of-tan/assets/js/17.ed547b98.js"><link rel="prefetch" href="/notes-of-tan/assets/js/18.1143a315.js"><link rel="prefetch" href="/notes-of-tan/assets/js/19.c704f56e.js"><link rel="prefetch" href="/notes-of-tan/assets/js/20.7212c2fb.js"><link rel="prefetch" href="/notes-of-tan/assets/js/21.5ada412e.js"><link rel="prefetch" href="/notes-of-tan/assets/js/22.391b670c.js"><link rel="prefetch" href="/notes-of-tan/assets/js/24.1ec9070f.js"><link rel="prefetch" href="/notes-of-tan/assets/js/25.c9b3cb0c.js"><link rel="prefetch" href="/notes-of-tan/assets/js/26.6d0133c7.js"><link rel="prefetch" href="/notes-of-tan/assets/js/27.92637cf1.js"><link rel="prefetch" href="/notes-of-tan/assets/js/28.921eb6b3.js"><link rel="prefetch" href="/notes-of-tan/assets/js/29.9de9cb08.js"><link rel="prefetch" href="/notes-of-tan/assets/js/3.f2118d7b.js"><link rel="prefetch" href="/notes-of-tan/assets/js/30.1574681b.js"><link rel="prefetch" href="/notes-of-tan/assets/js/31.97ed5447.js"><link rel="prefetch" href="/notes-of-tan/assets/js/32.061cf937.js"><link rel="prefetch" href="/notes-of-tan/assets/js/33.40fadf29.js"><link rel="prefetch" href="/notes-of-tan/assets/js/34.1cb87aa7.js"><link rel="prefetch" href="/notes-of-tan/assets/js/35.ffb66b35.js"><link rel="prefetch" href="/notes-of-tan/assets/js/36.5b4a09a3.js"><link rel="prefetch" href="/notes-of-tan/assets/js/37.4e57a711.js"><link rel="prefetch" href="/notes-of-tan/assets/js/4.379a9a10.js"><link rel="prefetch" href="/notes-of-tan/assets/js/5.a6215647.js"><link rel="prefetch" href="/notes-of-tan/assets/js/6.8136b6d3.js"><link rel="prefetch" href="/notes-of-tan/assets/js/7.1140570f.js"><link rel="prefetch" href="/notes-of-tan/assets/js/8.bd5a1ed5.js"><link rel="prefetch" href="/notes-of-tan/assets/js/9.98e24ffb.js">
    <link rel="stylesheet" href="/notes-of-tan/assets/css/0.styles.9802d8bc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes-of-tan/" class="home-link router-link-active"><!----> <span class="site-name">Notes of Tan</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaBasics.html" class="nav-link">
  Java Basics
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaUtils.html" class="nav-link">
  Java Utilities
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaConcurrency.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Java Concurrency
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaIO.html" class="nav-link">
  IO
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaMisc.html" class="nav-link">
  Java Miscellanea
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/JVM.html" class="nav-link">
  Java Virtual Machine
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend" class="dropdown-title"><span class="title">Backend</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend" class="mobile-dropdown-title"><span class="title">Backend</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/SpringNotes.html" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/OS-notes.html" class="nav-link">
  OS
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/database.html" class="nav-link">
  Database
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/SQL_notes.html" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/distributed.html" class="nav-link">
  Distributed System
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/redis-notes.html" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Frontend" class="dropdown-title"><span class="title">Frontend</span> <span class="arrow down"></span></button> <button type="button" aria-label="Frontend" class="mobile-dropdown-title"><span class="title">Frontend</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/CSS-notes.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/html-notes.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/todo/jsNotes.html" class="nav-link">
  JS, TS
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/BOM_DOM_notes.html" class="nav-link">
  BOM, DOM, Web API
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/todo/react_notes.html" class="nav-link">
  React
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><span class="title">Other</span> <span class="arrow down"></span></button> <button type="button" aria-label="Other" class="mobile-dropdown-title"><span class="title">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/algo_notes.html" class="nav-link">
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/git_notes.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/DesignPatternNotes.html" class="nav-link">
  Design Pattern
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/HTTP.html" class="nav-link">
  HTTP
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/mac-notes.html" class="nav-link">
  MacOS
</a></li></ul></div></div> <a href="https://github.com/tangentyh/notes-of-tan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaBasics.html" class="nav-link">
  Java Basics
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaUtils.html" class="nav-link">
  Java Utilities
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaConcurrency.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Java Concurrency
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaIO.html" class="nav-link">
  IO
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/javaMisc.html" class="nav-link">
  Java Miscellanea
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/java/JVM.html" class="nav-link">
  Java Virtual Machine
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend" class="dropdown-title"><span class="title">Backend</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend" class="mobile-dropdown-title"><span class="title">Backend</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/SpringNotes.html" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/OS-notes.html" class="nav-link">
  OS
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/database.html" class="nav-link">
  Database
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/SQL_notes.html" class="nav-link">
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/distributed.html" class="nav-link">
  Distributed System
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/backend/redis-notes.html" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Frontend" class="dropdown-title"><span class="title">Frontend</span> <span class="arrow down"></span></button> <button type="button" aria-label="Frontend" class="mobile-dropdown-title"><span class="title">Frontend</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/CSS-notes.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/html-notes.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/todo/jsNotes.html" class="nav-link">
  JS, TS
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/BOM_DOM_notes.html" class="nav-link">
  BOM, DOM, Web API
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/todo/react_notes.html" class="nav-link">
  React
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><span class="title">Other</span> <span class="arrow down"></span></button> <button type="button" aria-label="Other" class="mobile-dropdown-title"><span class="title">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes-of-tan/algo_notes.html" class="nav-link">
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/git_notes.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/DesignPatternNotes.html" class="nav-link">
  Design Pattern
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/HTTP.html" class="nav-link">
  HTTP
</a></li><li class="dropdown-item"><!----> <a href="/notes-of-tan/mac-notes.html" class="nav-link">
  MacOS
</a></li></ul></div></div> <a href="https://github.com/tangentyh/notes-of-tan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-of-tan/backend/java/javaBasics.html" class="sidebar-link">Java Basics</a></li><li><a href="/notes-of-tan/backend/java/javaUtils.html" class="sidebar-link">Java Utils</a></li><li><a href="/notes-of-tan/backend/java/javaConcurrency.html" aria-current="page" class="active sidebar-link">Java Concurrency</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/java/javaConcurrency.html#Thread" class="sidebar-link">Thread</a></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/java/javaConcurrency.html#Synchronization-and-Locks" class="sidebar-link">Synchronization and Locks</a></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/java/javaConcurrency.html#volatile-and-Atomics" class="sidebar-link">volatile and Atomics</a></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/java/javaConcurrency.html#Thread-Safe-Collections" class="sidebar-link">Thread-Safe Collections</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/java/javaConcurrency.html#Blocking-Queues" class="sidebar-link">Blocking Queues</a></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/java/javaConcurrency.html#Concurrent-Collections" class="sidebar-link">Concurrent Collections</a></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/java/javaConcurrency.html#Copy-on-Write-Collections" class="sidebar-link">Copy on Write Collections</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/java/javaConcurrency.html#Callable-and-Future" class="sidebar-link">Callable and Future</a></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/java/javaConcurrency.html#Executors" class="sidebar-link">Executors</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/java/javaConcurrency.html#Fork-Join" class="sidebar-link">Fork-Join</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/java/javaConcurrency.html#Synchronizers" class="sidebar-link">Synchronizers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-of-tan/backend/java/javaConcurrency.html#Count-Synchronizers" class="sidebar-link">Count Synchronizers</a></li></ul></li></ul></li><li><a href="/notes-of-tan/backend/java/javaIO.html" class="sidebar-link">IO</a></li><li><a href="/notes-of-tan/backend/java/javaMisc.html" class="sidebar-link">Java Miscellanea</a></li><li><a href="/notes-of-tan/backend/java/JVM.html" class="sidebar-link">JVM</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="Java-Concurrency"><a href="#Java-Concurrency" class="header-anchor">#</a> Java Concurrency</h1> <h2 id="Thread"><a href="#Thread" class="header-anchor">#</a> Thread</h2> <ol><li><p>multithread</p> <ul><li>construct a runnable thread
<ul><li>construct with a <code>Runnable</code> target</li> <li>subclass <code>Thread</code> and override <code>run</code> method — recommended only when customizing <code>run</code> is not enough</li></ul></li> <li>start a thread — <code>Thread::run</code> <ul><li><a href="https://zhuanlan.zhihu.com/p/34414549" target="_blank" rel="noopener noreferrer">zhihu<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li> <li>thread scheduling — depends on the services the OS provides</li></ul></li> <li><p>properties of threads</p> <ul><li>priority — whenever the scheduler wants to pick a new thread, threads with higher priorities are preferred
<ul><li>inherit — initially set equal to the priority of the creating thread</li> <li>mapped constants — <code>Thread.MIN_PRIORITY</code> 1, <code>Thread.NORM_PRIORITY</code> 5, <code>Thread.MAX_PRIORITY</code> 10, mapped to priority levels of the host platform</li> <li>OS dependent — Windows has seven priority levels, thread priorities are ignored on Linux by default</li> <li>unrecommended — few scenarios there to ever tweak priorities. If you have several threads with a high priority that don’t become inactive, the lower-priority threads may never execute</li></ul></li> <li>daemon — serves other threads, JVM exits when only daemon threads remain
<ul><li>inherit — is a daemon thread if and only if the creating thread is a daemon</li> <li>no persistence access — should never access a persistent resource such as a file or database since it can terminate at any time</li></ul></li> <li>state — enum <code>Thread.State</code>, see below</li> <li><code>Thread.UncaughtExceptionHandler</code> — method to be invoked from when the given thread terminates due to the given uncaught exception<div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UncaughtExceptionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>exceptions in <code>uncaughtException</code> — any exception thrown by this method will be ignored by JVM</li> <li>handler defaults — default handler (<code>static</code> <code>Thread::setDefaultUncaughtExceptionHandler</code>) defaults to <code>null</code>, individual handler (<code>Thread::setUncaughtExceptionHandler</code>) defaults to <code>ThreadGroup</code></li></ul></li> <li><code>ThreadGroup</code> — represents a set of threads. In addition, a thread group can also include other thread groups<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadGroup</span> <span class="token keyword">implements</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token class-name">UncaughtExceptionHandler</span>
</code></pre></div><ul><li>unrecommended — use alternatives instead</li> <li>share some APIs of <code>Thread</code></li> <li>action orders of <code>ThreadGroup::uncaughtException</code> when an uncaught exception
<ol><li>the <code>uncaughtException</code> method of the parent thread group</li> <li>otherwise, default handler if non-<code>null</code></li> <li>otherwise, nothing happens if the <code>Throwable</code> is an instance of <code>ThreadDeath</code></li> <li>otherwise, print the name of the thread and the stack trace to <code>System.err</code></li></ol></li></ul></li> <li><code>ThreadLocal</code>, <code>ThreadLocalRandom</code> — thread-local variables, see below<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">&gt;</span></span> dateFormat <span class="token operator">=</span>
    <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>motivations — avoid synchronization and blocking and boost performance
<ul><li>motivation of the above example — the internal data structures used by <code>SimpleDateFormat</code> can be corrupted by concurrent access, and synchronization is expensive</li> <li>motivation of <code>ThreadLocalRandom</code> — <code>Random</code> is thread safe using <code>AtomicLong::compareAndSet</code>, but inefficient if multiple threads need to wait for a single shared generator</li></ul></li></ul></li></ul></li> <li><p><code>Runnable</code> — should be implemented by any class whose instances are intended to be executed by a thread</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>see <a href="#Callable-and-Future">Callable and Future</a> for more</li> <li>conversion to <code>Callable</code> — <code>Executors::callable</code></li></ul></li> <li><p><code>Thread</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span>
</code></pre></div><ul><li>constructors
<ul><li><code>Thread(Runnable target)</code></li> <li><code>Thread(Runnable target, String name)</code></li></ul></li> <li>lifecycle
<ul><li><code>void start()</code> <ul><li><code>void run()</code> — called by <code>start()</code>, generally should not be called explicitly</li></ul></li> <li><code>void interrupt()</code> — set the interrupted status, if the thread is blocked, throw <code>InterruptedException</code> inside the thread
<ul><li>used by blocking methods — typically blocking methods (those related to <code>Thread.State.WAITING</code> and <code>Thread.State.TIMED_WAITING</code>) threaten to throw <code>InterruptedException</code></li></ul></li></ul></li> <li>wait
<ul><li><code>static void yield()</code> — rarely appropriate to use, see javadoc</li> <li><code>static void sleep(long millis)</code> — for current thread<br> <code>static void sleep(long millis, int nanos)</code></li> <li><code>void join()</code> — waits for this thread to die<br> <code>void join(long millis)</code><br> <code>void join(long millis, int nanos)</code></li></ul></li> <li>get information
<ul><li><code>static Thread currentThread()</code></li> <li><code>boolean isAlive()</code></li> <li><code>boolean isInterrupted()</code> — can be used for check in <code>while</code></li> <li><code>static boolean interrupted()</code> — for current thread, also clears interrupted status</li> <li><code>int getPriority()</code></li> <li><code>boolean isDaemon()</code></li> <li><code>Thread.State getState()</code></li></ul></li> <li>get handler
<ul><li><code>Thread.UncaughtExceptionHandler getUncaughtExceptionHandler()</code></li> <li><code>static Thread.UncaughtExceptionHandler getDefaultUncaughtExceptionHandler()</code></li></ul></li> <li>set
<ul><li><code>void setPriority(int newPriority)</code></li> <li><code>void setDaemon(boolean on)</code></li> <li><code>void setUncaughtExceptionHandler(Thread.UncaughtExceptionHandler eh)</code></li> <li><code>static void setDefaultUncaughtExceptionHandler(Thread.UncaughtExceptionHandler eh)</code></li></ul></li></ul></li> <li><p><code>enum Thread.State</code></p> <ul><li><code>NEW</code> — after <code>new</code>, a thread that has not yet started is in this state.</li> <li><code>RUNNABLE</code> — after <code>start()</code>, a thread executing in the Java virtual machine is in this state, may not be running due to CPU time slicing</li> <li><code>BLOCKED</code> — intrinsic object lock, a thread that is blocked waiting for a monitor lock is in this state</li> <li><code>WAITING</code> — after <code>Object::wait</code>, <code>Thread::join</code>, or by <code>Lock</code> or <code>Condition</code>, a thread that is waiting indefinitely for another thread to perform a particular action is in this state.</li> <li><code>TIMED_WAITING</code> — after <code>Thread::sleep</code>, or methods for <code>WAITING</code> with a time parameter, a thread that is waiting for another thread to perform an action for up to a specified waiting time is in this state.</li> <li><code>TERMINATED</code> — A thread that has exited is in this state.</li></ul></li> <li><p><code>ThreadLocal</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><code>T get()</code></li> <li><code>void remove()</code> — can prevent possible memory leak</li> <li><code>void set(T value)</code><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><code>static &lt;S&gt; ThreadLocal&lt;S&gt; withInitial(Supplier&lt;? extends S&gt; supplier)</code></li> <li><code>ThreadLocal.ThreadLocalMap</code>, referenced by <code>Thread.threadLocals</code> instance field — hash table with closed hashing
<ul><li>entry — <code>WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</code> as key, whose hash value managed by a static <code>AtomicInteger</code>, which <code>getAndAdd</code> for every <code>ThreadLocal</code> instance</li> <li>memory leak — referent of <code>WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</code> keys can be reclaimed by GC, but no <code>ReferenceQueue</code> like in <code>WeakHashMap</code>, <code>expungeStaleEntries()</code> called only when rehash, and single entry expunge method called only when a stale entry encountered, possibly leaving stale entries not expunged</li></ul></li></ul></li> <li><p><code>java.util.concurrent.ThreadLocalRandom</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalRandom</span> <span class="token keyword">extends</span> <span class="token class-name">Random</span>
</code></pre></div><ul><li><code>static ThreadLocalRandom current()</code></li></ul></li></ol> <h2 id="Synchronization-and-Locks"><a href="#Synchronization-and-Locks" class="header-anchor">#</a> Synchronization and Locks</h2> <ol><li><p>synchronization</p> <ul><li>race condition — when a system's substantive behavior is dependent on the sequence or timing of other uncontrollable events</li> <li>atomic</li> <li>preference — concurrent collections with non-blocking mechanism, synchronizers &gt; underlying locks in <code>java.util.concurrent</code> &gt; <code>synchronized</code> &gt; <code>Lock</code> <ul><li>avoid client-side locking — discouraged to use the lock of an object to implement additional atomic operations, e.g. use the lock of a <code>Vector</code> object to implement something like <code>AtomicLong::getAndAdd</code> for given index</li></ul></li> <li>when to use
<blockquote><p>If you write a variable which may next be read by another thread, or you read a variable which may have last been written by another thread, you must use synchronization.</p></blockquote></li></ul></li> <li><p>lock — when the lock object is locked, no other thread can <code>lock()</code> (being blocked)</p> <div class="language-java extra-class"><pre class="language-java"><code>myLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a ReentrantLock object</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// critical section</span>
<span class="token punctuation">}</span>
<span class="token keyword">finally</span> <span class="token punctuation">{</span>
    myLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// make sure the lock is unlocked even if an exception is thrown</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>conditions, condition queues or condition variables — a means for one thread to suspend execution (to &quot;wait&quot;) until notified by another thread that some state condition may now be true</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">BoundedBuffer</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull  <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> items <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> putptr<span class="token punctuation">,</span> takeptr<span class="token punctuation">,</span> count<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Object</span> x<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span> notFull<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      items<span class="token punctuation">[</span>putptr<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>putptr <span class="token operator">==</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span> putptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token operator">++</span>count<span class="token punctuation">;</span>
      notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> notEmpty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Object</span> x <span class="token operator">=</span> items<span class="token punctuation">[</span>takeptr<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>takeptr <span class="token operator">==</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span> takeptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token operator">--</span>count<span class="token punctuation">;</span>
      notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>atomic lock release when calling <code>await()</code> — atomically releases the associated lock and suspends the current thread, just like <code>Object::wait</code></li> <li>re-acquire the lock when <code>signal()</code> — a thread must then re-acquire the lock before returning from <code>await()</code></li> <li>intrinsically bound to a lock
<ul><li><code>Lock::newCondition</code> to get instances</li> <li><code>await</code> and <code>signal</code> methods can only be called if the thread owns the <code>Lock</code> of the <code>Condition</code></li></ul></li> <li>wait set — a thread enters wait set and stays deactivated after the call to <code>await</code>, until <code>signal</code>ed by other threads</li> <li>deadlock — when all threads are in wait set</li></ul></li> <li><p><code>synchronized</code> — use intrinsic lock, a method or code block that is atomic to a thread, reentrant</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token keyword">int</span> from<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token keyword">to</span><span class="token punctuation">,</span> <span class="token keyword">int</span> amount<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>accounts<span class="token punctuation">[</span>from<span class="token punctuation">]</span> <span class="token operator">&lt;</span> amount<span class="token punctuation">)</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// wait on intrinsic object lock's single condition</span>
    accounts<span class="token punctuation">[</span>from<span class="token punctuation">]</span> <span class="token operator">-=</span> amount<span class="token punctuation">;</span>
    accounts<span class="token punctuation">[</span><span class="token keyword">to</span><span class="token punctuation">]</span> <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
    <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// notify all threads waiting on the condition</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span>condition does not hold<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
        obj<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Perform action appropriate to condition</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>intrinsic lock — every object has an intrinsic lock, used if declared with <code>synchronized</code> <ul><li>static methods — the intrinsic lock of associated <code>Class&lt;?&gt;</code> is used</li></ul></li> <li>equivalent conditions in <code>Object</code> — see <a href="/notes-of-tan/backend/java/javaBasics.html#Inheritance">Inheritance</a> for other <code>Object</code> APIs
<ul><li><code>void notify()</code></li> <li><code>void notifyAll()</code></li> <li><code>void wait()</code></li> <li><code>void wait(long timeout)</code></li> <li><code>void wait(long timeout, int nanos)</code></li></ul></li> <li>monitor — intrinsic lock is the loose adaption of the monitor concept, see <a href="https://en.wikipedia.org/wiki/Monitor_(synchronization)" target="_blank" rel="noopener noreferrer">Monitor (synchronization) - Wikipedia<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>JVM optimization — see <a href="https://zhuanlan.zhihu.com/p/75880892" target="_blank" rel="noopener noreferrer">zhihu<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Java%20%E5%B9%B6%E5%8F%91.md#%E5%8D%81%E4%BA%8C%E9%94%81%E4%BC%98%E5%8C%96" target="_blank" rel="noopener noreferrer">CS-Notes/Java 并发.md at master · CyC2018/CS-Notes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>锁膨胀 — unlocked, biased, lightweight, inflated</li> <li>锁消除, 锁粗化, 自适应自旋锁</li></ul></li></ul></li> <li><p><code>interface java.util.concurrent.locks.Lock</code></p> <ul><li><code>void lock()</code> — other threads are blocked if the lock cannot be acquired, cannot be interrupted</li> <li><code>void lockInterruptibly()</code> — <code>lock()</code> that can be interrupted, equivalent to <code>tryLock()</code> with an infinite timeout</li> <li><code>Condition newCondition()</code></li> <li><code>boolean tryLock()</code> — return <code>false</code> rather than being blocked</li> <li><code>boolean tryLock(long time, TimeUnit unit)</code> — can be interrupted</li> <li><code>void unlock()</code></li></ul></li> <li><p><code>interface java.util.concurrent.locks.Condition</code> — renamed API as counterpart methods in <code>Object</code> are <code>final</code></p> <ul><li><code>void await()</code></li> <li><code>boolean await(long time, TimeUnit unit)</code></li> <li><code>long awaitNanos(long nanosTimeout)</code></li> <li><code>void awaitUninterruptibly()</code></li> <li><code>boolean awaitUntil(Date deadline)</code></li> <li><code>void signal()</code> — choose one random thread to unblock, more likely to deadlock compared to <code>signalAll()</code></li> <li><code>void signalAll()</code></li></ul></li> <li><p><code>java.util.concurrent.locks.ReentrantLock</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">extends</span> <span class="token class-name">Object</span>
<span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div><ul><li>reentrant — has a hold count, can be repeatedly acquired by a thread, <code>lock()</code> will return immediately if the current thread already owns the lock, every <code>lock()</code> needs <code>unlock()</code> in order to relinquish the lock
<ul><li><code>int getHoldCount()</code></li></ul></li> <li>fair — a lot slower, a fair lock can still be unfair if the thread scheduler is unfair
<ul><li><code>ReentrantLock()</code></li> <li><code>ReentrantLock(boolean fair)</code></li></ul></li> <li>underlying implementation — <code>AbstractQueuedSynchronizer</code></li></ul></li> <li><p><code>java.util.concurrent.locks.ReentrantReadWriteLock</code> — read lock for accessors, write lock for mutators</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantReadWriteLock</span> <span class="token keyword">extends</span> <span class="token class-name">Object</span>
<span class="token keyword">implements</span> <span class="token class-name">ReadWriteLock</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div><ul><li><code>ReentrantReadWriteLock.ReadLock readLock()</code> <ul><li>read lock can be acquired if — the write lock is not held by another thread</li></ul></li> <li><code>ReentrantReadWriteLock.WriteLock writeLock()</code> <ul><li>write lock can be acquired if — neither the read nor write lock are held by another thread</li></ul></li> <li><code>interface java.util.concurrent.locks.ReadWriteLock</code> <ul><li>scenarios — while only a single thread at a time (a writer thread) can modify the shared data, in many cases any number of threads can concurrently read the data</li> <li>mutual exclusive or not — the read lock may be held simultaneously by multiple reader threads, so long as there are no writers. The write lock is exclusive</li> <li><code>writeLock</code> happen-before — must guarantee that the memory synchronization effects of <code>writeLock</code> operations: a thread successfully acquiring the read lock will see all updates made upon previous release of the write lock</li> <li>simultaneous read and write lock — a writer can acquire the read lock, but not vice-versa</li> <li>performance — the read-write lock implementation (which is inherently more complex than a mutual exclusion lock) can dominate the execution cost if the read operations are too short</li></ul></li> <li>underlying implementation — <code>AbstractQueuedSynchronizer</code></li></ul></li> <li><p><code>java.util.concurrent.locks.StampedLock</code> — a capability-based lock, not reentrant, lock acquisition methods return a stamp that represents and controls access with respect to a lock state; lock release and conversion methods require stamps as arguments</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StampedLock</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span>
</code></pre></div><ul><li>stamp — zero value for failure, the state of a <code>StampedLock</code> consists of a version and mode</li> <li>three modes
<ul><li>write — blocks waiting for exclusive access
<ul><li><code>long writeLock()</code></li> <li><code>void unlockWrite(long stamp)</code></li></ul></li> <li>read — blocks waiting for non-exclusive access
<ul><li><code>long readLock()</code></li> <li><code>void unlockRead(long stamp)</code></li> <li><code>int getReadLockCount()</code></li></ul></li> <li>optimistic read — an extremely weak version of a read-lock, that can be broken by a writer at any time, for short read-only code segments
<ul><li><code>long tryOptimisticRead()</code> — returns a non-zero stamp only if the lock is not currently held in write mode</li> <li><code>boolean validate(long stamp)</code> — returns true if the lock has not been acquired in write mode since obtaining a given stamp</li></ul></li> <li><code>void unlock(long stamp)</code></li></ul></li> <li>mode conversion methods</li> <li><code>Lock</code> conversion
<ul><li><code>Lock asReadLock()</code></li> <li><code>Lock asWriteLock()</code></li> <li><code>ReadWriteLock asReadWriteLock()</code></li></ul></li> <li>underlying implementation — memory fence methods in <code>VarHandle</code>, and <code>VarHandle::compareAndSet</code></li> <li>example<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token keyword">double</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StampedLock</span> sl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StampedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token keyword">double</span> deltaX<span class="token punctuation">,</span> <span class="token keyword">double</span> deltaY<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// an exclusively locked method</span>
     <span class="token keyword">long</span> stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">try</span> <span class="token punctuation">{</span>
       x <span class="token operator">+=</span> deltaX<span class="token punctuation">;</span>
       y <span class="token operator">+=</span> deltaY<span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
       sl<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">double</span> <span class="token function">distanceFromOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// A read-only method</span>
     <span class="token keyword">long</span> stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">double</span> currentX <span class="token operator">=</span> x<span class="token punctuation">,</span> currentY <span class="token operator">=</span> y<span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sl<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          currentX <span class="token operator">=</span> x<span class="token punctuation">;</span>
          currentY <span class="token operator">=</span> y<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
           sl<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>currentX <span class="token operator">*</span> currentX <span class="token operator">+</span> currentY <span class="token operator">*</span> currentY<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">void</span> <span class="token function">moveIfAtOrigin</span><span class="token punctuation">(</span><span class="token keyword">double</span> newX<span class="token punctuation">,</span> <span class="token keyword">double</span> newY<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// upgrade</span>
     <span class="token comment">// Could instead start with optimistic, not read mode</span>
     <span class="token keyword">long</span> stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token keyword">while</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span> y <span class="token operator">==</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">long</span> ws <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">tryConvertToWriteLock</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           stamp <span class="token operator">=</span> ws<span class="token punctuation">;</span>
           x <span class="token operator">=</span> newX<span class="token punctuation">;</span>
           y <span class="token operator">=</span> newY<span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token punctuation">{</span>
           sl<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
           stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
       sl<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ol> <h2 id="volatile-and-Atomics"><a href="#volatile-and-Atomics" class="header-anchor">#</a> volatile and Atomics</h2> <ol><li><p><code>volatile</code> — ensures that a field is coherently accessed by multiple threads</p> <ul><li>problems of concurrent write and read to instance fields
<ul><li>cache coherence — threads running in different processors may see different values for the same memory location</li> <li>reorder — a memory value can be changed by another thread, but compilers assume memory values are only changed with explicit instructions, and compilers reorder instructions to maximize throughput</li></ul></li> <li>solution to above problems
<ul><li>memory barrier, membar, memory fence or fence instruction — a type of barrier instruction that causes a CPU or compiler to enforce an ordering constraint on memory operations issued before and after the barrier instruction. This typically means that operations issued prior to the barrier are guaranteed to be performed before operations issued after the barrier</li> <li>barrier — a barrier for a group of threads or processes in the source code means any thread/process must stop at this point and cannot proceed until all other threads/processes reach this barrier</li></ul></li> <li>ensure changes visible — compiler will insert the appropriate code to ensure that a change to the a variable in one thread is visible from any other thread that reads the variable
<ul><li><a href="https://docs.oracle.com/javase/specs/jls/se11/html/jls-17.html#jls-17.4.5" target="_blank" rel="noopener noreferrer">happen-before order<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> — a write to a volatile field is visible to and ordered before every subsequent read of that field</li></ul></li> <li>atomicity — volatile variables do not provide any atomicity, but makes read and write to <code>long</code> and <code>double</code> atomic
<ul><li><a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.7" target="_blank" rel="noopener noreferrer">JLS 17.7. Non-Atomic Treatment of double and long<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <blockquote><p>For the purposes of the Java programming language memory model, a single write to a non-volatile <code>long</code> or <code>double</code> value is treated as two separate writes: one to each 32-bit half. This can result in a situation where a thread sees the first 32 bits of a 64-bit value from one write, and the second 32 bits from another write.</p></blockquote></li></ul></li> <li>also <code>synchronized</code> — changes visible before a variable is unlocked</li></ul></li> <li><p><code>java.util.concurrent.atomic</code> package — use efficient machine-level instructions to guarantee atomicity without using locks</p> <ul><li>optimistic update — <code>compareAndSet</code> method, or use lambda like <code>accumulateAndGet</code> method<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">AtomicLong</span> largest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// In some thread...</span>
<span class="token comment">// largest.set(Math.max(largest.get(), observed)); // Error--race condition!</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
    oldValue <span class="token operator">=</span> largest<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newValue <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">,</span> observed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>largest<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>CAS, <a href="https://en.wikipedia.org/wiki/Compare-and-swap" target="_blank" rel="noopener noreferrer">Compare-and-swap - Wikipedia<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>ABA problem — use <code>AtomicStampedReference</code>, or traditional synchronization</li></ul></li></ul></li> <li>delayed computation — <code>LongAdder</code>, <code>LongAccumulator</code>, <code>DoubleAdder</code>, <code>DoubleAccumulator</code> <ul><li>problem with CAS — under high contention, performance suffers because the optimistic updates require too many retries</li> <li>limit — the computation must be associative and commutative</li> <li><code>identity</code> in parameters — initial value, also used when <code>accumulate()</code></li></ul></li></ul></li> <li><p>classes in <code>java.util.concurrent.atomic</code></p> <ul><li><code>java.util.concurrent.atomic.AtomicBoolean</code> (implements <code>Serializable</code>)</li> <li><code>java.util.concurrent.atomic.AtomicIntegerArray</code> (implements <code>Serializable</code>)</li> <li><code>java.util.concurrent.atomic.AtomicIntegerFieldUpdater&lt;T&gt;</code> — a reflection-based utility that enables atomic updates to designated <code>volatile int</code> fields of designated classes</li> <li><code>java.util.concurrent.atomic.AtomicLongArray</code> (implements <code>Serializable</code>)</li> <li><code>java.util.concurrent.atomic.AtomicLongFieldUpdater&lt;T&gt;</code></li> <li><code>java.util.concurrent.atomic.AtomicMarkableReference&lt;V&gt;</code> — maintains markable references by creating internal objects representing &quot;boxed&quot; [reference, boolean] pairs</li> <li><code>java.util.concurrent.atomic.AtomicReference&lt;V&gt;</code> (implements <code>Serializable</code>)</li> <li><code>java.util.concurrent.atomic.AtomicReferenceArray&lt;E&gt;</code> (implements <code>Serializable</code>)</li> <li><code>java.util.concurrent.atomic.AtomicReferenceFieldUpdater&lt;T,V&gt;</code></li> <li><code>java.util.concurrent.atomic.AtomicStampedReference&lt;V&gt;</code></li> <li><code>java.lang.Number</code> <ul><li><code>java.util.concurrent.atomic.AtomicInteger</code></li> <li><code>java.util.concurrent.atomic.AtomicLong</code></li> <li><code>java.util.concurrent.atomic.Striped64</code> — a package-local class holding common representation and mechanics for classes supporting dynamic striping on 64 bit values
<ul><li><code>java.util.concurrent.atomic.DoubleAccumulator</code></li> <li><code>java.util.concurrent.atomic.DoubleAdder</code></li> <li><code>java.util.concurrent.atomic.LongAccumulator</code></li> <li><code>java.util.concurrent.atomic.LongAdder</code></li></ul></li></ul></li></ul></li></ol> <h2 id="Thread-Safe-Collections"><a href="#Thread-Safe-Collections" class="header-anchor">#</a> Thread-Safe Collections</h2> <ol><li><code>java.util.concurrent</code> exceptions
<ul><li><code>java.util.concurrent.BrokenBarrierException</code></li> <li><code>java.util.concurrent.ExecutionException</code></li> <li><code>java.util.concurrent.TimeoutException</code></li> <li><code>RuntimeException</code> <ul><li><code>java.util.concurrent.CompletionException</code></li> <li><code>IllegalStateException</code> <ul><li><code>java.util.concurrent.CancellationException</code></li></ul></li> <li><code>java.util.concurrent.RejectedExecutionException</code></li></ul></li></ul></li></ol> <h3 id="Blocking-Queues"><a href="#Blocking-Queues" class="header-anchor">#</a> Blocking Queues</h3> <ol><li><p>Blocking Queues</p> <ul><li>producer consumer model</li> <li>no synchronization needed — instead of synchronization and locks, queue the instructions and let only the access of one thread</li> <li>the queue needs to be thread-safe — blocking queue blocks a thread when no slot for producer or no provision for consumer</li> <li>non-null — parameter validated, typically with <code>Objects::requireNonNull</code></li> <li>implementation — <code>ReentrantLock</code> with <code>Condition</code>, except <code>SynchronousQueue</code>, <code>LinkedTransferQueue</code></li></ul></li> <li><p><code>java.util.concurrent.BlockingQueue</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><code>boolean add(E e)</code> — usually <code>AbstractQueue::add</code>, no lock and <code>IllegalStateException</code> if full</li> <li>blocking
<ul><li><code>E put(E e) throws InterruptedException</code></li> <li><code>E take() throws InterruptedException</code></li></ul></li> <li>timeout
<ul><li><code>boolean offer(E e, long timeout, TimeUnit unit) throws InterruptedException</code></li> <li><code>E poll(long timeout, TimeUnit unit) throws InterruptedException</code></li></ul></li> <li>return special value
<ul><li><code>boolean offer(E e)</code> — possible to return <code>false</code> if full after lock acquired</li> <li><code>E poll()</code> — possible to return <code>null</code> if empty after lock acquired</li></ul></li></ul></li> <li><p><code>java.util.concurrent.BlockingDeque</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">extends</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p><code>java.util.concurrent.LinkedBlockingQueue</code> — optionally-bounded blocking queue based on linked nodes</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div></li> <li><p><code>java.util.concurrent.LinkedBlockingDeque</code> — deque version of <code>LinkedBlockingQueue</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">BlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div></li> <li><p><code>java.util.concurrent.ArrayBlockingQueue</code> — optionally-fair bounded blocking queue backed by an array</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div></li> <li><p><code>java.util.concurrent.PriorityBlockingQueue</code> — unbounded blocking queue that uses the same ordering rules as <code>PriorityQueue</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div></li> <li><p><code>java.util.concurrent.DelayQueue</code> — unbounded blocking queue of <code>Delayed</code> elements backed by <code>PriorityQueue</code>, in which an element can only be taken when its delay has expired</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span> <span class="token keyword">extends</span> <span class="token class-name">Delayed</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>comparison in backing priority queue — generally <code>Long::compare</code> with <code>Delayed::getDelay</code></li> <li>implementation — block by remaining delay like in <code>take()</code> implemented by <code>Condition::awaitNanos</code> with <code>Delay::getDelay</code> as argument</li> <li><code>java.util.concurrent.Delay</code><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Delayed</span> <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Delayed</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> <span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// remaining delay</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>consistency between <code>compareTo</code>, <code>getDelay</code> and <code>equals</code> — a <code>compareTo</code> method needs to provide an ordering consistent with its <code>getDelay</code> method, which violates the consistency between <code>compareTo</code> and <code>equals</code></li></ul></li></ul></li> <li><p><code>java.util.concurrent.SynchronousQueue</code> — a mechanism that pairs up producer and consumer threads, a blocking queue in which each insert operation must wait for a corresponding remove operation by another thread, and vice versa</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div><ul><li>empty queue — no internal capacity, cannot <code>peek()</code>, etc.</li> <li>constructors — similar performance, but FIFO usually supports higher throughput under contention and LIFO maintains higher thread locality in common applications
<ul><li><code>SynchronousQueue()</code> — LIFO for non-fair mode</li> <li><code>SynchronousQueue(boolean fair)</code> — FIFO for fairness, performance is similar for this collection</li></ul></li> <li>implementation — dual queue with <code>LockSupport</code>, <code>VarHandle::compareAndSet</code>, see javadoc in source code</li> <li>other similar synchronizers — <code>LinkedTransferQueue</code>, <code>Exchanger</code></li></ul></li> <li><p><code>java.util.concurrent.LinkedTransferQueue</code> — unbounded <code>TransferQueue</code> backed by dual queues of slack (refer to javadoc in source code) based on linked nodes</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedTransferQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">TransferQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div><ul><li><code>java.util.concurrent.TransferQueue</code> — A <code>BlockingQueue</code> in which producers may wait for consumers to receive elements<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TransferQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><code>void transfer(E e)</code> — transfers the specified element immediately if there exists a consumer already waiting, else waits until the element is received by a consumer</li> <li><code>boolean tryTransfer(E e)</code></li> <li><code>boolean tryTransfer(E e, long timeout, TimeUnit unit)</code></li></ul></li> <li>inaccurate <code>size()</code> — <code>size()</code> is O(n) and maybe inaccurate, due to non-data nodes and concurrency</li> <li>atomicity for bulk operations — bulk operations <code>addAll</code>, <code>removeAll</code>, <code>retainAll</code>, <code>containsAll</code>, <code>equals</code>, and <code>toArray</code> are not guaranteed to be performed atomically</li> <li>implementation — dual queues with slack, see javadoc in source code</li> <li>comparison with <code>SynchronousQueue</code> — <code>LinkedTransferQueue</code> is more fast??, and
<blockquote><p>Capability-wise, <code>LinkedTransferQueue</code> is actually a superset of <code>ConcurrentLinkedQueue</code>, <code>SynchronousQueue</code> (in “fair” mode), and unbounded <code>LinkedBlockingQueue</code>.<br>
—— Doug Lea</p></blockquote></li></ul></li> <li><p><a href="https://lmax-exchange.github.io/disruptor/" target="_blank" rel="noopener noreferrer">Disruptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> — ring buffer, lock free, tbd</p> <ul><li><a href="https://github.com/LMAX-Exchange/disruptor" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ol> <h3 id="Concurrent-Collections"><a href="#Concurrent-Collections" class="header-anchor">#</a> Concurrent Collections</h3> <ol><li><p>concurrent collections</p> <ul><li>generally non-blocking algorithm</li> <li>some are non-null</li> <li>inaccurate <code>size()</code> — <code>size()</code> is O(n) and maybe inaccurate, due to non-data nodes and concurrency</li> <li>atomicity for bulk operations — bulk operations <code>addAll</code>, <code>removeAll</code>, <code>retainAll</code>, <code>containsAll</code>, <code>equals</code>, and <code>toArray</code> are not guaranteed to be performed atomically</li> <li>iterators are weakly consistent — may or may not reflect all modifications after construction, but will not return a value twice</li></ul></li> <li><p><code>java.util.concurrent.ConcurrentLinkedQueue</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div><ul><li><a href="http://www.cs.rochester.edu/~scott/papers/1996_PODC_queues.pdf" target="_blank" rel="noopener noreferrer">Simple, Fast, and Practical Non-Blocking and Blocking Concurrent Queue Algorithms<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>implementation — <code>VarHandle::compareAndSet</code></li></ul></li> <li><p><code>java.util.concurrent.ConcurrentLinkedDeque</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentLinkedDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCollection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div></li> <li><p><code>java.util.concurrent.ConcurrentSkipListSet</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentSkipListSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">NavigableSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div></li> <li><p><code>java.util.concurrent.ConcurrentSkipListMap</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentSkipListMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">ConcurrentNavigableMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div><ul><li>implementation — <code>VarHandle::compareAndSet</code></li></ul></li> <li><p><code>java.util.concurrent.ConcurrentHashMap</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div><ul><li>fully interoperable with <code>Hashtable</code></li> <li><code>concurrencyLevel</code> — the estimated number of concurrently updating threads, defaults to 16, other write threads will be blocked if the number exceeded</li> <li><code>long mappingCount()</code> — used in lieu of <code>size()</code> for <code>long</code>; an estimate, the actual count may differ if there are concurrent insertions or removals</li> <li>atomicity
<ul><li>value non-null — <code>null</code> is for absent; if also for value, incompatible with the operation that use <code>synchronized</code> on the old value</li> <li>put — <code>synchronized</code> on the old value, CAS if <code>null</code></li> <li>replace — <code>synchronized</code> on the old value</li> <li>lambda — <code>synchronized</code> on the old value, if <code>null</code>, CAS put a dummy value and <code>synchronized</code> on the dummy value, compute lambda, set computed value, then exit</li> <li>use <code>ConcurrentHashMap&lt;String, LongAdder&gt;</code> with <code>putIfAbsent</code><div class="language-java extra-class"><pre class="language-java"><code>map<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> k <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// better</span>
</code></pre></div></li></ul></li> <li><code>parallelismThreshold</code> parameter of bulk operations — if the map contains more elements than the threshold, the bulk operation is parallelized, fully utilize the <code>ForkJoinPool.commonPool()</code> if set to 1</li> <li><code>java.util.concurrent.ConcurrentMap</code><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li>concurrent set views
<ul><li><code>ConcurrentHashMap.KeySetView&lt;K,V&gt; keySet()</code><br> <code>ConcurrentHashMap.KeySetView&lt;K,V&gt; keySet(V mappedValue)</code></li> <li><code>static &lt;K&gt; ConcurrentHashMap.KeySetView&lt;K,Boolean&gt; newKeySet()</code><br> <code>static &lt;K&gt; ConcurrentHashMap.KeySetView&lt;K,Boolean&gt; newKeySet(int initialCapacity)</code></li></ul></li></ul></li></ol> <h3 id="Copy-on-Write-Collections"><a href="#Copy-on-Write-Collections" class="header-anchor">#</a> Copy on Write Collections</h3> <ol><li><p><code>java.util.concurrent.CopyOnWriteArrayList</code> — all mutative operations (add, set, and so on) are implemented by making a fresh copy of the underlying array, <code>synchronized</code> on a private field</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Object</span>
<span class="token keyword">implements</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">RandomAccess</span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div><ul><li>tradeoff — efficient when traversal operations vastly outnumber mutations, and is useful when you cannot or don't want to synchronize traversals
<ul><li>comparison to synchronized view — when frequent mutation is needed, synchronized view of <code>ArrayList</code> can outperform a <code>CopyOnWriteArrayList</code></li></ul></li> <li>snapshot iterator — iterator method uses a reference to the state of the array at the point that the iterator was created</li> <li>thread-safe — memory consistency</li></ul></li> <li><p><code>java.util.concurrent.CopyOnWriteArraySet</code> — a <code>Set</code> that uses an internal <code>CopyOnWriteArrayList</code> for all of its operations</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CopyOnWriteArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">implements</span> <span class="token class-name">Serializable</span>
</code></pre></div></li></ol> <h2 id="Callable-and-Future"><a href="#Callable-and-Future" class="header-anchor">#</a> Callable and Future</h2> <ol><li><p><code>java.util.concurrent.Callable</code> — <code>Runnable</code> that can return a result and throw a checked exception</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token class-name">V</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>Executors::callable</code> — methods for converting to <code>Callable</code></li></ul></li> <li><p><code>java.util.concurrent.Future</code> — result-bearing action that can be cancelled</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><code>V get()</code> — block until finish or exception
<ul><li>throws <code>InterruptedException</code>, <code>ExecutionException</code></li></ul></li> <li><code>V get(long timeout, TimeUnit unit)</code> — <code>TimeoutException</code> when timeout</li> <li><code>boolean cancel(boolean mayInterruptIfRunning)</code></li> <li><code>boolean isCancelled()</code></li> <li><code>boolean isDone()</code></li></ul></li> <li><p><code>java.util.concurrent.ScheduledFuture</code> — delayed <code>Future</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">extends</span> <span class="token class-name">Delayed</span><span class="token punctuation">,</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p><code>java.util.concurrent.FutureTask</code> — A cancellable asynchronous computation, or wrapper for <code>Callable</code> or <code>Runnable</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Object</span>
<span class="token keyword">implements</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><code>java.util.concurrent.RunnableFuture</code><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">extends</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li>constructors
<ul><li><code>FutureTask(Callable&lt;V&gt; callable)</code></li> <li><code>FutureTask(Runnable runnable, V result)</code></li></ul></li></ul></li> <li><p><code>java.util.concurrent.ForkJoinTask</code> — see <a href="#Fork-Join">Fork-Join</a></p></li> <li><p><code>java.util.concurrent.CompletableFuture</code> — A <code>Future</code> that may be explicitly completed (setting its value and status), and may be used as a <code>CompletionStage</code>, supporting dependent functions and actions that trigger upon its completion (<code>Promise.then</code> in JS), can be async</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Object</span>
<span class="token keyword">implements</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><code>async</code> suffixed methods — use <code>ForkJoinPool.commonPool</code>, or the <code>Executor</code> argument, all generated asynchronous tasks are instances of the marker interface <code>CompletableFuture.AsynchronousCompletionTask</code></li> <li>non-<code>async</code> methods — actions performed by the thread that completes the current <code>CompletableFuture</code>, or by any other caller of a completion method</li> <li>static methods
<ul><li><code>static CompletableFuture&lt;Void&gt; allOf(CompletableFuture&lt;?&gt;... cfs)</code></li> <li><code>static CompletableFuture&lt;Object&gt; anyOf(CompletableFuture&lt;?&gt;... cfs)</code></li> <li><code>static &lt;U&gt; CompletableFuture&lt;U&gt; completedFuture(U value)</code> — <code>Promise.resolve</code></li> <li><code>static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier)</code></li></ul></li> <li>explicitly complete
<ul><li><code>boolean cancel(boolean mayInterruptIfRunning)</code></li> <li><code>boolean complete(T value)</code></li> <li><code>boolean completeExceptionally(Throwable ex)</code></li> <li><code>void obtrudeException(Throwable ex)</code></li> <li><code>void obtrudeValue(T value)</code></li></ul></li> <li><code>Promise.prototype.then</code> <ul><li><code>CompletableFuture&lt;Void&gt; thenAccept(Consumer&lt;? super T&gt; action)</code> <ul><li><code>acceptEither</code></li> <li><code>thenAcceptBoth</code></li></ul></li> <li><code>&lt;U&gt; CompletableFuture&lt;U&gt; thenApply(Function&lt;? super T,? extends U&gt; fn)</code> <ul><li><code>applyToEither</code></li></ul></li> <li><code>CompletableFuture&lt;Void&gt; thenRun(Runnable action)</code> <ul><li><code>runAfterBoth</code></li> <li><code>runAfterEither</code></li></ul></li> <li><code>&lt;U,V&gt; CompletableFuture&lt;V&gt; thenCombine(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? super T,? super U,? extends V&gt; fn)</code></li> <li><code>&lt;U&gt; CompletableFuture&lt;U&gt; thenCompose(Function&lt;? super T,? extends CompletionStage&lt;U&gt;&gt; fn)</code></li></ul></li> <li><code>Promise.prototype.catch</code> <ul><li><code>CompletableFuture&lt;T&gt; exceptionally(Function&lt;Throwable,? extends T&gt; fn)</code></li></ul></li> <li><code>catch</code> and <code>then</code> <ul><li><code>&lt;U&gt; CompletableFuture&lt;U&gt; handle(BiFunction&lt;? super T,Throwable,? extends U&gt; fn)</code></li> <li><code>CompletableFuture&lt;T&gt; whenComplete(BiConsumer&lt;? super T,? super Throwable&gt; action)</code></li></ul></li> <li>get
<ul><li><code>T get()</code></li> <li><code>T get(long timeout, TimeUnit unit)</code></li> <li><code>T getNow(T valueIfAbsent)</code></li> <li><code>T join()</code></li></ul></li> <li>manage
<ul><li><code>int getNumberOfDependents()</code> — estimated</li> <li><code>boolean isCancelled()</code></li> <li><code>boolean isCompletedExceptionally()</code></li> <li><code>boolean isDone()</code></li></ul></li> <li>more</li></ul></li></ol> <h2 id="Executors"><a href="#Executors" class="header-anchor">#</a> Executors</h2> <ol><li><p>thread pool</p> <ul><li>constructing a new thread is expensive</li> <li>throttle the number of concurrent threads — huge number of threads can greatly degrade performance and even crash the virtual machine</li></ul></li> <li><p><code>java.util.concurrent.Executor</code> — decoupling task submission from the mechanics of how each task will be run</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Executor</span>
</code></pre></div><ul><li><code>void execute(Runnable command)</code></li></ul></li> <li><p><code>java.util.concurrent.ExecutorService</code> — <code>Executor</code> with methods to manage termination and produce <code>Future</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ExecutorService</span> <span class="token keyword">extends</span> <span class="token class-name">Executor</span>
</code></pre></div><ul><li><code>&lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task)</code><br> <code>Future&lt;?&gt; submit(Runnable task)</code><br> <code>&lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result)</code></li> <li><code>boolean awaitTermination(long timeout, TimeUnit unit)</code></li> <li><code>invokeAll</code>, <code>invokeAny</code>, with timeout version
<ul><li><code>&lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</code><br> <code>&lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit)</code></li> <li><code>&lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</code><br> <code>&lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit)</code></li></ul></li> <li><code>void shutdown()</code><br> <code>List&lt;Runnable&gt; shutdownNow()</code></li> <li><code>java.util.concurrent.AbstractExecutorService</code> — default implementations of <code>ExecutorService</code> execution methods<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractExecutorService</span> <span class="token keyword">extends</span> <span class="token class-name">Object</span>
<span class="token keyword">implements</span> <span class="token class-name">ExecutorService</span>
</code></pre></div></li></ul></li> <li><p><code>java.util.concurrent.ExecutorCompletionService</code> — lightweight blocking queue that decouples the production of new asynchronous tasks from the consumption of the results of completed tasks</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExecutorCompletionService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Object</span>
<span class="token keyword">implements</span> <span class="token class-name">CompletionService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CompletionService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>constructors
<ul><li><code>ExecutorCompletionService(Executor executor)</code></li> <li><code>ExecutorCompletionService(Executor executor, BlockingQueue&lt;Future&lt;V&gt;&gt; completionQueue)</code></li></ul></li> <li><code>Future&lt;V&gt; poll()</code> — <code>null</code> if none are present<br> <code>Future&lt;V&gt; poll(long timeout, TimeUnit unit)</code></li> <li><code>Future&lt;V&gt; submit(Callable&lt;V&gt; task)</code><br> <code>Future&lt;V&gt; submit(Runnable task, V result)</code></li> <li><code>Future&lt;V&gt; take()</code> — wait if none are present</li></ul></li> <li><p><code>java.util.concurrent.ScheduledExecutorService</code> — <code>ExecutorService</code> that can schedule commands to run after a given delay, or to execute periodically</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ScheduledExecutorService</span> <span class="token keyword">extends</span> <span class="token class-name">ExecutorService</span>
</code></pre></div><ul><li><code>&lt;V&gt; ScheduledFuture&lt;V&gt; schedule(Callable&lt;V&gt; callable, long delay, TimeUnit unit)</code></li> <li><code>ScheduledFuture&lt;?&gt; schedule(Runnable command, long delay, TimeUnit unit)</code></li> <li><code>ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command, long initialDelay, long period, TimeUnit unit)</code></li> <li><code>ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command, long initialDelay, long delay, TimeUnit unit)</code></li></ul></li> <li><p><code>java.util.concurrent.ThreadPoolExecutor</code> — <code>ExecutorService</code> that executes each submitted task using one of possibly several pooled threads</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractExecutorService</span>
</code></pre></div><ul><li>creation
<ul><li><code>Executors</code> — returned by <code>Executors::newCachedThreadPool</code>, <code>Executors::newFixedThreadPool</code>, <code>Executors::newSingleThreadExecutor</code></li> <li>constructor parameters
<ul><li><code>int corePoolSize</code> — the number of threads to keep in the pool, even if they are idle, unless <code>ThreadPoolExecutor::allowCoreThreadTimeOut</code> with <code>true</code></li> <li><code>int maximumPoolSize</code></li> <li><code>long keepAliveTime</code>, <code>TimeUnit unit</code> — the maximum time that excess idle threads will wait for new tasks before terminating</li> <li><code>BlockingQueue&lt;Runnable&gt; workQueue</code> — the queue to queue tasks if no idle core thread</li> <li><code>ThreadFactory threadFactory</code> — optional, defaults to <code>Executors::defaultThreadFactory</code></li> <li><code>RejectedExecutionHandler</code> — optional, defaults to <code>AbortPolicy</code></li></ul></li></ul></li> <li><code>RejectedExecutionHandler</code> — reject policies when task queue overflow, as static inner classes, defaults to <code>AbortPolicy</code> <ul><li><code>ThreadPoolExecutor.AbortPolicy</code> — throw <code>RejectedExecutionException</code></li> <li><code>ThreadPoolExecutor.CallerRunsPolicy</code></li> <li><code>ThreadPoolExecutor.DiscardOldestPolicy</code></li> <li><code>ThreadPoolExecutor.DiscardPolicy</code></li></ul></li> <li>more</li></ul></li> <li><p><code>java.util.concurrent.ScheduledThreadPoolExecutor</code> — <code>ThreadPoolExecutor</code> that can additionally schedule commands to run after a given delay, or to execute periodically, preferable to <code>java.util.Timer</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledThreadPoolExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolExecutor</span>
<span class="token keyword">implements</span> <span class="token class-name">ScheduledExecutorService</span>
</code></pre></div><ul><li>creation
<ul><li><code>Executors</code> — returned by <code>Executors::newScheduledThreadPool</code>, <code>Executors::newSingleThreadScheduledExecutor</code></li> <li>inherited constructors, also constructors with more optional parameters<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span>
          DEFAULT_KEEPALIVE_MILLIS<span class="token punctuation">,</span> MILLISECONDS<span class="token punctuation">,</span> <span class="token comment">// 10 ms</span>
          <span class="token keyword">new</span> <span class="token class-name">DelayedWorkQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// inner static class, like DelayQueue,</span>
          <span class="token comment">// but element type is an inner class called ScheduledFutureTask</span>
          <span class="token comment">// and every ScheduledFutureTask also records its index in the</span>
          <span class="token comment">// backing array to speed up cancellation and removal</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ul></li> <li><p><code>java.util.concurrent.ForkJoinPool</code> — see <a href="#Fork-Join">Fork-Join</a></p></li> <li><p><code>java.util.concurrent.Executors</code> — factory and utility methods</p> <ul><li>thread pools
<ul><li><code>static ExecutorService newCachedThreadPool()</code> — new threads are created as needed; idle threads are kept for 60 seconds, queue is <code>SynchronousQueue</code><br> <code>static ExecutorService newCachedThreadPool(ThreadFactory threadFactory)</code></li> <li><code>static ExecutorService newFixedThreadPool(int nThreads)</code> — contains a fixed set of threads; tasks kept in a <code>LinkedBlockingQueue</code> when overloaded
<code>static ExecutorService newFixedThreadPool(int nThreads, ThreadFactory threadFactory)</code></li> <li><code>static ScheduledExecutorService newScheduledThreadPool(int corePoolSize)</code> — fixed-thread pool for scheduled execution; a replacement for <code>java.util.Timer</code><br> <code>static ScheduledExecutorService newScheduledThreadPool(int corePoolSize, ThreadFactory threadFactory)</code></li> <li><code>static ExecutorService newSingleThreadExecutor()</code> — a “pool” with a single thread that executes the submitted tasks sequentially, queue is <code>LinkedBlockingQueue</code><br> <code>static ExecutorService newSingleThreadExecutor(ThreadFactory threadFactory)</code></li> <li><code>static ScheduledExecutorService newSingleThreadScheduledExecutor()</code> — scheduled version of <code>newSingleThreadExecutor</code> <code>static ScheduledExecutorService newSingleThreadScheduledExecutor(ThreadFactory threadFactory)</code></li> <li><code>static ExecutorService newWorkStealingPool()</code>-- <code>ForkJoinPool</code><br> <code>static ExecutorService newWorkStealingPool(int parallelism)</code></li> <li><code>java.util.concurrent.ThreadFactory</code><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ThreadFactory</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li>methods for conversion to <code>Callable</code> — from <code>Runnable</code>, <code>PrivilegedAction</code>, <code>PrivilegedExceptionAction</code></li> <li>more</li></ul></li></ol> <h3 id="Fork-Join"><a href="#Fork-Join" class="header-anchor">#</a> Fork-Join</h3> <ol><li><p>fork-join framework</p> <ul><li>work stealing
<ul><li>task queue — each thread has a deque for tasks, and pushes subtasks onto the head, LIFO</li> <li>work stealing — when a worker thread is idle, it “steals” a task from the tail of another deque
<ul><li>stealing is rare — since large subtasks are at the tail, such stealing is rare</li> <li>stealing is expensive — context switch between threads, even between CPUs if not the same core</li> <li>only steal from adjacent thread to mitigate contention</li></ul></li> <li><code>ForkJoinPool</code> exploits work stealing — efficient for recursive tasks, and event-style tasks (especially <code>asyncMode</code> for the latter)</li></ul></li> <li>use and limitations
<ul><li>suitable for high volume — huge numbers of tasks and subtasks may be hosted by a small number of actual threads in a <code>ForkJoinPool</code>. The pool attempts to maintain enough active (or available) threads by dynamically adding, suspending, or resuming internal worker threads, even if some tasks are stalled waiting to join others</li> <li>no side effect — main use as computational tasks calculating pure functions or operating on purely isolated objects</li> <li>avoid <code>synchronized</code> methods or blocks — should minimize other blocking synchronization apart from joining other tasks or using synchronizers. Subdividable tasks should also not perform blocking I/O, and should ideally access variables that are completely independent of those accessed by other running tasks</li> <li>define and use <code>ForkJoinTasks</code> that may block — three further considerations
<ul><li>independent — completion of few other tasks should be dependent on a task that blocks on external synchronization or I/O</li> <li>small blocking tasks — to minimize resource impact, tasks should be small; ideally performing only the (possibly) blocking action</li> <li>ensure progress — ensure the number of possibly blocked tasks fewer than <code>ForkJoinPool.getParallelism()</code>, or use <code>ForkJoinPool.ManagedBlocker</code></li></ul></li> <li>loosely enforced guideline — by not permitting checked exceptions such as <code>IOException</code> to be thrown</li> <li>like a call (fork) and return (join) from a parallel recursive function — <code>a.fork(); b.fork(); b.join(); a.join();</code> is likely to be substantially more efficient than <code>a.join(); b.join()</code></li> <li>task size rule of thumb — a task should perform more than 100 and less than 10000 basic computational steps</li></ul></li> <li>dependency
<ul><li>who fork who join — parent thread must join all its forks</li> <li>unordered join — forks from the same parent thread can be joined in arbitrary order</li> <li>join all before being joined — a thread can be joined only when all its forks joined</li></ul></li></ul></li> <li><p><code>java.util.concurrent.ForkJoinTask</code> — tasks that run within a <code>ForkJoinPool</code>, a thread-like entity but much lighter, lightweight form of <code>Future</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Object</span>
<span class="token keyword">implements</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
</code></pre></div><ul><li>constructors (adaptors)
<ul><li><code>static &lt;T&gt; ForkJoinTask&lt;T&gt; adapt(Callable&lt;? extends T&gt; callable)</code></li> <li><code>static ForkJoinTask&lt;?&gt; adapt(Runnable runnable)</code></li> <li><code>static &lt;T&gt; ForkJoinTask&lt;T&gt; adapt(Runnable runnable, T result)</code></li></ul></li> <li>exceptions — may still encounter unchecked exceptions, which are rethrown to callers join them
<ul><li><code>java.util.concurrent.RejectedExecutionException</code> — internal resource exhaustion</li></ul></li> <li>awaiting completion and extracting results
<ul><li><code>ForkJoinTask&lt;V&gt; fork()</code> — Arranges to asynchronously execute this task in the pool the current task is running in, if applicable, or using the <code>ForkJoinPool.commonPool()</code> if not <code>inForkJoinPool()</code>.</li> <li><code>V join()</code> — Returns the result of the computation when it is done</li> <li>inherited <code>Future::get</code>, but throws checked exception</li> <li><code>V invoke()</code> — semantically equivalent to <code>fork(); join()</code> but always attempts to begin execution in the current thread</li> <li><code>invokeAll</code> <ul><li><code>static &lt;T extends ForkJoinTask&lt;?&gt;&gt; Collection&lt;T&gt; invokeAll(Collection&lt;T&gt; tasks)</code> — forking a set of tasks and joining them all</li> <li><code>static void invokeAll(ForkJoinTask&lt;?&gt;... tasks)</code></li> <li><code>static void invokeAll(ForkJoinTask&lt;?&gt; t1, ForkJoinTask&lt;?&gt; t2)</code></li></ul></li> <li>quietly — do not extract results or report exceptions, useful when expecting delayed processing of results or exceptions until all complete
<ul><li><code>void quietlyComplete()</code></li> <li><code>void quietlyInvoke()</code></li> <li><code>void quietlyJoin()</code></li></ul></li></ul></li> <li>execution status
<ul><li><code>boolean isCancelled()</code> — in which case <code>getException()</code> returns a <code>CancellationException</code></li> <li><code>boolean isCompletedAbnormally()</code></li> <li><code>boolean isCompletedNormally()</code></li> <li><code>boolean isDone()</code> — normally, abnormally or cancelled</li></ul></li> <li>manage circular dependency
<ul><li><code>void complete(V value)</code><br> <code>void completeExceptionally(Throwable ex)</code></li> <li><code>static void helpQuiesce()</code> — Possibly executes tasks until the pool hosting the current task is quiescent.</li></ul></li> <li>extending — extend one of the abstract classes that support a particular style of fork/join processing, defines a <code>compute</code> method that somehow uses the control methods supplied by this base class
<ul><li>tags — for use of specialized subclasses</li> <li>base <code>final</code> support methods — should minimally implement protected methods</li> <li><code>java.util.concurrent.RecursiveAction</code> — a recursive no return value <code>ForkJoinTask</code><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">RecursiveAction</span> <span class="token keyword">extends</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><code>java.util.concurrent.RecursiveTask</code> — A recursive result-bearing <code>ForkJoinTask</code><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">RecursiveTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><code>java.util.concurrent.CountedCompleter</code> — completed actions trigger other actions<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CountedCompleter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>tbd</li></ul></li></ul></li></ul></li> <li><p><code>java.util.concurrent.ForkJoinPool</code> — provides the entry point for submissions from non-<code>ForkJoinTask</code> clients, as well as management and monitoring operations, queue is a internal class based on array</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ForkJoinPool</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractExecutorService</span>
</code></pre></div><ul><li><code>static ForkJoinPool commonPool()</code> — used by any <code>ForkJoinTask</code> that is not explicitly submitted to a specified pool, threads are slowly reclaimed during periods of non-use, and reinstated upon subsequent use</li> <li><code>static void managedBlock(ForkJoinPool.ManagedBlocker blocker)</code></li> <li><code>ForkJoinPool.ManagedBlocker</code><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">interface</span> <span class="token class-name">ManagedBlocker</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isReleasable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ol> <h2 id="Synchronizers"><a href="#Synchronizers" class="header-anchor">#</a> Synchronizers</h2> <ol><li><p>Memory consistency effects — happen-before, see <a href="#volatile-and-Atomics">volatile</a></p></li> <li><p><code>java.util.concurrent.locks.AbstractQueuedSynchronizer</code> — tbd
</p> <ul><li><code>AbstractQueuedSynchronizer::compareAndSetState</code> — uses <code>VarHandle::compareAndSet</code></li> <li>CLH lock queue — the thread appends itself to the waiting queue and spins on the variable that can be updated only by the thread preceding it in the queue
<ul><li>Java uses CLH locks for blocking synchronizers, see javadoc of <code>AbstractQueuedSynchronizer.Node</code></li></ul></li></ul></li> <li><p><code>java.util.concurrent.locks.LockSupport</code> — basic thread blocking primitives for creating locks and other synchronization classes</p> <ul><li>underlying — <code>jdk.internal.misc.Unsafe::park</code>, <code>Unsafe::unpark</code></li> <li><code>static void park(Object blocker)</code> — park current thread, wrapped by set and unset <code>Thread.parkBlocker</code></li> <li><code>static void unpark(Thread thread)</code></li></ul></li> <li><p><code>java.util.concurrent.Exchanger</code> — allows two threads to exchange objects when both are ready for the exchange, a bidirectional form of a <code>SynchronousQueue</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Exchanger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><code>V exchange(V x)</code> — waits for another thread to arrive at this exchange point (unless the current thread is interrupted), and then transfers the given object to it, receiving its object in return</li> <li><code>V exchange(V x, long timeout, TimeUnit unit)</code></li> <li>underlying implementation — <code>VarHandle::compareAndSetState</code>, <code>LockSupport</code>, see javadoc in source code for dual data structures</li></ul></li></ol> <h3 id="Count-Synchronizers"><a href="#Count-Synchronizers" class="header-anchor">#</a> Count Synchronizers</h3> <ol><li><p><code>java.util.concurrent.Semaphore</code> — allows a set of threads to wait until permits are available for proceeding, often used to restrict the number of threads than can access some (physical or logical) resource</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Semaphore</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span>
</code></pre></div><ul><li>use
<ul><li>permit — a count, can be acquired or released, by any caller</li> <li>binary semaphore — mutex lock, but without ownership</li> <li>multiple permits methods — increased risk of indefinite postponement when used without fairness</li> <li>fairness — FIFO by the order of executing of specific internal points in <code>acquire</code> methods</li></ul></li> <li>constructors
<ul><li><code>Semaphore(int permits)</code></li> <li><code>Semaphore(int permits, boolean fair)</code></li></ul></li> <li>release — Releases a permit, returning it to the semaphore
<ul><li><code>void release()</code></li> <li><code>void release(int permits)</code></li></ul></li> <li>acquire — Acquires a permit from this semaphore, blocking until one is available, or the thread is interrupted
<ul><li><code>void acquire()</code></li> <li><code>void acquire(int permits)</code></li> <li><code>boolean tryAcquire()</code> — return immediately, regardless of fairness</li> <li><code>boolean tryAcquire(int permits)</code></li> <li><code>boolean tryAcquire(int permits, long timeout, TimeUnit unit)</code></li> <li><code>boolean tryAcquire(long timeout, TimeUnit unit)</code></li></ul></li> <li>underlying implementation — <code>AbstractQueuedSynchronizer</code></li></ul></li> <li><p><code>java.util.concurrent.CountDownLatch</code> — allows a set of threads to wait until a count has been decremented to 0, and the count cannot be increased</p> <ul><li>constructor — <code>CountDownLatch(int count)</code></li> <li><code>void await()</code> — causes the current thread to wait until the latch has counted down to zero and return immediately upon subsequent call, unless the thread is interrupted<br> <code>boolean await(long timeout, TimeUnit unit)</code></li> <li><code>void countDown()</code> — decrements the count of the latch, releasing all waiting threads if the count reaches zero</li> <li><code>long getCount()</code></li> <li>underlying implementation — <code>AbstractQueuedSynchronizer</code></li></ul></li> <li><p><code>java.util.concurrent.CyclicBarrier</code> — allows a set of threads to wait until a predefined count of them has reached a common barrier, and then optionally executes a barrier action, and the count is reset</p> <ul><li>all-or-none — if a thread leaves a barrier point prematurely and exceptionally, all other threads waiting at that barrier point will also leave abnormally via <code>BrokenBarrierException</code> (or <code>InterruptedException</code> if they too were interrupted at about the same time)</li> <li>constructors
<ul><li><code>CyclicBarrier(int parties)</code></li> <li><code>CyclicBarrier(int parties, Runnable barrierAction)</code></li></ul></li> <li><code>int await()</code> — waits until all parties have invoked <code>await</code> on this barrier, returns the arrival index of that thread at the barrier<br> <code>int await(long timeout, TimeUnit unit)</code></li> <li><code>int getNumberWaiting()</code></li> <li><code>int getParties()</code> — the number of parties required to trip this barrier</li> <li><code>boolean isBroken()</code> — Queries if this barrier is in a broken state</li> <li><code>void reset()</code></li> <li>underlying implementation — <code>ReentrantLock</code></li></ul></li> <li><p><code>java.util.concurrent.Phaser</code> — like a cyclic barrier, but faster??, with a mutable party count, and can have multiple phases with phase number cycling from 0 to <code>Integer.MAX_VALUE</code></p> <ul><li>constructors
<ul><li><code>Phaser()</code> — 0 parties, phase number 0</li> <li><code>Phaser(int parties)</code></li> <li><code>Phaser(Phaser parent)</code></li> <li><code>Phaser(Phaser parent, int parties)</code></li></ul></li> <li>registration — change number of parties
<ul><li><code>int register()</code> — adds a new unarrived party to this phaser</li> <li><code>int bulkRegister(int parties)</code> — adds the given number of new unarrived parties to this phaser</li></ul></li> <li>tree tiering — children automatically register with and deregister from their parents according to the their numbers of registered parties
<ul><li><code>Phaser getParent()</code> — returns the parent of this phaser, or <code>null</code> if none</li> <li><code>Phaser getRoot()</code> — returns the root ancestor of this phaser, which is the same as this phaser if it has no parent</li></ul></li> <li>arrive — when the final party for a given phase arrives, an optional <code>onAdvance</code> is performed and the phase advances (phase number +1)
<ul><li><code>int arrive()</code> — arrives at this phaser, without waiting for others to arrive</li> <li><code>int arriveAndAwaitAdvance()</code> — arrives at this phaser and awaits others</li> <li><code>int arriveAndDeregister()</code> — arrives at this phaser and deregisters from it without waiting for others to arrive</li></ul></li> <li>await — wait at a specific phase, returns when the phaser advances to (or is already at) a different phase
<ul><li><code>int awaitAdvance(int phase)</code> — awaits the phase of this phaser to advance from the given phase value, returning immediately if the current phase is not equal to the given phase value or this phaser is terminated</li> <li><code>int awaitAdvanceInterruptibly(int phase)</code></li> <li><code>int awaitAdvanceInterruptibly(int phase, long timeout, TimeUnit unit)</code></li></ul></li> <li>termination — triggered when <code>onAdvance</code> returns <code>true</code>; after termination, all synchronization methods immediately return a negative integer and registration takes no effect
<ul><li><code>void forceTermination()</code> — forces this phaser to enter termination state</li> <li><code>boolean isTerminated()</code> — returns true if this phaser has been terminated</li></ul></li> <li>monitoring
<ul><li><code>int getArrivedParties()</code> — returns the number of registered parties that have arrived at the current phase of this phaser</li> <li><code>int getPhase()</code> — returns the current phase number</li> <li><code>int getRegisteredParties()</code> — returns the number of parties registered at this phaser</li> <li><code>int getUnarrivedParties()</code> — returns the number of registered parties that have not yet arrived at the current phase of this phaser</li></ul></li> <li><code>protected boolean onAdvance(int phase, int registeredParties)</code> — overridable method to perform an action upon impending phase advance, and to control termination<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">return</span> registeredParties <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// default implementation</span>
</code></pre></div></li> <li>underlying implementation — <code>VarHandle::compareAndSetState</code>, <code>LockSupport</code></li></ul></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/tangentyh/notes-of-tan/edit/master/docs/backend/java/javaConcurrency.md" target="_blank" rel="noopener noreferrer">Edit This Page On GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/8/2020, 5:25:01 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notes-of-tan/backend/java/javaUtils.html" class="prev">
        Java Utils
      </a></span> <span class="next"><a href="/notes-of-tan/backend/java/javaIO.html">
        IO
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><div class="vuepress-eqn"></div><span class="vuepress-eq"></span></div></div>
    <script src="/notes-of-tan/assets/js/app.bd5566f0.js" defer></script><script src="/notes-of-tan/assets/js/2.33f31c9b.js" defer></script><script src="/notes-of-tan/assets/js/23.49e69635.js" defer></script>
  </body>
</html>
