(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{238:function(e,t,s){"use strict";s.r(t);var a=s(0),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"Redis"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Redis"}},[e._v("#")]),e._v(" Redis")]),e._v(" "),s("h2",{attrs:{id:"Introduction"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Introduction"}},[e._v("#")]),e._v(" Introduction")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("Redis — REmote DIctionary Server")])]),e._v(" "),s("li",[s("p",[e._v("docs")]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://redis.io/documentation",target:"_blank",rel:"noopener noreferrer"}},[e._v("Redis official"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/redis/redis",target:"_blank",rel:"noopener noreferrer"}},[e._v("Redis GitHub"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"https://docs.redislabs.com/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Redis Labs Documentation | Redis Labs Documentation Center"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"http://redisdoc.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Redis 命令参考 — Redis 命令参考"),s("OutboundLink")],1)]),e._v(" "),s("li",[e._v("books\n"),s("ul",[s("li",[s("a",{attrs:{href:"https://redislabs.com/ebooks",target:"_blank",rel:"noopener noreferrer"}},[e._v("e-Books - Redis"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"http://redisbook.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Redis 设计与实现 — Redis 设计与实现"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"http://redisinaction.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Redis实战 — Redis 实战"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"http://redisguide.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Redis使用手册"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"http://learnredis.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("《Redis入门与实战》 — LearnRedis.com 1.0 文档"),s("OutboundLink")],1)])])])])]),e._v(" "),s("li",[s("p",[e._v("online CLI — on redis.io, like "),s("a",{attrs:{href:"https://redis.io/commands/del",target:"_blank",rel:"noopener noreferrer"}},[e._v("DEL – Redis"),s("OutboundLink")],1)])]),e._v(" "),s("li",[s("p",[e._v("CLI")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("redis-server")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("redis-sentinel")])])])]),e._v(" "),s("li",[s("code",[e._v("redis-cli")]),e._v(" — "),s("a",{attrs:{href:"https://redis.io/topics/rediscli",target:"_blank",rel:"noopener noreferrer"}},[e._v("tbd"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("code",[e._v("redis-benchmark")]),e._v(" — "),s("a",{attrs:{href:"https://redis.io/topics/benchmarks",target:"_blank",rel:"noopener noreferrer"}},[e._v("tbd"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("code",[e._v("redis-trib")])])])])]),e._v(" "),s("h2",{attrs:{id:"Data-Types-And-Data-Structures"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Data-Types-And-Data-Structures"}},[e._v("#")]),e._v(" Data Types And Data Structures")]),e._v(" "),s("h3",{attrs:{id:"Data-Structures"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Data-Structures"}},[e._v("#")]),e._v(" Data Structures")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("string")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("c_str")]),e._v(" — used in string literal, like when "),s("code",[e._v("serverLog")])]),e._v(" "),s("li",[e._v("simple dynamic string, SDS — used as keys, "),s("code",[e._v("OBJ_STRING")]),e._v(", and buffers"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("sdshdr")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// old implementation")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" len"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// 记录 buf 数组中已使用字节的数量")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" free"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// 记录 buf 数组中未使用字节的数量")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("char")]),e._v(" buf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// c_str, '\\0' ended, which is not counted in len")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[e._v("capacity grow policy — if "),s("code",[e._v("len")]),e._v(" < 1 MB, "),s("code",[e._v("free")]),e._v(" = "),s("code",[e._v("len")]),e._v("; else, "),s("code",[e._v("free")]),e._v(" = 1 MB")]),e._v(" "),s("li",[e._v("lazy reclaim of "),s("code",[e._v("free")]),e._v(" — reclaim on demand")]),e._v(" "),s("li",[e._v("binary-safe — "),s("code",[e._v("len")]),e._v(" as end, instead of "),s("code",[e._v("'\\0'")]),e._v(" as end\n"),s("ul",[s("li",[s("code",[e._v("'\\0'")]),e._v(" as end — for C API reuse, partially supported")])])]),e._v(" "),s("li",[e._v("new version, simplified"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// also sdshdr8, sdshdr16, sdshdr64 for uint8_t, uint16_t, uint64_t")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("sdshdr32")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    uint32_t len"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* used, `\\0` not counted */")]),e._v("\n    uint32_t alloc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* excluding the header and null terminator */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// #define SDS_TYPE_8  1 ... #define SDS_TYPE_64 4")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("char")]),e._v(" flags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* 3 lsb of type, 5 unused bits */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("char")]),e._v(" buf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// c_str, '\\0' ended, which is not counted in len")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[e._v("max "),s("code",[e._v("alloc")]),e._v(" — 0.5 GB")])])])])])])]),e._v(" "),s("li",[s("p",[e._v("dictionary, hash table — used in "),s("code",[e._v("OBJ_HASH")]),e._v(" and database implementation, and more")]),e._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("dict")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    dictType "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// functions for a specific type")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("privdata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// parameter for functions in dictType")]),e._v("\n    dictht ht"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" rehashidx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* rehashing not in progress if rehashidx == -1 */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" iterators"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* number of iterators currently running */")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" dict"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[s("code",[e._v("dictType")]),e._v(" — "),s("code",[e._v("setDictType")]),e._v(", "),s("code",[e._v("zsetDictType")]),e._v(", "),s("code",[e._v("dbDictType")]),e._v(", etc. predefined in "),s("code",[e._v("server.c")]),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("dictType")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("uint64_t")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("hashFunction"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("keyDup"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("privdata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("valDup"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("privdata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("obj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("keyCompare"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("privdata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("key1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("key2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("keyDestructor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("privdata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("valDestructor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("privdata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("obj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" dictType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])])]),e._v(" "),s("li",[s("code",[e._v("dictht")]),e._v(" — dictionary hash table"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("dictht")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    dictEntry "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("table"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" size"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// capacity")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" sizemask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// size - 1")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" used"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" dictht"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[s("code",[e._v("dictEntry")]),e._v(" — key-value pair"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("dictEntry")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("union")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("val"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        uint64_t u64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        int64_t s64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("double")]),e._v(" d"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("dictEntry")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("next"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" dictEntry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])])]),e._v(" "),s("li",[e._v("hash value — "),s("code",[e._v("hashFunction(key) & sizemask")])]),e._v(" "),s("li",[e._v("hash collision — chaining with "),s("code",[e._v("*next")]),e._v(", new nodes added at head")])])]),e._v(" "),s("li",[e._v("rehash\n"),s("ul",[s("li",[e._v("expand — when not executing "),s("code",[e._v("BGSAVE")]),e._v(" or "),s("code",[e._v("BGREWRITEAOF")]),e._v(" and load factor >= 1, or when executing either one and load factor >= 5; expand to the size of the first 2^n that >= "),s("code",[e._v("ht[0].used * 2")])]),e._v(" "),s("li",[e._v("shrink — when load factor < 0.1; shrink to the size of the first 2^n that >= "),s("code",[e._v("ht[0].used")])]),e._v(" "),s("li",[e._v("progressive rehash — set "),s("code",[e._v("rehashidx")]),e._v(" to 0, and increment by 1 for every CRUD operation, reset to -1 when completed and swap "),s("code",[e._v("ht[0]")]),e._v(" and "),s("code",[e._v("ht[1]")])])])])])]),e._v(" "),s("li",[s("p",[e._v("skiplist — used in "),s("code",[e._v("OBJ_ZSET")])]),e._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("zskiplist")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("zskiplistNode")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("header"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("tail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" length"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" level"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" zskiplist"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[s("code",[e._v("zskiplistNode")]),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("zskiplistNode")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    sds ele"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("double")]),e._v(" score"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("zskiplistNode")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("backward"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("zskiplistLevel")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("zskiplistNode")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("forward"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" span"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// rank starting from 1")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" level"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" zskiplistNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[e._v("level — height generated between 1 to 32 according to power law")]),e._v(" "),s("li",[e._v("score — for sort, ascending, sort by "),s("code",[e._v("ele")]),e._v(" lexicographically when equality")])])])])]),e._v(" "),s("li",[s("p",[e._v("int set — encoding-adapting ordered distinct array, used in "),s("code",[e._v("OBJ_SET")]),e._v(" if the cardinality is low")]),e._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("intset")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    uint32_t encoding"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    uint32_t length"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    int8_t contents"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ordered")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" intset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[e._v("add element — O(N)\n"),s("ul",[s("li",[e._v("space saving — "),s("code",[e._v("contents")]),e._v(" is of the smallest encoding possible, upgrade and reallocate if necessary")]),e._v(" "),s("li",[e._v("upgrade — if one encoding not enough, upgrade encoding of "),s("code",[e._v("contents")]),e._v(" from "),s("code",[e._v("INTSET_ENC_INT16")]),e._v(" to "),s("code",[e._v("INTSET_ENC_INT32")]),e._v(" to "),s("code",[e._v("INTSET_ENC_INT64")]),e._v(", new element added at head or tail")])])])])]),e._v(" "),s("li",[s("p",[e._v("list — doubly linked list, used internally such as struct fields")]),e._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("listNode")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("listNode")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("prev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("listNode")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("next"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" listNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("list")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    listNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("head"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    listNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("tail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("dup"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("ptr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// duplication")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("free"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("ptr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("match"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("ptr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// comparison")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" len"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" list"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])])]),e._v(" "),s("li",[s("p",[e._v("ziplist — a sequential data structure that is continuous on memory ("),s("code",[e._v("unsigned char")]),e._v(" array), used in "),s("code",[e._v("OBJ_LIST")]),e._v(" and "),s("code",[e._v("OBJ_HASH")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("zlbytes zltail zllen [entries] zlend\n 4b       4b    2b              0xFF\n")])])]),s("ul",[s("li",[s("code",[e._v("zlbytes")]),e._v(" — total size")]),e._v(" "),s("li",[s("code",[e._v("zltail")]),e._v(" — offset between the start of the ziplist and the start of the last entry")]),e._v(" "),s("li",[s("code",[e._v("zllen")]),e._v(" — total entry count, can only hold within "),s("code",[e._v("UINT16_MAX")])]),e._v(" "),s("li",[s("code",[e._v("zlend")]),e._v(" — end mark")]),e._v(" "),s("li",[e._v("entry — a byte array or a number"),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("previous_entry_length encoding content\n")])])]),s("ul",[s("li",[s("code",[e._v("previous_entry_length")]),e._v(" — 1 byte when < "),s("code",[e._v("0xFE")]),e._v(" otherwise 5 byte starting with "),s("code",[e._v("0xFE")]),e._v(", for iterating")]),e._v(" "),s("li",[s("code",[e._v("encoding")]),e._v(" — type and length of "),s("code",[e._v("content")])]),e._v(" "),s("li",[e._v("operations like push an entry — O(N), the possibility of long cascade update is low, which needs consecutive entries of length between 250 to 253b\n"),s("ul",[s("li",[e._v("cascade update — "),s("code",[e._v("previous_entry_length")]),e._v(" of an entry updates from 1b to 5b, triggering the "),s("code",[e._v("previous_entry_length")]),e._v(" update of the next entry, O(N^2) in the worst case")])])])])])])]),e._v(" "),s("li",[s("p",[e._v("quicklist — doubly linked list of ziplists, used in "),s("code",[e._v("OBJ_LIST")]),e._v(", tbd")])]),e._v(" "),s("li",[s("p",[e._v("listpack — "),s("code",[e._v("unsigned char")]),e._v(" array like ziplist, designed to replace ziplist, currently only used in "),s("code",[e._v("OBJ_STREAM")]),e._v(", tbd")])]),e._v(" "),s("li",[s("p",[e._v("radix tree — used in "),s("code",[e._v("OBJ_STREAM")]),e._v(" and more, tbd")])]),e._v(" "),s("li",[s("p",[e._v("zipmap — String -> String Map data structure optimized for size")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('<zmlen><len>"foo"<len><free>"bar"<len>"hello"<len><free>"world"\n')])])])])]),e._v(" "),s("h3",{attrs:{id:"Data-Types"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Data-Types"}},[e._v("#")]),e._v(" Data Types")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("object — wrapper for data structures, with timestamp, with reference count for object sharing and GC")]),e._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[e._v("LRU_BITS "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("24")])])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("redisObject")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" type"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" encoding"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" lru"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v("LRU_BITS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* LRU time (relative to global lru_clock) or\n                            * LFU data (least significant 8 bits frequency\n                            * and most significant 16 bits access time). */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" refcount"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("ptr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" robj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[s("code",[e._v("type")]),e._v(" — "),s("code",[e._v("OBJ_STRING")]),e._v(", "),s("code",[e._v("OBJ_LIST")]),e._v(", "),s("code",[e._v("OBJ_SET")]),e._v(", "),s("code",[e._v("OBJ_ZSET")]),e._v(", "),s("code",[e._v("OBJ_HASH")]),e._v(", "),s("code",[e._v("OBJ_MODULE")]),e._v(", "),s("code",[e._v("OBJ_STREAM")])]),e._v(" "),s("li",[s("code",[e._v("encoding")]),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[e._v("OBJ_ENCODING_RAW "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("     ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Raw representation */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[e._v("OBJ_ENCODING_INT "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("     ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Encoded as integer */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[e._v("OBJ_ENCODING_HT "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("      ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Encoded as hash table */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[e._v("OBJ_ENCODING_ZIPMAP "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),e._v("  ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Encoded as zipmap */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[e._v("OBJ_ENCODING_LINKEDLIST "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("4")]),e._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* No longer used: old list encoding. */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[e._v("OBJ_ENCODING_ZIPLIST "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("5")]),e._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Encoded as ziplist */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[e._v("OBJ_ENCODING_INTSET "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("6")]),e._v("  ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Encoded as intset */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[e._v("OBJ_ENCODING_SKIPLIST "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("7")]),e._v("  ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Encoded as skiplist */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[e._v("OBJ_ENCODING_EMBSTR "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("8")]),e._v("  ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Embedded sds string encoding */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[e._v("OBJ_ENCODING_QUICKLIST "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("9")]),e._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Encoded as linked list of ziplists */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[e._v("OBJ_ENCODING_STREAM "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Encoded as a radix tree of listpacks */")])]),e._v("\n")])])])]),e._v(" "),s("li",[e._v("polymorphism — the same command works for different types and/or encodings")]),e._v(" "),s("li",[e._v("GC — reference counting")]),e._v(" "),s("li",[s("code",[e._v("lru")]),e._v(" — last accessed timestamp, see "),s("a",{attrs:{href:"#Other"}},[e._v("Other")])]),e._v(" "),s("li",[e._v("flyweight — for integers from 0 to 9999")]),e._v(" "),s("li",[e._v("empty collections — when add like "),s("code",[e._v("LPUSH")]),e._v(", an empty collection is prepared; empty collections will be garbage collected, except stream; read commands like "),s("code",[e._v("LLEN")]),e._v(" and some write commands on an empty key behave like an empty collection held on the key")]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("OBJECT subcommand [arguments [arguments ...]]")]),e._v(" — see "),s("code",[e._v("OBJECT HELP")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("OBJECT ENCODING")])]),e._v(" "),s("li",[s("code",[e._v("OBJECT REFCOUNT")])]),e._v(" "),s("li",[s("code",[e._v("OBJECT IDLETIME")])]),e._v(" "),s("li",[s("code",[e._v("OBJECT FREQ")]),e._v(" — available when "),s("code",[e._v("maxmemory-policy")]),e._v(" is set to an LFU policy")]),e._v(" "),s("li",[s("code",[e._v("DEBUG OBJECT")])])])]),e._v(" "),s("li",[s("code",[e._v("TYPE")])]),e._v(" "),s("li",[e._v("see "),s("a",{attrs:{href:"#Server-and-Client"}},[s("code",[e._v("redisDb")])])])])])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("OBJ_STRING")])]),e._v(" "),s("ul",[s("li",[e._v("corresponding "),s("code",[e._v("encoding")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("OBJ_ENCODING_INT")]),e._v(" — "),s("code",[e._v("long long")]),e._v(", for numbers within range")]),e._v(" "),s("li",[s("code",[e._v("OBJ_ENCODING_EMBSTR")]),e._v(" — an object where the sds string is actually an unmodifiable string allocated in the same chunk as the object itself, used when string length <= 44 bytes ("),s("code",[e._v("OBJ_ENCODING_EMBSTR_SIZE_LIMIT")]),e._v(") and when "),s("code",[e._v("long double")])]),e._v(" "),s("li",[s("code",[e._v("OBJ_ENCODING_RAW")]),e._v(" — SDS, used when string length > 44 bytes")])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[e._v("plain set and get\n"),s("ul",[s("li",[s("code",[e._v("SET key value [EX seconds|PX milliseconds|KEEPTTL] [NX|XX] [GET]")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("GETSET")])]),e._v(" "),s("li",[s("code",[e._v("SETEX")]),e._v(", "),s("code",[e._v("PSETEX")])]),e._v(" "),s("li",[s("code",[e._v("SETNX")])])])]),e._v(" "),s("li",[s("code",[e._v("MSET")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("MSETNX")]),e._v(" — no operation even if just one single key already exists")])])]),e._v(" "),s("li",[s("code",[e._v("GET")]),e._v(", "),s("code",[e._v("MGET")])])])]),e._v(" "),s("li",[s("code",[e._v("APPEND")]),e._v(" — amortized O(1)")]),e._v(" "),s("li",[s("code",[e._v("INCRBY")]),e._v(", "),s("code",[e._v("DECRBY")]),e._v(", "),s("code",[e._v("INCR")]),e._v(", "),s("code",[e._v("DECR")]),e._v(" — only for signed 64 bit, start with 0 if key does not exist\n"),s("ul",[s("li",[s("code",[e._v("INCRBYFLOAT")]),e._v(" — output precision fixed to 17 digits")])])]),e._v(" "),s("li",[s("code",[e._v("SETRANGE")]),e._v(", "),s("code",[e._v("GETRANGE")]),e._v(" — zero byte padded")]),e._v(" "),s("li",[s("code",[e._v("BITFIELD")]),e._v(" — capable of addressing specific integer fields of varying bit widths and arbitrary non (necessary) aligned offset")]),e._v(" "),s("li",[s("code",[e._v("STRLEN")])]),e._v(" "),s("li",[s("code",[e._v("STRALGO LCS")])])])])])]),e._v(" "),s("li",[s("p",[e._v("data structure with "),s("code",[e._v("redisObject.type")]),e._v(" of "),s("code",[e._v("OBJ_STRING")])]),e._v(" "),s("ul",[s("li",[e._v("bitmap\n"),s("ul",[s("li",[e._v("implementation — like "),s("code",[e._v("java.util.BitSet")]),e._v(", but one byte ("),s("code",[e._v("char")]),e._v(") each word")]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("SETBIT")])]),e._v(" "),s("li",[s("code",[e._v("GETBIT")])]),e._v(" "),s("li",[s("code",[e._v("BITCOUNT")])]),e._v(" "),s("li",[s("code",[e._v("BITOP")]),e._v(" — "),s("code",[e._v("AND")]),e._v(", "),s("code",[e._v("OR")]),e._v(", "),s("code",[e._v("XOR")]),e._v(" and "),s("code",[e._v("NOT")])]),e._v(" "),s("li",[s("code",[e._v("BITPOS")]),e._v(" — return the position of the first bit set to 1 or 0 in a string")])])])])]),e._v(" "),s("li",[e._v("HyperLogLog — probabilistic, count unique elements like a set, memory footprint of 12KB in worst case, standard error of 0.81%\n"),s("ul",[s("li",[e._v("implementation — "),s("a",{attrs:{href:"https://en.wikipedia.org/wiki/HyperLogLog",target:"_blank",rel:"noopener noreferrer"}},[e._v("HyperLogLog - Wikipedia"),s("OutboundLink")],1),e._v(", "),s("a",{attrs:{href:"https://github.com/redis/redis/blob/c1aaad06d85c89ab7abebd5cefab026bdcb086ab/src/hyperloglog.c#L37-L180",target:"_blank",rel:"noopener noreferrer"}},[s("code",[e._v("hyperloglog.c")]),s("OutboundLink")],1),e._v(", "),s("a",{attrs:{href:"https://redis.io/commands/pfcount#hyperloglog-representation",target:"_blank",rel:"noopener noreferrer"}},[e._v("redis.io"),s("OutboundLink")],1),e._v(" "),s("ul",[s("li",[e._v("sparse representation")]),e._v(" "),s("li",[e._v("dense representation")]),e._v(" "),s("li",[s("code",[e._v("PFCOUNT")]),e._v(" cache — last 8 bytes encode the latest computed cardinality for caching purposes")])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("PFADD")])]),e._v(" "),s("li",[s("code",[e._v("PFCOUNT")]),e._v(" — slow if merge")]),e._v(" "),s("li",[s("code",[e._v("PFMERGE")])])])])])])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("OBJ_LIST")])]),e._v(" "),s("ul",[s("li",[e._v("corresponding "),s("code",[e._v("encoding")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("OBJ_ENCODING_ZIPLIST")]),e._v(" — when each element size < 64 bytes and list size < 512, "),s("code",[e._v("list-max-ziplist-value")]),e._v(" and "),s("code",[e._v("list-max-ziplist-entries")]),e._v(" in configurations")]),e._v(" "),s("li",[s("code",[e._v("OBJ_ENCODING_QUICKLIST")]),e._v(" — "),s("code",[e._v("list-max-ziplist-size")]),e._v(", "),s("code",[e._v("list-compress-depth")]),e._v(" in configurations")])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("LPUSH")]),e._v(", "),s("code",[e._v("RPUSH")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("LPUSHX")]),e._v(", "),s("code",[e._v("RPUSHX")]),e._v(" — no operation if key does not exist")])])]),e._v(" "),s("li",[s("code",[e._v("LPOP")]),e._v(", "),s("code",[e._v("RPOP")]),e._v(" — "),s("code",[e._v("null")]),e._v(" when empty\n"),s("ul",[s("li",[s("code",[e._v("BRPOP")]),e._v(", "),s("code",[e._v("BLPOP")]),e._v(" — block with timeout (infinitely if "),s("code",[e._v("0")]),e._v(") when all keys are empty, first come first serve for clients")])])]),e._v(" "),s("li",[s("code",[e._v("LSET")])]),e._v(" "),s("li",[e._v("get\n"),s("ul",[s("li",[s("code",[e._v("LINDEX")]),e._v(" — get by index")]),e._v(" "),s("li",[s("code",[e._v("LRANGE")]),e._v(" — inclusive, support "),s("code",[e._v("-1")])])])]),e._v(" "),s("li",[s("code",[e._v("LLEN")])]),e._v(" "),s("li",[e._v("find\n"),s("ul",[s("li",[s("code",[e._v("LINSERT")]),e._v(" — find and insert")]),e._v(" "),s("li",[s("code",[e._v("LPOS")]),e._v(" — find")]),e._v(" "),s("li",[s("code",[e._v("LREM")])])])]),e._v(" "),s("li",[s("code",[e._v("LTRIM key start stop")])]),e._v(" "),s("li",[s("code",[e._v("LMOVE source destination LEFT|RIGHT LEFT|RIGHT")]),e._v(" — since 6.2.0, can be used for reliable queue and circular list\n"),s("ul",[s("li",[s("code",[e._v("BLMOVE")])]),e._v(" "),s("li",[s("code",[e._v("RPOPLPUSH")]),e._v(", "),s("code",[e._v("BRPOPLPUSH")])])])])])])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("OBJ_HASH")])]),e._v(" "),s("ul",[s("li",[e._v("corresponding "),s("code",[e._v("encoding")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("OBJ_ENCODING_ZIPLIST")]),e._v(" — when all keys and values < 64 bytes, and list size < 512, "),s("code",[e._v("hash-max-ziplist-value")]),e._v(" and "),s("code",[e._v("hash-max-ziplist-entries")]),e._v(" in configurations\n"),s("ul",[s("li",[e._v("difference with top level keystore — use more small hashes with fields in lieu of keys to save memory, but no functions like "),s("code",[e._v("EXPIRE")]),e._v(" for fields")])])]),e._v(" "),s("li",[s("code",[e._v("OBJ_ENCODING_HT")])])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("HSET")]),e._v(", "),s("code",[e._v("HSETNX")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("HMSET")]),e._v(", deprecated")])])]),e._v(" "),s("li",[s("code",[e._v("HGET")]),e._v(", "),s("code",[e._v("HMGET")]),e._v(", "),s("code",[e._v("HGETALL")])]),e._v(" "),s("li",[s("code",[e._v("HEXISTS")])]),e._v(" "),s("li",[s("code",[e._v("HDEL")])]),e._v(" "),s("li",[s("code",[e._v("HLEN")])]),e._v(" "),s("li",[s("code",[e._v("HINCRBY")]),e._v(", "),s("code",[e._v("HINCRBYFLOAT")])]),e._v(" "),s("li",[s("code",[e._v("HSTRLEN")])]),e._v(" "),s("li",[s("code",[e._v("HKEYS")]),e._v(", "),s("code",[e._v("HVALS")])]),e._v(" "),s("li",[s("code",[e._v("HSCAN")])])])])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("OBJ_SET")])]),e._v(" "),s("ul",[s("li",[e._v("corresponding "),s("code",[e._v("encoding")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("OBJ_ENCODING_INTSET")]),e._v(" — when only integer elements and cardinality < 512, "),s("code",[e._v("set-max-intset-entries")]),e._v(" in configurations")]),e._v(" "),s("li",[s("code",[e._v("OBJ_ENCODING_HT")]),e._v(" — "),s("code",[e._v("setDictType")]),e._v(", "),s("code",[e._v("null")]),e._v(" as value")])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("SADD")])]),e._v(" "),s("li",[s("code",[e._v("SCARD")])]),e._v(" "),s("li",[e._v("between sets\n"),s("ul",[s("li",[s("code",[e._v("SDIFF key [key ...]")]),e._v(", "),s("code",[e._v("SDIFFSTORE destination key [key ...]")])]),e._v(" "),s("li",[s("code",[e._v("SINTER key [key ...]")]),e._v(", "),s("code",[e._v("SINTERSTORE")])]),e._v(" "),s("li",[s("code",[e._v("SUNION")]),e._v(", "),s("code",[e._v("SUNIONSTORE")])]),e._v(" "),s("li",[s("code",[e._v("SMOVE")])])])]),e._v(" "),s("li",[s("code",[e._v("SISMEMBER")]),e._v(", "),s("code",[e._v("SMISMEMBER")])]),e._v(" "),s("li",[s("code",[e._v("SMEMBERS")])]),e._v(" "),s("li",[s("code",[e._v("SPOP")]),e._v(" — Knuth sampling and Floyd sampling, not uniform distribution")]),e._v(" "),s("li",[s("code",[e._v("SRANDMEMBER")]),e._v(" — bucket based: an element alone in a bucket is much more likely to be returned than an element in a bucket with chained elements")]),e._v(" "),s("li",[s("code",[e._v("SREM")])]),e._v(" "),s("li",[s("code",[e._v("SSCAN")])])])])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("OBJ_ZSET")]),e._v(" — ordered set, sort by "),s("code",[e._v("memcmp()")]),e._v(" if score is the same")]),e._v(" "),s("ul",[s("li",[e._v("corresponding "),s("code",[e._v("encoding")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("OBJ_ENCODING_ZIPLIST")]),e._v(" — when cardinality < 128 and all elements < 64 bytes, "),s("code",[e._v("zset-max-ziplist-entries")]),e._v(" and "),s("code",[e._v("zset-max-ziplist-value")]),e._v(" in configurations")]),e._v(" "),s("li",[s("code",[e._v("OBJ_ENCODING_SKIPLIST")]),e._v(" — use "),s("code",[e._v("zset")]),e._v(": like "),s("code",[e._v("java.util.LinkedHashMap")]),e._v(" but with skiplist in lieu of linked list"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("zset")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    zskiplist "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("zsl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("dict"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// member to score")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" zset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])])])])]),e._v(" "),s("li",[e._v("use\n"),s("ul",[s("li",[e._v("graph query — "),s("a",{attrs:{href:"https://redis.io/topics/indexes#representing-and-querying-graphs-using-an-hexastore",target:"_blank",rel:"noopener noreferrer"}},[e._v("Hexastore"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"https://redis.io/topics/indexes#multi-dimensional-indexes",target:"_blank",rel:"noopener noreferrer"}},[e._v("multi dimensional index"),s("OutboundLink")],1)])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("ZADD key [NX|XX] [GT|LT] [CH] [INCR] score member [score member ...]")])]),e._v(" "),s("li",[e._v("count\n"),s("ul",[s("li",[s("code",[e._v("ZCARD")]),e._v(" — cardinality")]),e._v(" "),s("li",[s("code",[e._v("ZCOUNT key min max")])]),e._v(" "),s("li",[s("code",[e._v("ZLEXCOUNT key min max")])])])]),e._v(" "),s("li",[s("code",[e._v("ZSCORE")]),e._v(", "),s("code",[e._v("ZMSCORE")]),e._v(" — get score")]),e._v(" "),s("li",[e._v("get members by range\n"),s("ul",[s("li",[s("code",[e._v("ZRANGE key start stop [WITHSCORES]")]),e._v(", "),s("code",[e._v("ZREVRANGE")]),e._v(" — get members by index, inclusive ranges, can be "),s("code",[e._v("-1")])]),e._v(" "),s("li",[s("code",[e._v("ZRANGEBYLEX")]),e._v(", "),s("code",[e._v("ZREVRANGEBYLEX")]),e._v(" — "),s("code",[e._v("(")]),e._v(", "),s("code",[e._v("[")]),e._v(" prefixed ranges, or "),s("code",[e._v("+")]),e._v(" and "),s("code",[e._v("-")])]),e._v(" "),s("li",[s("code",[e._v("ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]")]),e._v(", "),s("code",[e._v("ZREVRANGEBYSCORE")]),e._v(" — inclusive ranges, "),s("code",[e._v("(")]),e._v(" for exclusive, can be "),s("code",[e._v("-inf")]),e._v(", "),s("code",[e._v("+inf")]),e._v(", can be used for weighted random selection of an element")])])]),e._v(" "),s("li",[s("code",[e._v("ZRANK")]),e._v(", "),s("code",[e._v("ZREVRANK")])]),e._v(" "),s("li",[e._v("remove\n"),s("ul",[s("li",[s("code",[e._v("ZREM")])]),e._v(" "),s("li",[s("code",[e._v("ZREMRANGEBYLEX")])]),e._v(" "),s("li",[s("code",[e._v("ZREMRANGEBYRANK")])]),e._v(" "),s("li",[s("code",[e._v("ZREMRANGEBYSCORE")])])])]),e._v(" "),s("li",[e._v("intersection, union\n"),s("ul",[s("li",[s("code",[e._v("ZINTER")]),e._v(", "),s("code",[e._v("ZINTERSTORE")])]),e._v(" "),s("li",[s("code",[e._v("ZUNION")]),e._v(", "),s("code",[e._v("ZUNIONSTORE")])])])]),e._v(" "),s("li",[s("code",[e._v("ZINCRBY key increment member")])]),e._v(" "),s("li",[s("code",[e._v("ZPOPMAX key [count]")]),e._v(", "),s("code",[e._v("ZPOPMIN")]),e._v(" — a "),s("code",[e._v("count")]),e._v(" value that is higher than the sorted set's cardinality will not produce an error\n"),s("ul",[s("li",[s("code",[e._v("BZPOPMAX")]),e._v(", "),s("code",[e._v("BZPOPMIN")])])])]),e._v(" "),s("li",[s("code",[e._v("ZSCAN")])]),e._v(" "),s("li",[e._v("lexicographically — "),s("code",[e._v("ZRANGEBYLEX")]),e._v(", "),s("code",[e._v("ZREVRANGEBYLEX")]),e._v(", "),s("code",[e._v("ZREMRANGEBYLEX")]),e._v(" and "),s("code",[e._v("ZLEXCOUNT")]),e._v(" "),s("ul",[s("li",[e._v("if different score — if the elements in the sorted set have different scores, the returned elements are unspecified")])])])])])])]),e._v(" "),s("li",[s("p",[e._v("Geo related — of type "),s("code",[e._v("OBJ_ZSET")])]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://en.wikipedia.org/wiki/Geohash",target:"_blank",rel:"noopener noreferrer"}},[e._v("Geohash - Wikipedia"),s("OutboundLink")],1),e._v(" — latitude and longitude bits are interleaved in order to form an unique 52 bit integer, which does not lose precision when converted to "),s("code",[e._v("double")])]),e._v(" "),s("li",[e._v("limitation — areas very near to the poles are not indexable; radiuses are approximated by perfect sphere model")]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("GEOADD key longitude latitude member [longitude latitude member ...]")])]),e._v(" "),s("li",[s("code",[e._v("GEODIST")])]),e._v(" "),s("li",[s("code",[e._v("GEOHASH")]),e._v(" — standard Geohash instead of the Redis internal one")]),e._v(" "),s("li",[s("code",[e._v("GEOPOS")]),e._v(" — return the positions (longitude,latitude)")]),e._v(" "),s("li",[s("code",[e._v("GEORADIUS")]),e._v(" — get members within a specified circle")]),e._v(" "),s("li",[s("code",[e._v("GEORADIUSBYMEMBER")]),e._v(" — like "),s("code",[e._v("GEORADIUS")]),e._v(" but the center of the circle is the specified member")]),e._v(" "),s("li",[e._v("delete — "),s("code",[e._v("ZREM")])])])])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("OBJ_STREAM")]),e._v(" — log data structure, append only, allow consumers block waiting and has consumer groups, since 5.0")]),e._v(" "),s("ul",[s("li",[e._v("corresponding "),s("code",[e._v("encoding")]),e._v(" - "),s("code",[e._v("OBJ_ENCODING_STREAM")]),e._v(", radix tree of listpacks"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("stream")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    rax "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("rax"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("               "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* The radix tree holding the stream. */")]),e._v("\n    uint64_t length"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("        "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Number of elements inside this stream. */")]),e._v("\n    streamID last_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("       "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Zero if there are yet no items. */")]),e._v("\n    rax "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("cgroups"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("           "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Consumer groups dictionary: name -> streamCG */")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[s("code",[e._v("streamID")]),e._v(" — "),s("code",[e._v("<millisecondsTime>-<64b-sequenceNumber>")]),e._v(", monotonically incrementing, usually auto generated by passing "),s("code",[e._v("*")]),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Stream item ID: a 128 bit number composed of a milliseconds time and\n * a sequence counter. IDs generated in the same millisecond (or in a past\n * millisecond if the clock jumped backward) will use the millisecond time\n * of the latest generated ID and an incremented sequence. */")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("streamID")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    uint64_t ms"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("        "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Unix time in milliseconds. */")]),e._v("\n    uint64_t seq"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("       "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Sequence number. */")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" streamID"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[e._v("special forms in some commands — "),s("code",[e._v("*")]),e._v(", "),s("code",[e._v("+")]),e._v(", "),s("code",[e._v("-")]),e._v(", "),s("code",[e._v("$")]),e._v(", "),s("code",[e._v(">")]),e._v(", see below")])])])])]),e._v(" "),s("li",[e._v("use\n"),s("ul",[s("li",[e._v("fan out messages to multiple clients — multiple consumers see the new messages appended to the stream (the same way many "),s("code",[e._v("tail -f")]),e._v(" processes can see what is added to a log)")]),e._v(" "),s("li",[e._v("time series store — get messages by ranges of time, or alternatively to iterate the messages using a cursor to incrementally check all the history; consumers will know what is a new message by remembering last "),s("code",[e._v("streamID")])]),e._v(" "),s("li",[e._v("consumer groups, like in Kafka but logical partitions — a stream of messages that can be partitioned to multiple consumers, possible to scale the message processing across different consumers; explicit acknowledgment of processed items, ability to inspect the pending items, claiming of unprocessed messages, and coherent history visibility for each single client\n"),s("ul",[s("li",[e._v("latency — minimal, before returning to the event loop both the client calling "),s("code",[e._v("XADD")]),e._v(" and the clients blocked to consume messages, will have their reply in the output buffers")])])])])]),e._v(" "),s("li",[e._v("consumer group — like a pseudo consumer that gets data from a stream, and actually serves multiple consumers; within a consumer group:"),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('+----------------------------------------+\n| consumer_group_name: mygroup           |\n| consumer_group_stream: somekey         |\n| last_delivered_id: 1292309234234-92    |\n|                                        |\n| consumers:                             |\n|    "consumer-1" with pending messages  |\n|       1292309234234-4                  |\n|       1292309234232-8                  |\n|    "consumer-42" with pending messages |\n|       ... (and so forth)               |\n+----------------------------------------+\n')])])]),s("ul",[s("li",[e._v("stable consumer name — consumers identified by case-sensitive names, which stay unchanged even after reconnection")]),e._v(" "),s("li",[e._v("cursor — each consumer group has the concept of the first ID never consumed")]),e._v(" "),s("li",[e._v("explicit consumer ACK — consuming a message requires an explicit acknowledgment using "),s("code",[e._v("XACK")]),e._v(", then Redis can evict ACKed message from the consumer group")]),e._v(" "),s("li",[e._v("pending tracked — a consumer group tracks all the messages that are currently pending, i.e. delivered but not yet ACKed messages")]),e._v(" "),s("li",[e._v("one message one customer")])])]),e._v(" "),s("li",[e._v("observability — see "),s("code",[e._v("XINFO")]),e._v(", get info like who is consuming messages, what messages are pending, the set of consumer groups active in a given stream\n"),s("ul",[s("li",[e._v("dead letter — when delivery count is abnormally height, it is probably wiser to put such messages in another stream and send a notification to the system administrator")])])]),e._v(" "),s("li",[e._v("zero-length streams — zero-length stream keys are not deleted in contrast to keys of other collections, to preserve the state of customer groups")]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("XADD key ID field value [field value ...]")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("MAXLEN")]),e._v(" option — capped stream, with "),s("code",[e._v("~")]),e._v(" for approximated cap but more efficient")])])]),e._v(" "),s("li",[s("code",[e._v("XTRIM key MAXLEN [~] count")])]),e._v(" "),s("li",[s("code",[e._v("XDEL")]),e._v(" — mark delete")]),e._v(" "),s("li",[s("code",[e._v("XLEN")])]),e._v(" "),s("li",[s("code",[e._v("XRANGE key start end [COUNT count]")]),e._v(", "),s("code",[e._v("XREVRANGE")]),e._v(" "),s("ul",[s("li",[e._v("special "),s("code",[e._v("streamID")]),e._v(" — "),s("code",[e._v("-")]),e._v(", "),s("code",[e._v("+")])]),e._v(" "),s("li",[e._v("iterate — streamID which is "),s("code",[e._v("streamID.seq + 1")]),e._v(" from previous returned "),s("code",[e._v("streamID")]),e._v(" as "),s("code",[e._v("start")]),e._v(", and "),s("code",[e._v("+")]),e._v(" as "),s("code",[e._v("end")]),e._v(", with "),s("code",[e._v("COUNT")]),e._v(" limit")])])]),e._v(" "),s("li",[s("code",[e._v("XREAD [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] id [id ...]")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("$")]),e._v(" as "),s("code",[e._v("id")]),e._v(" — the maximum ID already stored in the stream")]),e._v(" "),s("li",[s("code",[e._v("BLOCK")]),e._v(" — block until any listened "),s("code",[e._v("key")]),e._v(" has new data, and blocking clients are FIFO")])])]),e._v(" "),s("li",[s("code",[e._v("XINFO STREAM")]),e._v(", "),s("code",[e._v("XINFO HELP")])]),e._v(" "),s("li",[e._v("consumer group\n"),s("ul",[s("li",[s("code",[e._v("XREADGROUP")]),e._v(" — "),s("code",[e._v("XREAD")]),e._v(" consumer group version, not a readonly command due to side effects"),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]\n")])])]),s("ul",[s("li",[e._v("special "),s("code",[e._v("ID")]),e._v(" "),s("code",[e._v(">")]),e._v(" — messages never delivered to other consumers so far")]),e._v(" "),s("li",[e._v("other valid "),s("code",[e._v("ID")]),e._v(" — return pending messages")])])]),e._v(" "),s("li",[s("code",[e._v("XGROUP")]),e._v(" — create, destroy and manage consumer groups\n"),s("ul",[s("li",[e._v("consumer auto creation — consumers are auto-created the first time they are mentioned, no need for explicit creation")])])]),e._v(" "),s("li",[s("code",[e._v("XACK")])]),e._v(" "),s("li",[s("code",[e._v("XPENDING")]),e._v(" — inspect the list of pending messages, specify range to see idle time and delivery count")]),e._v(" "),s("li",[s("code",[e._v("XCLAIM")]),e._v(" — changes the ownership of a pending message to the specified customer, claiming a message will reset its idle time, also increment its delivery count if not "),s("code",[e._v("JUSTID")]),e._v("; can be used in case of permanent consumer failure")]),e._v(" "),s("li",[s("code",[e._v("XINFO")]),e._v(" — see "),s("code",[e._v("XINFO HELP")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("XINFO CONSUMERS key groupname")])]),e._v(" "),s("li",[s("code",[e._v("XINFO GROUPS key")])])])])])])])])])])]),e._v(" "),s("h3",{attrs:{id:"Sort"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Sort"}},[e._v("#")]),e._v(" Sort")]),e._v(" "),s("ol",[s("li",[e._v("sort"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("_redisSortObject")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    robj "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("obj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("union")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("double")]),e._v(" score"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        robj "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("cmpobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// for BY ALPHA")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" u"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" redisSortObject"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[e._v("steps\n"),s("ol",[s("li",[e._v("create an array of "),s("code",[e._v("redisSortObject")])]),e._v(" "),s("li",[e._v("populate "),s("code",[e._v("redisSortObject->obj")])]),e._v(" "),s("li",[e._v("populate scores, skipped when "),s("code",[e._v("ALPHA")]),e._v(", according to the pattern when "),s("code",[e._v("BY")]),e._v(";otherwise populate "),s("code",[e._v("cmpobj")]),e._v(" if "),s("code",[e._v("BY")]),e._v(" with "),s("code",[e._v("ALPHA")])]),e._v(" "),s("li",[e._v("sort, by quicksort")]),e._v(" "),s("li",[e._v("return to the client")])])]),e._v(" "),s("li",[e._v("compare by"),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('redis> SADD fruits "apple" "banana" "cherry"\nredis> MSET apple-price 8 banana-price 5.5 cherry-price 7\nredis> SORT fruits BY *-price\n')])])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("SORT")]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("SORT key [BY pattern] [LIMIT offset count] [GET pattern [GET pattern ...]] [ASC|DESC] [ALPHA] [STORE destination]\n")])])]),s("ul",[s("li",[s("code",[e._v("ALPHA")]),e._v(" — lexicographically")]),e._v(" "),s("li",[s("code",[e._v("ASC")]),e._v(", "),s("code",[e._v("DESC")])]),e._v(" "),s("li",[s("code",[e._v("BY")])]),e._v(" "),s("li",[s("code",[e._v("LIMIT")])]),e._v(" "),s("li",[s("code",[e._v("GET")]),e._v(" — get pattern")]),e._v(" "),s("li",[s("code",[e._v("STORE")])])])])])])])])]),e._v(" "),s("h2",{attrs:{id:"Server-and-Client"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Server-and-Client"}},[e._v("#")]),e._v(" Server and Client")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("server")]),e._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("redisServer")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n  redisDb "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// db array")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" dbnum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("                      "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Total number of configured DBs */")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// part of stats")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" stat_keyspace_hits"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Number of successful lookups of keys */")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" stat_keyspace_misses"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Number of failed lookups of keys */")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* RDB persistence */")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" dirty"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("                "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Changes to DB from the last save */")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" dirty_before_bgsave"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Used to restore dirty on failed BGSAVE */")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Networking */")]),e._v("\n  list "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("clients"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("              "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* List of active clients */")]),e._v("\n  list "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("clients_to_close"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("     "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Clients to close asynchronously */")]),e._v("\n  list "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("clients_pending_write"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* There is to write or install handler. */")]),e._v("\n  list "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("clients_pending_read"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Client has pending read socket buffers. */")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Scripting */")]),e._v("\n  lua_State "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("lua"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* The Lua interpreter. We use just one for all clients */")]),e._v("\n  client "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("lua_client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v('/* The "fake client" to query Redis from Lua */')]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("ul",[s("li",[s("code",[e._v("dbnum")]),e._v(" — defaults to 16, "),s("code",[e._v("database")]),e._v(" in configurations")]),e._v(" "),s("li",[e._v("maintainence when reading or writing a keyspace\n"),s("ul",[s("li",[e._v("maintain statistics, like "),s("code",[e._v("stat_keyspace_hits")]),e._v(", "),s("code",[e._v("stat_keyspace_misses")])]),e._v(" "),s("li",[e._v("update "),s("code",[e._v("redisObject.lru")])]),e._v(" "),s("li",[e._v("delete a key if expired")]),e._v(" "),s("li",[e._v("mark "),s("code",[e._v("WATCH")]),e._v("ed keys dirty")]),e._v(" "),s("li",[e._v("increment "),s("code",[e._v("dirty")]),e._v(" counters")]),e._v(" "),s("li",[e._v("dispatch notifications")])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("INFO [section]")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("INFO server")]),e._v(", "),s("code",[e._v("INFO clients")])]),e._v(" "),s("li",[s("code",[e._v("INFO stats")])]),e._v(" "),s("li",[e._v("more")]),e._v(" "),s("li",[s("code",[e._v("CONFIG RESETSTAT")])]),e._v(" "),s("li",[s("code",[e._v("DBSIZE")])])])]),e._v(" "),s("li",[s("code",[e._v("SHUTDOWN [NOSAVE|SAVE]")])]),e._v(" "),s("li",[s("code",[e._v("DEBUG SEGFAULT")])]),e._v(" "),s("li",[s("code",[e._v("TIME")])]),e._v(" "),s("li",[s("code",[e._v("SWAPDB index1 index2")]),e._v(" — swap db index")]),e._v(" "),s("li",[s("code",[e._v("MOVE key db")]),e._v(" — between "),s("code",[e._v("redisServer.db")])]),e._v(" "),s("li",[s("code",[e._v("FLUSHALL")])])])])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("redisDb")])]),e._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Redis database representation. There are multiple databases identified\n * by integers from 0 (the default database) up to the max configured\n * database. The database number is the 'id' field in the structure. */")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("redisDb")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("dict"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("                 "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* The keyspace for this DB */")]),e._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("expires"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("              "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Timeout of keys with a timeout set */")]),e._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("blocking_keys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("        "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Keys with clients waiting for data (BLPOP)*/")]),e._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("ready_keys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("           "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Blocked keys that received a PUSH */")]),e._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("watched_keys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("         "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* WATCHED keys for MULTI/EXEC CAS */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("                     "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Database ID */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" avg_ttl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("          "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Average TTL, just for stats */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" expires_cursor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Cursor of the active expire cycle. */")]),e._v("\n    list "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("defrag_later"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("         "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* List of key names to attempt to defrag one by one, gradually. */")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" redisDb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[s("code",[e._v("expires")]),e._v(" — a dict where keys are pointers to keys in keyspace, values are "),s("code",[e._v("long long")]),e._v(" UNIX timestamps\n"),s("ul",[s("li",[e._v("expungement strategy\n"),s("ul",[s("li",[e._v("lazy — expunge when reading the key")]),e._v(" "),s("li",[e._v("periodic — expunge in some frequency with a time limit, continue from the last expunged "),s("code",[e._v("redisDb")]),e._v(", cycling "),s("code",[e._v("redisServer.db")]),e._v(" array: examine and expunge 20 keys randomly selected from "),s("code",[e._v("redisDb->expires")]),e._v(" until no more than 25% of selected 20 keys expunged")])])]),e._v(" "),s("li",[e._v("key expiration in replicas — key expungement of followers is controlled by the master, who sends "),s("code",[e._v("DEL")]),e._v(" commands to followers")]),e._v(" "),s("li",[e._v("persistence related\n"),s("ul",[s("li",[e._v("RDB\n"),s("ul",[s("li",[e._v("when "),s("code",[e._v("SAVE")]),e._v(" or "),s("code",[e._v("BGSAVE")]),e._v(" — expired keys filtered")]),e._v(" "),s("li",[e._v("when loading data — master will filter expired keys, followers will not (cleared when syncing with master)")])])]),e._v(" "),s("li",[e._v("AOF\n"),s("ul",[s("li",[e._v("when writing to AOF — when expunged, a "),s("code",[e._v("DEL")]),e._v(" is explicitly appended")]),e._v(" "),s("li",[e._v("when rewriting AOF — expired keys filtered")])])])])]),e._v(" "),s("li",[e._v("related commands — "),s("code",[e._v("PEXPIREAT")]),e._v(" under the hood\n"),s("ul",[s("li",[s("code",[e._v("EXPIRE")]),e._v(", "),s("code",[e._v("PEXPIRE")]),e._v(", "),s("code",[e._v("SET")]),e._v(" — TTL, in s or ms, untouched by altering commands like "),s("code",[e._v("INCR")]),e._v(", "),s("code",[e._v("LPUSH")]),e._v(", "),s("code",[e._v("HSET")]),e._v(", "),s("code",[e._v("RENAME")]),e._v(", overwritten for other write commands")]),e._v(" "),s("li",[s("code",[e._v("EXPIREAT")]),e._v(", "),s("code",[e._v("PEXPIREAT")]),e._v(" — UNIX timestamp, in s or ms")]),e._v(" "),s("li",[s("code",[e._v("TTL")]),e._v(", "),s("code",[e._v("PTTL")]),e._v(" — remaining time to live, in s or ms")]),e._v(" "),s("li",[s("code",[e._v("PERSIST")]),e._v(" — remove expiration")])])])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("DEL")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("UNLINK")]),e._v(" — GC left to do, asynchronously in another thread")])])]),e._v(" "),s("li",[s("code",[e._v("DUMP")]),e._v(", "),s("code",[e._v("RESTORE")]),e._v(" — serialize and deserialize, format is opaque and non-standard, with checksum and values are encoded in the same format used by RDB with RDB version\n"),s("ul",[s("li",[s("code",[e._v("MIGRATE")]),e._v(" — see "),s("a",{attrs:{href:"#Clustering"}},[e._v("Clustering")])])])]),e._v(" "),s("li",[s("code",[e._v("KEYS pattern")]),e._v(" — support more glob pattern")]),e._v(" "),s("li",[s("code",[e._v("EXISTS key [key ...]")]),e._v(", "),s("code",[e._v("TOUCH key [key ...]")])]),e._v(" "),s("li",[s("code",[e._v("FLUSHDB")]),e._v(" — delete all the keys")]),e._v(" "),s("li",[s("code",[e._v("RANDOMKEY")])]),e._v(" "),s("li",[s("code",[e._v("DBSIZE")])]),e._v(" "),s("li",[s("code",[e._v("RENAME")]),e._v(", "),s("code",[e._v("RENAMENX")])]),e._v(" "),s("li",[s("code",[e._v("SCAN")]),e._v(" — incrementally iterate over a collection of elements")])])])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("redisCommand")])]),e._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("redisCommand")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("char")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    redisCommandProc "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("proc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" arity"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("char")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("sflags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Flags as string representation, one char per flag. */")]),e._v("\n    uint64_t flags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* The actual flags, obtained from the 'sflags' field. */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" microseconds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" calls"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// statistics")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[s("code",[e._v("name")]),e._v(" — "),s("code",[e._v("client->argv[0]")])]),e._v(" "),s("li",[s("code",[e._v("proc")]),e._v(" — callback, called as "),s("code",[e._v("client->cmd->proc(client)")])]),e._v(" "),s("li",[s("code",[e._v("sflags")]),e._v(" — see "),s("a",{attrs:{href:"https://redis.io/commands/command#flags",target:"_blank",rel:"noopener noreferrer"}},[e._v("redis.io"),s("OutboundLink")],1),e._v(", and "),s("a",{attrs:{href:"https://github.com/redis/redis/blob/25f457c7f69e7f0254cc5d585eadd784dd30d91c/src/server.c#L113-L180",target:"_blank",rel:"noopener noreferrer"}},[s("code",[e._v("server.c")]),s("OutboundLink")],1),e._v(" "),s("ul",[s("li",[s("code",[e._v("write")]),e._v(" — write, like "),s("code",[e._v("SET")]),e._v(", "),s("code",[e._v("RPUSH")]),e._v(", "),s("code",[e._v("DEL")])]),e._v(" "),s("li",[s("code",[e._v("read-only")]),e._v(" — read, like "),s("code",[e._v("GET")]),e._v(", "),s("code",[e._v("STRLEN")]),e._v(", "),s("code",[e._v("EXISTS")])]),e._v(" "),s("li",[s("code",[e._v("use-memory")]),e._v(" — may increase memory usage once called, don't allow if out of memory, like "),s("code",[e._v("SET")]),e._v(", "),s("code",[e._v("APPEND")]),e._v(", "),s("code",[e._v("RPUSH")]),e._v(", "),s("code",[e._v("LPUSH")]),e._v(", "),s("code",[e._v("SADD")]),e._v(", "),s("code",[e._v("SINTERSTORE")])]),e._v(" "),s("li",[e._v("more")])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("COMMAND")]),e._v(" — details about all Redis commands")]),e._v(" "),s("li",[s("code",[e._v("COMMAND COUNT")])]),e._v(" "),s("li",[s("code",[e._v("COMMAND INFO command-name [command-name ...]")]),e._v(" — "),s("code",[e._v("COMMAND")]),e._v(" for specific commands")]),e._v(" "),s("li",[s("code",[e._v("COMMAND GETKEYS")]),e._v(" — keys parsed from a full Redis command")])])])])]),e._v(" "),s("li",[s("p",[e._v("client")]),e._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("client")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// once called redisClient")]),e._v("\n  uint64_t id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("            "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Client incremental unique ID. */")]),e._v("\n  connection "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("conn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// fd, connection type, state, flags, callbacks")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n  redisDb "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("            "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Pointer to currently SELECTed DB. */")]),e._v("\n  robj "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("             "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* As set by CLIENT SETNAME. */")]),e._v("\n  sds querybuf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("           "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Buffer we use to accumulate client queries. */")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n  uint64_t flags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("         "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Client flags: CLIENT_* macros. */")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[e._v("query buffer (hard non-configurable limit) or reply buffer overflow — the client will be closed\n"),s("ul",[s("li",[e._v("hard limit — close immediately")]),e._v(" "),s("li",[e._v("soft limit — close after the time elapsed since "),s("code",[e._v("client.obuf_soft_limit_reached_time")]),e._v(" is beyond the configured, "),s("code",[e._v("client-output-buffer-limit")]),e._v(" in configurations")])])]),e._v(" "),s("li",[s("code",[e._v("querybuf")]),e._v(" related fields"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[e._v("size_t qb_pos"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("          "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* The position we have read in querybuf. */")]),e._v("\nsds pending_querybuf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* If this client is flagged as master, this buffer\n                           represents the yet not applied portion of the\n                           replication stream that we are receiving from\n                           the master. */")]),e._v("\nsize_t querybuf_peak"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Recent (100ms or more) peak of querybuf size. */")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" argc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("               "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Num of arguments of current command. */")]),e._v("\nrobj "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("argv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("            "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Arguments of current command. */")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("redisCommand")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("cmd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("lastcmd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Last command executed. */")]),e._v("\n")])])])]),e._v(" "),s("li",[s("code",[e._v("flags")]),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Client flags */")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("CLIENT_SLAVE")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("   ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* This client is a repliaca */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("CLIENT_MASTER")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("  ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* This client is a master */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("CLIENT_MONITOR")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* This client is a slave monitor, see MONITOR */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("CLIENT_MULTI")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("   ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* This client is in a MULTI context */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("CLIENT_BLOCKED")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* The client is waiting in a blocking operation */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("CLIENT_DIRTY_CAS")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Watched keys modified. EXEC will fail. */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("CLIENT_CLOSE_AFTER_REPLY")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("6")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Close after writing entire reply. */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("CLIENT_UNBLOCKED")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("7")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* This client was unblocked and is stored in\n                                  server.unblocked_clients */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("CLIENT_LUA")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("8")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* This is a non connected client used by Lua */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("CLIENT_ASKING")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("9")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("     ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Client issued the ASKING command */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("CLIENT_CLOSE_ASAP")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")])]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Close this client ASAP */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("CLIENT_UNIX_SOCKET")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("11")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Client connected via Unix domain socket */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// more")]),e._v("\n")])])])]),e._v(" "),s("li",[e._v("client side caching — see "),s("a",{attrs:{href:"#Publish-and-Subscribe"}},[e._v("Publish and Subscribe")])]),e._v(" "),s("li",[e._v("more")]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("SELECT")])]),e._v(" "),s("li",[s("code",[e._v("ECHO")])]),e._v(" "),s("li",[s("code",[e._v("PING")])]),e._v(" "),s("li",[s("code",[e._v("QUIT")])]),e._v(" "),s("li",[s("code",[e._v("MONITOR")]),e._v(" — a debugging command that streams back every command processed by the Redis server, "),s("code",[e._v("CLIENT_MONITOR")]),e._v(" in "),s("code",[e._v("client.flags")])]),e._v(" "),s("li",[s("code",[e._v("CLIENT")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("CLIENT LIST")])]),e._v(" "),s("li",[s("code",[e._v("CLIENT GETNAME")]),e._v(", "),s("code",[e._v("CLIENT SETNAME")])]),e._v(" "),s("li",[s("code",[e._v("CLIENT KILL")])]),e._v(" "),s("li",[s("code",[e._v("CLIENT ID")]),e._v(" — runtime unique and logical clock in terms of the time connected to the server")]),e._v(" "),s("li",[s("code",[e._v("CLIENT PAUSE")]),e._v(" — suspend all the Redis clients for the specified amount of time (in milliseconds)")]),e._v(" "),s("li",[s("code",[e._v("CLIENT REPLY ON|OFF|SKIP")])]),e._v(" "),s("li",[s("code",[e._v("CLIENT UNBLOCK")])]),e._v(" "),s("li",[e._v("client caching related commands, see "),s("a",{attrs:{href:"#Publish-and-Subscribe"}},[e._v("Publish and Subscribe")])])])])])])])])]),e._v(" "),s("h2",{attrs:{id:"Events"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Events"}},[e._v("#")]),e._v(" Events")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("event loop, "),s("code",[e._v("aeMain")]),e._v(" in "),s("code",[e._v("ae.c")]),e._v(" — "),s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/144805500",target:"_blank",rel:"noopener noreferrer"}},[e._v("zhihu"),s("OutboundLink")],1)]),e._v(" "),s("ul",[s("li",[e._v("steps\n"),s("ol",[s("li",[e._v("in "),s("code",[e._v("beforesleep")]),e._v(" call back\n"),s("ol",[s("li",[e._v("cluster and persistence logics like flush AOF buffer")]),e._v(" "),s("li",[s("code",[e._v("writeToClient")])])])]),e._v(" "),s("li",[s("code",[e._v("epoll_wait")])]),e._v(" "),s("li",[e._v("file events — sockets")]),e._v(" "),s("li",[e._v("time events")])])]),e._v(" "),s("li",[e._v("limitations\n"),s("ul",[s("li",[e._v("single core")]),e._v(" "),s("li",[e._v("big key throttling")])])])])]),e._v(" "),s("li",[s("p",[e._v("file events — Reactor model, I/O multiplexing, event queuing at event dispatcher")]),e._v(" "),s("ul",[s("li",[e._v("event handlers\n"),s("ul",[s("li",[s("code",[e._v("acceptTcpHandler")])]),e._v(" "),s("li",[s("code",[e._v("readQueryFromClient")])]),e._v(" "),s("li",[s("code",[e._v("sendReplyToClient")])]),e._v(" "),s("li",[e._v("more")])])]),e._v(" "),s("li",[e._v("tbd")])])]),e._v(" "),s("li",[s("p",[e._v("time events — tbd")]),e._v(" "),s("ul",[s("li",[e._v("one time scheduled events")]),e._v(" "),s("li",[e._v("periodic events "),s("code",[e._v("serverCron")]),e._v(" — "),s("code",[e._v("hz")]),e._v(" in configurations, defaults to 10, update statistics, expunge expired keys, close and clear sessions, AOF and RDB, follower replication, cluster synchronization and heartbeat\n"),s("ul",[s("li",[e._v("update tasks\n"),s("ul",[s("li",[e._v("update timestamp cache — timestamp cached in "),s("code",[e._v("redisServer.unixtime")]),e._v(" and "),s("code",[e._v("redisServer.mstime")]),e._v(" to reduce system calls for timestamp insensitive tasks like logging, deciding persistence time point, "),s("code",[e._v("EXPIRE")]),e._v(" and slow query log not included")]),e._v(" "),s("li",[e._v("update "),s("code",[e._v("redisServer.lruclock")]),e._v(" timestamp cache, defaults to once every 10s")]),e._v(" "),s("li",[e._v("update stats")])])]),e._v(" "),s("li",[e._v("more tasks")])])])])]),e._v(" "),s("li",[s("p",[e._v("multithread IO, since 6.0 — "),s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/144805500",target:"_blank",rel:"noopener noreferrer"}},[e._v("zhihu"),s("OutboundLink")],1),e._v(", dispatch tasks to IO threads for "),s("code",[e._v("read()")]),e._v(" and "),s("code",[e._v("write()")]),e._v(" system calls, main thread also does one tasks and spinning waiting for the completion of IO threads")])])]),e._v(" "),s("h2",{attrs:{id:"Publish-and-Subscribe"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Publish-and-Subscribe"}},[e._v("#")]),e._v(" Publish and Subscribe")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("publish and subscribe")]),e._v(" "),s("ul",[s("li",[e._v("channels"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("redisServer")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Pubsub */")]),e._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("pubsub_channels"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Map channels to list of subscribed clients */")]),e._v("\n    list "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("pubsub_patterns"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* A list of pubsub_patterns */")]),e._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("pubsub_patterns_dict"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* A dict of pubsub_patterns */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" notify_keyspace_events"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Events to propagate via Pub/Sub. This is an\n                                   xor of NOTIFY_... flags. */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("client")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("pubsub_channels"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* channels a client is interested in (SUBSCRIBE) */")]),e._v("\n    list "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("pubsub_patterns"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* patterns a client is interested in (SUBSCRIBE) */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[s("code",[e._v("pubsub_channels")]),e._v(" — "),s("code",[e._v("dict")]),e._v(", key as channel name, value as a linked list of subscribed clients")]),e._v(" "),s("li",[s("code",[e._v("pubsub_patterns")]),e._v(" — "),s("code",[e._v("list")]),e._v(", "),s("code",[e._v("pubsubPattern")]),e._v(" as elements"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("pubsubPattern")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    client "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    robj "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("pattern"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" pubsubPattern"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])])])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("SUBSCRIBE")])]),e._v(" "),s("li",[s("code",[e._v("PSUBSCRIBE")]),e._v(" — glob-style pattern subscribe")]),e._v(" "),s("li",[s("code",[e._v("PUBLISH channel message")]),e._v(" — O(N+M) where N is the number of clients subscribed to the receiving channel and M is the total number of subscribed patterns (by any client)")]),e._v(" "),s("li",[s("code",[e._v("PUBSUB")]),e._v(" — inspect the state of the Pub/Sub subsystem\n"),s("ul",[s("li",[s("code",[e._v("PUBSUB CHANNELS [pattern]")])]),e._v(" "),s("li",[s("code",[e._v("PUBSUB NUMSUB [channel-1 ... channel-N]")])]),e._v(" "),s("li",[s("code",[e._v("PUBSUB NUMPAT")])])])]),e._v(" "),s("li",[s("code",[e._v("UNSUBSCRIBE")])]),e._v(" "),s("li",[s("code",[e._v("PUNSUBSCRIBE")])])])])])]),e._v(" "),s("li",[s("p",[e._v("keyspace event notifications")]),e._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("notifyKeyspaceEvent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("char")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("event"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" robj "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" dbid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])])]),s("ul",[s("li",[e._v("event — all the commands generate events only if the target key is really modified, "),s("code",[e._v("notify-keyspace-events")]),e._v(" in configurations\n"),s("ul",[s("li",[e._v("keyspace event — every key event in a keyspace")]),e._v(" "),s("li",[e._v("key event — commands on keys")])])]),e._v(" "),s("li",[e._v("channel name\n"),s("ul",[s("li",[e._v("key-space notification — prefixed with "),s("code",[e._v("__keyspace@<db>__")]),e._v(", like "),s("code",[e._v("__keyspace@0__:foo")])]),e._v(" "),s("li",[e._v("key-event notification — prefixed with "),s("code",[e._v("__keyevent@<db>__")])]),e._v(" "),s("li",[e._v("example — when "),s("code",[e._v("DEL")]),e._v(" "),s("code",[e._v("mykey")]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("PUBLISH __keyspace@0__:mykey del\nPUBLISH __keyevent@0__:del mykey\n")])])])]),e._v(" "),s("li",[e._v("test — use below "),s("code",[e._v("redis-cli")]),e._v(" and another "),s("code",[e._v("redis-cli")]),e._v(" to send key commands"),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("$ redis-cli config "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("set")]),e._v(" notify-keyspace-events KEA\n$ redis-cli --csv psubscribe "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'__key*__:*'")]),e._v("\nReading messages"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v(". "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("press Ctrl-C to quit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"psubscribe"')]),e._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"__key*__:*"')]),e._v(",1\n")])])])])])]),e._v(" "),s("li",[e._v("node-specific in a cluster — keyspace event notifications not broadcasted in a cluster to receive all keyspace events of a cluster, clients need to subscribe to all nodes")]),e._v(" "),s("li",[e._v("parameters\n"),s("ul",[s("li",[s("code",[e._v("event")]),e._v(" — command name, like "),s("code",[e._v("del")])]),e._v(" "),s("li",[s("code",[e._v("key")]),e._v(", "),s("code",[e._v("dbid")]),e._v(" — related key and db")]),e._v(" "),s("li",[s("code",[e._v("type")]),e._v(" — "),s("code",[e._v("redisServer.notify_keyspace_events")]),e._v(", at least "),s("code",[e._v("K")]),e._v(" or "),s("code",[e._v("E")]),e._v(" should present in "),s("code",[e._v("notify-keyspace-events")]),e._v(" otherwise no event"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Keyspace changes notification classes. Every class is associated with a\n * character for configuration purposes. */")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_KEYSPACE")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("    ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* K */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_KEYEVENT")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("    ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* E */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_GENERIC")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("     ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* g */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_STRING")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("      ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* $ */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_LIST")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("        ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* l */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_SET")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("         ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* s */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_HASH")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("6")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("        ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* h */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_ZSET")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("7")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("        ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* z */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_EXPIRED")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("8")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("     ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* x */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_EVICTED")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("9")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("     ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* e */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_STREAM")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("     ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* t */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_KEY_MISS")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("11")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("   ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* m (Note: This one is excluded from NOTIFY_ALL on purpose) */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_LOADED")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("12")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("     ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* module only key space notification, indicate a key loaded from rdb */")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[e._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[e._v("define")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("NOTIFY_ALL")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("NOTIFY_GENERIC "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" NOTIFY_STRING "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" NOTIFY_LIST "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" NOTIFY_SET "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" NOTIFY_HASH "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" NOTIFY_ZSET "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" NOTIFY_EXPIRED "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" NOTIFY_EVICTED "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" NOTIFY_STREAM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* A flag */")])]),e._v("\n")])])])])])])])]),e._v(" "),s("li",[s("p",[e._v("tracking — assist client caching, since 6.0, specific improvement for the practice of leveraging the Pub/Sub system in order to send invalidation messages to invalidate stale cache")]),e._v(" "),s("ul",[s("li",[e._v("src — "),s("code",[e._v("tracking.c")]),e._v(", tbd")]),e._v(" "),s("li",[e._v("two modes\n"),s("ul",[s("li",[e._v("default — the server remembers what keys a given client accessed in the tracking table, and send invalidation messages when the same keys are modified or evicted\n"),s("ul",[s("li",[e._v("invalidation message — clients remove the corresponding keys upon receiving")])])]),e._v(" "),s("li",[e._v("broadcasting — clients subscribe to key prefixes such as "),s("code",[e._v("object:")]),e._v(" or "),s("code",[e._v("user:")]),e._v(", and will receive a notification message every time a key matching such prefix is touched, no memory cost for server")])])]),e._v(" "),s("li",[e._v("implementation\n"),s("ul",[s("li",[e._v("default mode\n"),s("ul",[s("li",[e._v("tracking table — keys to clients kept by server\n"),s("ul",[s("li",[e._v("eviction — random eviction, evict an older entry and send invalidation message if max reached; "),s("code",[e._v("tracking_table_max_keys")]),e._v(" in configurations, defaults to no limit")])])]),e._v(" "),s("li",[e._v("store client ID instead of pointer — avoid GC; if a client disconnects, the information will be incrementally garbage collected as caching slots are invalidated")]),e._v(" "),s("li",[e._v("single key space — modification to a key in database 2 can invalidate another key in database 3, reducing both the memory usage and the implementation complexity")])])]),e._v(" "),s("li",[e._v("broadcasting mode\n"),s("ul",[s("li",[e._v("prefix table — each prefix is associated to a list of clients")])])])])]),e._v(" "),s("li",[e._v("connection\n"),s("ul",[s("li",[e._v("RESP3 — multiplexing, possible to run the data queries and receive the invalidation messages in the same connection")]),e._v(" "),s("li",[e._v("RESP2 — can only use two separated connections: one for data, and one for invalidation messages ("),s("code",[e._v("_redis_:invalidate")]),e._v(" channel, note that using Pub/Sub is entirely a trick to reuse old client implementations, but actually the message is not really sent to a channel)\n"),s("ul",[s("li",[e._v("race condition — possible when invalidation connection faster than data connection"),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('[D] client -> server: GET foo (server start tracking the key)\n[I] server -> client: Invalidate foo (somebody else touched it)\n[D] server -> client: "bar" (the reply of "GET foo", which is not valid but will be cached)\n')])])]),s("ul",[s("li",[e._v("solution — populate the key in the local cache with null placeholder, do nothing if key missing upon getting result ("),s("code",[e._v("put")]),e._v(" if present instead of just "),s("code",[e._v("put")]),e._v(")")])])])])])])]),e._v(" "),s("li",[e._v("tracking target\n"),s("ul",[s("li",[e._v("normally — keys in read only commands")]),e._v(" "),s("li",[e._v("opt-in caching — "),s("code",[e._v("OPTIN")]),e._v(" option, when broadcasting is NOT active, use "),s("code",[e._v("CLIENT CACHING yes")]),e._v(" to track keys in read only commands, effective for the immediately next command/transaction/script")]),e._v(" "),s("li",[e._v("opt-out caching — "),s("code",[e._v("OPTOUT")]),e._v(" option, the contrary of "),s("code",[e._v("OPTIN")]),e._v(", in tandem with "),s("code",[e._v("CLIENT CACHING no")])])])]),e._v(" "),s("li",[e._v("network partition — if connection lost, flush the local cache, can be in tandem with invalidation connection "),s("code",[e._v("PING")]),e._v(" heartbeat to see if connection lost")]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("CLIENT TRACKING")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("NOLOOP")]),e._v(" option — don't send notifications about keys modified by this connection itself")])])]),e._v(" "),s("li",[s("code",[e._v("CLIENT CACHING YES|NO")])]),e._v(" "),s("li",[s("code",[e._v("CLIENT GETREDIR")]),e._v(" — returns the client ID we are redirecting our tracking notifications to")])])])])])]),e._v(" "),s("h2",{attrs:{id:"Persistence"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Persistence"}},[e._v("#")]),e._v(" Persistence")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("RDB — persistence of current snapshot in memory as a compressed binary file")]),e._v(" "),s("ul",[s("li",[e._v("expired key handling — see "),s("a",{attrs:{href:"#Server-and-Client"}},[s("code",[e._v("redisDb")])])]),e._v(" "),s("li",[e._v("automatic load — if AOF switched off, RDB files are loaded automatically at start")]),e._v(" "),s("li",[e._v("auto "),s("code",[e._v("BGSAVE")]),e._v(" — "),s("code",[e._v("save <seconds> <changes>")]),e._v(" in configurations, triggered if after "),s("code",[e._v("<seconds>")]),e._v(" since "),s("code",[e._v("redisServer.lastsave")]),e._v(" "),s("code",[e._v("redisServer.dirty")]),e._v(" is more than "),s("code",[e._v("<changes>")]),e._v(", executed by "),s("code",[e._v("serverCron")]),e._v(" function\n"),s("ul",[s("li",[s("code",[e._v("redisServer.dirty")]),e._v(" — counter for changes to keys since last "),s("code",[e._v("SAVE")]),e._v(" or "),s("code",[e._v("BGSAVE")]),e._v(", for example, the counter will +3 after "),s("code",[e._v("SADD")]),e._v(" 3 elements on a key")]),e._v(" "),s("li",[s("code",[e._v("redisServer.lastsave")]),e._v(" — timestamp of last successful "),s("code",[e._v("SAVE")]),e._v(" or "),s("code",[e._v("BGSAVE")])])])]),e._v(" "),s("li",[e._v("RDB file format — tbd")]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("SAVE")]),e._v(" — blocking")]),e._v(" "),s("li",[s("code",[e._v("BGSAVE")]),e._v(" — non-blocking in a forked process, but reject other "),s("code",[e._v("SAVE")]),e._v(", "),s("code",[e._v("BGSAVE")]),e._v(", "),s("code",[e._v("BGREWRITEAOF")]),e._v(" when executing")]),e._v(" "),s("li",[s("code",[e._v("LASTSAVE")]),e._v(" — the UNIX TIME of the last DB save executed with success")])])])])]),e._v(" "),s("li",[s("p",[e._v("AOF — append only file, text file format, recording write commands")]),e._v(" "),s("ul",[s("li",[e._v("steps\n"),s("ul",[s("li",[e._v("append — write to buffer "),s("code",[e._v("redisServer.aof_buf")]),e._v(", whose type is "),s("code",[e._v("sds")])]),e._v(" "),s("li",[e._v("write and sync — at the end of every event loop, "),s("code",[e._v("flushAppendOnlyFile")]),e._v(" executed, which writes to AOF and sync as "),s("code",[e._v("appendfsync")]),e._v(" in configurations")])])]),e._v(" "),s("li",[s("code",[e._v("appendfsync")]),e._v(" in configurations\n"),s("ul",[s("li",[s("code",[e._v("always")]),e._v(" — also depends on "),s("code",[e._v("no-appendfsync-on-rewrite")]),e._v(", which defaults to false")]),e._v(" "),s("li",[s("code",[e._v("everysec")]),e._v(", default — if over 1 sec since last sync; by a dedicated thread")]),e._v(" "),s("li",[s("code",[e._v("no")]),e._v(" — no sync, sync handled by OS")])])]),e._v(" "),s("li",[e._v("AOF loading — fake client created, from which commands in AOF executed")]),e._v(" "),s("li",[e._v("AOF rewrite — deduplicate AOF, implemented by generating commands from current database state with care for client input buffer overflow\n"),s("ul",[s("li",[e._v("non-blocking — AOF rewrite is executed in a forked process, new commands during AOF rewrite are simultaneously saved in a separate buffer besides the normal AOF buffer, which is flushed to the new AOF before the new AOF replace the previous one")])])]),e._v(" "),s("li",[e._v("expired key handling — see "),s("a",{attrs:{href:"#Server-and-Client"}},[s("code",[e._v("redisDb")])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("BGREWRITEAOF")]),e._v(" — non-blocking, but reject "),s("code",[e._v("BGSAVE")]),e._v(" and another "),s("code",[e._v("BGREWRITEAOF")]),e._v(" when executing")])])])])])]),e._v(" "),s("h2",{attrs:{id:"Clustering"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Clustering"}},[e._v("#")]),e._v(" Clustering")]),e._v(" "),s("h3",{attrs:{id:"Replication"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Replication"}},[e._v("#")]),e._v(" Replication")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("replication")]),e._v(" "),s("ul",[s("li",[e._v("tree structure — replicas can also be connected to other replicas, forming sub-replicas; all the sub-replicas will receive exactly the same replication stream from the master since 4.0")]),e._v(" "),s("li",[e._v("read write\n"),s("ul",[s("li",[e._v("readonly replica — "),s("code",[e._v("replica-read-only")]),e._v(" in configurations")]),e._v(" "),s("li",[e._v("write master only when — "),s("code",[e._v("min-replicas-to-write")]),e._v(" and "),s("code",[e._v("min-replicas-max-lag")]),e._v(" in configurations: if there are at least N replicas, with a lag less than M seconds, then the write will be accepted")])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("SLAVEOF")]),e._v(", "),s("code",[e._v("REPLICAOF")]),e._v(", "),s("code",[e._v("slaveof")]),e._v(" in configurations")]),e._v(" "),s("li",[s("code",[e._v("SYNC")]),e._v(", "),s("code",[e._v("PSYNC")]),e._v(" — internal command")]),e._v(" "),s("li",[s("code",[e._v("REPLCONF")])]),e._v(" "),s("li",[s("code",[e._v("INFO replication")])]),e._v(" "),s("li",[s("code",[e._v("WAIT")]),e._v(" — blocks the current client until all the previous write commands are successfully transferred and acknowledged by at least the specified number of replicas")]),e._v(" "),s("li",[s("code",[e._v("ROLE")])])])])])]),e._v(" "),s("li",[s("p",[e._v("synchronization — initial sync and then command propagate")]),e._v(" "),s("ul",[s("li",[e._v("initial sync\n"),s("ul",[s("li",[s("code",[e._v("SYNC")]),e._v(" — used in old version, slave send "),s("code",[e._v("SYNC")]),e._v(" to master, the master starts recording commands while "),s("code",[e._v("BGSAVE")]),e._v(" for RDB file and send it to the slave, the slave load the file, and the master send commands since "),s("code",[e._v("BGSAVE")]),e._v(" to the slave")]),e._v(" "),s("li",[s("code",[e._v("PSYNC")]),e._v(" — full resynchronization as "),s("code",[e._v("SYNC")]),e._v(" for initial replication, partial resynchronization as recovery, see below")]),e._v(" "),s("li",[e._v("diskless support — the master can send RDB file to replicas without persisting it on the disk, "),s("code",[e._v("repl-diskless-sync")]),e._v(" in configurations")])])]),e._v(" "),s("li",[e._v("command propagate — after initial sync, asynchronously propagate commands which are with side effects, use "),s("code",[e._v("WAIT")]),e._v(" for synchronous replication")]),e._v(" "),s("li",[e._v("heartbeat — update replication offset, and last heartbeat time for lag\n"),s("ul",[s("li",[e._v("heartbeat detail — slaves will ping master with "),s("code",[e._v("REPLCONF ACK replication_offset")]),e._v(" periodically, defaults to 1 Hz, "),s("code",[e._v("lag")]),e._v(" in the output of "),s("code",[e._v("INFO replication")])]),e._v(" "),s("li",[e._v("anti-entropy — reconcile if the "),s("code",[e._v("replication_offset")]),e._v(" received by master does not match its own, e.g. some command propagate message lost")])])]),e._v(" "),s("li",[e._v("data safety\n"),s("ul",[s("li",[e._v("persistence and restart — it is strongly advised to have persistence turned on in the master and in the replicas, if not possible instances should be configured to avoid restarting automatically after a reboot, to avoid replication of the initial empty state after restart")]),e._v(" "),s("li",[e._v("expire — replicas wait for "),s("code",[e._v("DEL")]),e._v(" from the master for expiration, and the replica uses its logical clock to report that a key does not exist only for read operations that don't violate the consistency of the data set")])])])])]),e._v(" "),s("li",[s("p",[e._v("partial resynchronization implementation — by replication offset in master and slave, replication backlog in master as buffer, and replication ID")]),e._v(" "),s("ul",[s("li",[e._v("replication offset — master adds n to its offset upon n bytes propagated, slave adds n to its offset upon n bytes received")]),e._v(" "),s("li",[e._v("replication backlog — fixed size FIFO queue defaults to 1 MB, saving propagated commands; if the command the replication offset in slave points to no longer in the queue, resort to full resynchronization")]),e._v(" "),s("li",[e._v("replication ID — random string, marks a given history of the data set, generated every time an instance restarts from scratch as a master, or a replica is promoted to master (but also keep one old ID for partial sync since 4.0); slave will persist the ID after handshake, send back to master upon recovering, full resynchronization if no replication ID match\n"),s("ul",[s("li",[e._v("change replication ID after promotion — in case the old master is still working as a master because of some network partition")])])])])])]),e._v(" "),s("h3",{attrs:{id:"Sentinel"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Sentinel"}},[e._v("#")]),e._v(" Sentinel")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("sentinel — monitor masters and slaves, and pick new leader")]),e._v(" "),s("ul",[s("li",[e._v("state"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("sentinelState")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n    uint64_t current_epoch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("         "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Current epoch. */")]),e._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("masters"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("      "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Dictionary of master sentinelRedisInstances.\n                           Key is the instance name, value is the\n                           sentinelRedisInstance structure pointer. */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" sentinel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("ul",[s("li",[s("code",[e._v("sentinelRedisInstance")]),e._v(" — states of master, slave or another sentinel")])])]),e._v(" "),s("li",[e._v("configurations — "),s("code",[e._v("sentinel")]),e._v(", see "),s("a",{attrs:{href:"https://redis.io/topics/sentinel#configuring-sentinel",target:"_blank",rel:"noopener noreferrer"}},[e._v("redis.io"),s("OutboundLink")],1)]),e._v(" "),s("li",[e._v("commands, see "),s("a",{attrs:{href:"https://redis.io/topics/sentinel#sentinel-commands",target:"_blank",rel:"noopener noreferrer"}},[e._v("redis.io"),s("OutboundLink")],1),e._v(" "),s("ul",[s("li",[e._v("related command\n"),s("ul",[s("li",[s("code",[e._v("SENTINEL")]),e._v(" — monitor and configuration provider")]),e._v(" "),s("li",[s("code",[e._v("ROLE")])])])]),e._v(" "),s("li",[e._v("available commands — "),s("code",[e._v("PING")]),e._v(", pub/sub etc., also see "),s("code",[e._v("sentinelcmds[]")]),e._v(" in "),s("code",[e._v("sentinel.c")])])])])])]),e._v(" "),s("li",[s("p",[e._v("links — command link and subscribe link, first established to the master and then slaves")]),e._v(" "),s("ul",[s("li",[e._v("channel — sentinels publish and subscribe via the channel "),s("code",[e._v("__sentinel__:hello")])]),e._v(" "),s("li",[e._v("inter-sentinel communication — discovery each other sentinel by pub/sub (see below), then establish command links to each other")]),e._v(" "),s("li",[e._v("sentinel as a Redis-compatible Pub/Sub server — for clients to get notified about sentinel events, see "),s("a",{attrs:{href:"https://redis.io/topics/sentinel#pubsub-messages",target:"_blank",rel:"noopener noreferrer"}},[e._v("redis.io"),s("OutboundLink")],1),e._v(" for event list and message format")])])]),e._v(" "),s("li",[s("p",[e._v("sentinel recovery, downgrade and anti-entropy")]),e._v(" "),s("ul",[s("li",[e._v("persistent state — sentinel state is persisted in the sentinel configuration file: every time a new configuration is received, or created (leader Sentinels), for a master, the configuration is persisted on disk together with the configuration epoch")]),e._v(" "),s("li",[e._v("TILT mode: time drift protection — in TILT mode the Sentinel will continue to monitor everything, but stop acting at all\n"),s("ul",[s("li",[e._v("trigger — the Sentinel timer interrupt is normally called 10 times per second, if the call time difference is negative or over 2s, TILT mode entered for 30s or prolonged if already entered")])])]),e._v(" "),s("li",[e._v("anti-entropy — periodically, see below\n"),s("ul",[s("li",[e._v("eventual consistency — as configuration propagation, every partition will converge to the higher "),s("code",[e._v("configEpoch")]),e._v(" configuration available (last-write-wins), use "),s("code",[e._v("min-replicas-to-write")]),e._v(" and "),s("code",[e._v("min-replicas-max-lag")]),e._v(" to bound the divergence\n"),s("ul",[s("li",[e._v("proxies using CRDT — "),s("a",{attrs:{href:"https://github.com/soundcloud/roshi",target:"_blank",rel:"noopener noreferrer"}},[e._v("Roshi"),s("OutboundLink")],1),e._v(", "),s("a",{attrs:{href:"https://github.com/Netflix/dynomite",target:"_blank",rel:"noopener noreferrer"}},[e._v("Dynomite"),s("OutboundLink")],1)])])])])])])]),e._v(" "),s("li",[s("p",[e._v("heartbeat")]),e._v(" "),s("ul",[s("li",[e._v("refresh "),s("code",[e._v("INFO")]),e._v(": "),s("code",[e._v("INFO")]),e._v(" master and slaves — sentinel will send "),s("code",[e._v("INFO")]),e._v(" to master in 0.1 Hz, refreshing "),s("code",[e._v("run_id")]),e._v(" and "),s("code",[e._v("slaves")]),e._v(" accordingly, for newly added slaves, sentinel will create link to them and thereafter send heartbeats in the same manner, and extract "),s("code",[e._v("run_id")]),e._v(", "),s("code",[e._v("role")]),e._v(", "),s("code",[e._v("master_link_status")]),e._v(", "),s("code",[e._v("slave_priority")]),e._v(", "),s("code",[e._v("slave_repl_offset")]),e._v(" etc. from "),s("code",[e._v("INFO")])]),e._v(" "),s("li",[e._v("reconcile and discover other sentinels: make master and slaves "),s("code",[e._v("PUBLISH")]),e._v(" and piggyback — sentinel send "),s("code",[e._v("PUBLISH")]),e._v(" to master and slave, defaults to 0.5 Hz"),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('PUBLISH __sentinel__:hello "<s_ip>,<s_port>,<s_runid>,<s_epoch>,<m_name>,<m_id>,<m_port>,<m_epoch>\n')])])]),s("ul",[s("li",[s("code",[e._v("s_")]),e._v(" for sentinel, "),s("code",[e._v("m_")]),e._v(" for master")]),e._v(" "),s("li",[e._v("loop: perception of other sentinels — sentinels can "),s("code",[e._v("PUBLISH")]),e._v(" via command link and receive via their subscription, for piggybacked message, ignore if same ID as self in the message, update states according to the message if other sentinels")]),e._v(" "),s("li",[e._v("configuration propagation — as the above "),s("code",[e._v("__sentinel__:hello")]),e._v(" loop, but only accept configurations with larger Raft epoch (see anti-entropy above)")])])]),e._v(" "),s("li",[e._v("failure detection: to master, slaves and other sentinels — sentinel "),s("code",[e._v("PING")]),e._v(" other servers in 1 Hz, with possible response "),s("code",[e._v("+PONG")]),e._v(", "),s("code",[e._v("-LOADING")]),e._v(", "),s("code",[e._v("-MASTERDOWN")]),e._v(" "),s("ul",[s("li",[e._v("subjective down — if no valid response for "),s("code",[e._v("down-after-milliseconds")]),e._v(" in sentinel configurations, "),s("code",[e._v("SRI_S_DOWN")]),e._v(" will be ORed to flags; opinions may vary among sentinels")]),e._v(" "),s("li",[e._v("objective down — after "),s("code",[e._v("SRI_S_DOWN")]),e._v(" detected, the sentinel asks other sentinels, "),s("code",[e._v("SRI_O_DOWN")]),e._v(" ORed if down for a quorum, "),s("code",[e._v("quorum")]),e._v(" set in sentinel configurations and can vary among sentinels"),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("SENTINEL is-master-down-by-addr <ip> <port> <current_epoch> <run_id_or_star>\n")])])]),e._v("response, where the last two only used for leader election"),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("1) <down_state>\n2) <leader_runid>\n3) <leader_epoch>\n")])])])])])])])]),e._v(" "),s("li",[s("p",[e._v("failover when objective down")]),e._v(" "),s("ul",[s("li",[e._v("sentinel leader election (Raft) — after master server objective down, a sentinel will "),s("code",[e._v("SENTINEL is-master-down-by-addr")]),e._v(" to other sentinels but with own "),s("code",[e._v("run_id")]),e._v(", the following runs like Raft")]),e._v(" "),s("li",[e._v("promotion — after master failure, the leader sentinel selects a slave as the new master by sending "),s("code",[e._v("SLAVEOF no one")]),e._v(", then "),s("code",[e._v("INFO")]),e._v(" in 1 Hz to see if "),s("code",[e._v("role")]),e._v(" in response becomes "),s("code",[e._v("master")]),e._v(", and the "),s("code",[e._v("SLAVEOF")]),e._v(" other slaves to set the new master, also "),s("code",[e._v("SLAVEOF")]),e._v(" the old master once it come back\n"),s("ul",[s("li",[e._v("selection for promotion — filter out down slaves, slaves with no response for "),s("code",[e._v("INFO")]),e._v(" for 5s, slaves whose link with the old master broke for "),s("code",[e._v("down-after-milliseconds * 10")]),e._v("; then sort by "),s("code",[e._v("slave_priority")]),e._v(", "),s("code",[e._v("slave_repl_offset")]),e._v(", "),s("code",[e._v("run_id")]),e._v(" and choose the best")])])]),e._v(" "),s("li",[e._v("enforce configuration — even when no failover is in progress, sentinels will always try to set the current configuration on monitored instances with a delay, helping recovered instances to catch up\n"),s("ul",[s("li",[e._v("delay — to reconfigure, the wrong configuration must be observed for some time, that is greater than the period used to broadcast new configurations")])])])])])]),e._v(" "),s("h3",{attrs:{id:"Redis-Cluster"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Redis-Cluster"}},[e._v("#")]),e._v(" Redis Cluster")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("cluster — database sharding")]),e._v(" "),s("ul",[s("li",[e._v("enable cluster — "),s("code",[e._v("cluster-enabled")]),e._v(" in configurations, other cluster configurations are similarly "),s("code",[e._v("cluster–")]),e._v(" prefixed, a node can only "),s("code",[e._v("SELECT")]),e._v(" 0, cluster bus port is always command port plus 1000")]),e._v(" "),s("li",[e._v("add node to cluster — three way handshake after "),s("code",[e._v("CLUSTER MEET")]),e._v(" from the client: "),s("code",[e._v("MEET")]),e._v(", "),s("code",[e._v("PONG")]),e._v(", "),s("code",[e._v("PING")]),e._v("; then disseminate to other nodes via Gossip (heartbeats) to let them handshake the new node\n"),s("ul",[s("li",[e._v("set slave — "),s("code",[e._v("CLUSTER REPLICATE")]),e._v(", set "),s("code",[e._v("clusterState.myself.slaveof")]),e._v(" and turn off "),s("code",[e._v("CLUSTER_NODE_MASTER")]),e._v(" and turn on "),s("code",[e._v("CLUSTER_NODE_SLAVE")]),e._v(" in "),s("code",[e._v("clusterState.myself.flags")]),e._v(", then information disseminated via heartbeats, and other nodes update information in "),s("code",[e._v("clusterNode->slaves")]),e._v(", "),s("code",[e._v("clusterNode.numslaves")])])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("MIGRATE")]),e._v(" — "),s("code",[e._v("DUMP")]),e._v(" + "),s("code",[e._v("DEL")]),e._v(" in the source, "),s("code",[e._v("RESTORE")]),e._v(" in the sink: atomically transfer a key from a source Redis instance to a destination Redis instance")]),e._v(" "),s("li",[s("code",[e._v("READONLY")]),e._v(" — enables read queries for a connection to a Redis Cluster replica node, indicate the client is fine with possible stale data and will not write")]),e._v(" "),s("li",[s("code",[e._v("READWRITE")]),e._v(" — reverse of "),s("code",[e._v("READONLY")])]),e._v(" "),s("li",[s("code",[e._v("CLUSTER")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("CLUSTER MEET")])]),e._v(" "),s("li",[s("code",[e._v("CLUSTER NODES")])]),e._v(" "),s("li",[s("code",[e._v("CLUSTER INFO")])]),e._v(" "),s("li",[s("code",[e._v("CLUSTER ADDSLOTS")]),e._v(", "),s("code",[e._v("SETSLOT")])]),e._v(" "),s("li",[s("code",[e._v("CLUSTER KEYSLOT")])]),e._v(" "),s("li",[s("code",[e._v("CLUSTER GETKEYSINSLOT")])]),e._v(" "),s("li",[s("code",[e._v("CLUSTER REPLICATE")])]),e._v(" "),s("li",[s("code",[e._v("CLUSTER FAILOVER")])])])])])])])]),e._v(" "),s("li",[s("p",[e._v("nodes")]),e._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("clusterState")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    clusterNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("myself"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* This node */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("nodes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("          "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Hash table of name -> clusterNode structures */")]),e._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("nodes_black_list"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Nodes we don't re-add for a few seconds. */")]),e._v("\n    clusterNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("migrating_slots_to"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("CLUSTER_SLOTS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    clusterNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("importing_slots_from"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("CLUSTER_SLOTS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    clusterNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("slots"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("CLUSTER_SLOTS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    uint64_t slots_keys_count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("CLUSTER_SLOTS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    rax "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("slots_to_keys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" clusterState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("clusterNode")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("unsigned")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("char")]),e._v(" slots"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("CLUSTER_SLOTS"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("8")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* slots handled by this node */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" numslots"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Number of slots handled by this node */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" clusterNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),e._v(" "),s("ul",[s("li",[e._v("node attributes ("),s("code",[e._v("clusterState")]),e._v(") — own persistent ID, and information about other nodes such as ID, epoch, slots")]),e._v(" "),s("li",[e._v("complete graph link — all the cluster nodes are connected using a TCP bus and a binary protocol, called Redis Cluster Bus; but use Gossip to avoid exchanging too many messages between nodes during normal conditions")]),e._v(" "),s("li",[e._v("slots — "),s("code",[e._v("1 << 14")]),e._v(" = 16384 slots, suggested max size of nodes is in the order of ~ 1000 nodes\n"),s("ul",[s("li",[e._v("delegate slots to a node — "),s("code",[e._v("CLUSTER ADDSLOTS")])]),e._v(" "),s("li",[e._v("broadcast "),s("code",[e._v("slots")]),e._v(" — a node will broadcast its "),s("code",[e._v("slots")]),e._v(" to other nodes, which is kept in "),s("code",[e._v("clusterState.slots")]),e._v(" and "),s("code",[e._v("clusterNode.slots")]),e._v(" in "),s("code",[e._v("clusterState->nodes")])]),e._v(" "),s("li",[e._v("hash function — "),s("code",[e._v("CRC16(key) & 0x3fff")]),e._v(", command "),s("code",[e._v("CLUSTER KEYSLOT")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("0x3fff")]),e._v(" — bitmap for a node will be of size 2 KB, which saves bandwidth compared to 65536 slots, and 16384 slots are enough for clusters under 1000 nodes")])])]),e._v(" "),s("li",[s("code",[e._v("slots_to_keys")]),e._v(" — slot to key mapping as radix trees, support for commands like "),s("code",[e._v("CLUSTER GETKEYSINSLOT")])]),e._v(" "),s("li",[e._v("multiple key operations — supported as long as all the keys involved all belong to the same hash slot, use hash tags to ensure")]),e._v(" "),s("li",[e._v("hash tags — only hash the non-empty substring between the first "),s("code",[e._v("{}")]),e._v(" in a key if possible, e.g., "),s("code",[e._v("this{foo}key")]),e._v(" and "),s("code",[e._v("another{foo}key")]),e._v(" are guaranteed to be in the same hash slot")])])])])]),e._v(" "),s("li",[s("p",[e._v("redirect and re-sharding")]),e._v(" "),s("ul",[s("li",[e._v("redirect — execute if the right slot, otherwise redirect the client to the node the slot belongs to by a "),s("code",[e._v("-MOVED")]),e._v(" error; eventually clients obtain an up-to-date representation of the cluster and directly contact the right nodes, by memorizing received "),s("code",[e._v("-MOVED")]),e._v(" or issuing "),s("code",[e._v("CLUSTER NODE")]),e._v(" or "),s("code",[e._v("CLUSTER SLOTS")]),e._v(" upon every "),s("code",[e._v("-MOVED")])]),e._v(" "),s("li",[e._v("re-sharding — adjust slot distribution and migrate slots")]),e._v(" "),s("li",[e._v("migrate slots — executed online by cluster management utility "),s("code",[e._v("redis-trib")]),e._v(", one slot by one slot\n"),s("ol",[s("li",[e._v("send "),s("code",[e._v("CLUSTER SETSLOT <slot> IMPORTING <source_id>")]),e._v(" to target node, setting its "),s("code",[e._v("clusterState.importing_slots_from[slot]")]),e._v(" to source node")]),e._v(" "),s("li",[e._v("send "),s("code",[e._v("CLUSTER SETSLOT <slot> MIGRATING <target_id>")]),e._v(" to source node, setting its "),s("code",[e._v("clusterState.migrating_slots_to[slot]")]),e._v(" to target node")]),e._v(" "),s("li",[e._v("send "),s("code",[e._v("CLUSTER GETKEYSINSLOT")]),e._v(" to source node, for keys responded, send "),s("code",[e._v("MIGRATE")]),e._v(" to source node; repeat until all keys migrated")]),e._v(" "),s("li",[e._v("send "),s("code",[e._v("CLUSTER SETSLOT <slot> NODE <target_id>")]),e._v(" to any node to disseminate the information to the cluster")])])]),e._v(" "),s("li",[e._v("command executing when migrating\n"),s("ul",[s("li",[s("code",[e._v("-ASK")]),e._v(" error — if the key does not exist on the source node, send "),s("code",[e._v("-ASK")]),e._v(" error to redirect the client to the target node, and client send "),s("code",[e._v("ASKING")]),e._v(" to the redirected node before resending command")]),e._v(" "),s("li",[s("code",[e._v("ASKING")]),e._v(" — turn on "),s("code",[e._v("REDIS_ASKING")]),e._v(" in "),s("code",[e._v("client.flags")]),e._v(" for next command; a node will refrain from send "),s("code",[e._v("-MOVED")]),e._v(" error and try to execute the command even if the slot is not delegated to the node if "),s("code",[e._v("REDIS_ASKING")]),e._v(" on the client and "),s("code",[e._v("clusterState.importing_slots_from[slot]")]),e._v(" is not "),s("code",[e._v("NULL")])]),e._v(" "),s("li",[s("code",[e._v("-TRYAGAIN")]),e._v(" error — if keys split between the source and destination nodes for multiple key operations, clients can try again later or report the error")])])])])]),e._v(" "),s("li",[s("p",[e._v("messages")]),e._v(" "),s("ul",[s("li",[e._v("message types\n"),s("ul",[s("li",[s("code",[e._v("MEET")])]),e._v(" "),s("li",[s("code",[e._v("PING")]),e._v(" — in 1 Hz, every node selects 5 other random nodes to "),s("code",[e._v("PING")]),e._v("; besides, every node "),s("code",[e._v("PING")]),e._v(" nodes whose last "),s("code",[e._v("PONG")]),e._v(" till now is over half of "),s("code",[e._v("cluster-node-timeout")])]),e._v(" "),s("li",[s("code",[e._v("PONG")]),e._v(" — response to "),s("code",[e._v("MEET")]),e._v(" and "),s("code",[e._v("PING")]),e._v(", or voluntary broadcast")]),e._v(" "),s("li",[s("code",[e._v("FAIL")]),e._v(" — broadcasted ASAP")]),e._v(" "),s("li",[s("code",[e._v("UPDATE")]),e._v(" — if a receiver of a heartbeat packet finds the sender information is stale, it will "),s("code",[e._v("UPDATE")]),e._v(" the stale node")]),e._v(" "),s("li",[s("code",[e._v("PUBLISH")]),e._v(" — clients can subscribe to every node, and can also publish to every other node; the current implementation will simply broadcast each published message to all other nodes, but at some point this will be optimized either using Bloom filters or other algorithms")])])]),e._v(" "),s("li",[e._v("message header common to all messages — "),s("code",[e._v("clusterMsg")]),e._v(" in "),s("code",[e._v("cluster.h")]),e._v(", includes the sender's ID, "),s("code",[e._v("currentEpoch")]),e._v(", "),s("code",[e._v("configEpoch")]),e._v(", flags, slot bitmap, port, master ID, cluster state POV ("),s("code",[e._v("CLUSTER_OK")]),e._v(" or "),s("code",[e._v("CLUSTER_FAIL")]),e._v(")")]),e._v(" "),s("li",[e._v("heartbeat — "),s("code",[e._v("PING")]),e._v(", "),s("code",[e._v("PONG")]),e._v(", also contain a Gossip section")]),e._v(" "),s("li",[e._v("Gossip section — for "),s("code",[e._v("MEET")]),e._v(", "),s("code",[e._v("PING")]),e._v(" and "),s("code",[e._v("PONG")]),e._v(" messages, offering a view of some random nodes from the cluster, including ID,"),e._v(" address and flags, where the number of random nodes is proportional to the cluster size"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* PING, MEET and PONG */")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Array of N clusterMsgDataGossip structures */")]),e._v("\n    clusterMsgDataGossip gossip"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" ping"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])])])])]),e._v(" "),s("li",[s("p",[e._v("failover — use replication for each node and select a slave as the new master if the original master is down")]),e._v(" "),s("ul",[s("li",[e._v("eventual consistency — due to asynchronous replication and partition like the one documented in sentinel above")]),e._v(" "),s("li",[e._v("failure states\n"),s("ul",[s("li",[e._v("cluster fail — "),s("code",[e._v("CLUSTER_FAIL")]),e._v(" even if only one slot not handled")]),e._v(" "),s("li",[e._v("heartbeat and "),s("code",[e._v("CLUSTER_NODE_PFAIL")]),e._v(" (probable fail) — nodes (masters and slaves) in cluster will periodically "),s("code",[e._v("PING")]),e._v(" each other, if no "),s("code",[e._v("PONG")]),e._v(" for more than "),s("code",[e._v("cluster-node-timeout")]),e._v(", mark "),s("code",[e._v("CLUSTER_NODE_PFAIL")]),e._v(" for target node in "),s("code",[e._v("clusterState.nodes")]),e._v(" and disseminate via heartbeat message; upon receiving such message, a node will append it to "),s("code",[e._v("clusterNode->fail_reports")]),e._v(" in "),s("code",[e._v("clusterState.nodes")]),e._v(" "),s("ul",[s("li",[e._v("reconnect — nodes also try to reconnect the TCP link to avoid marking "),s("code",[e._v("CLUSTER_NODE_PFAIL")]),e._v(" only because a TCP link problem")]),e._v(" "),s("li",[e._v("self protection — nodes refuse writes if cannot reach the majority for more than "),s("code",[e._v("cluster-node-timeout")])])])]),e._v(" "),s("li",[s("code",[e._v("CLUSTER_NODE_FAIL")]),e._v(" — if a majority of master nodes mark one master node "),s("code",[e._v("CLUSTER_NODE_PFAIL")]),e._v(" or "),s("code",[e._v("CLUSTER_NODE_FAIL")]),e._v(" within "),s("code",[e._v("cluster-node-timeout")]),e._v(" multiplied by a factor (2 currently), then that node will be marked "),s("code",[e._v("CLUSTER_NODE_FAIL")]),e._v(", and a "),s("code",[e._v("FAIL")]),e._v(" message will be broadcasted")])])]),e._v(" "),s("li",[e._v("failover — when the master fails, slaves can start elections and if a slave is elected, it is elected to "),s("code",[e._v("SLAVEOF no one")]),e._v(", cancel slots in the original master and add those slots for itself, then broadcast a "),s("code",[e._v("PONG")]),e._v(" to inform the cluster\n"),s("ul",[s("li",[e._v("prerequisites for a slave to start an election — when the master with positive "),s("code",[e._v("numslots")]),e._v(" failed from the POV of the slave, and the time since slave's last interaction with the master is less than an amount configurable by "),s("code",[e._v("cluster-replica-validity-factor")]),e._v(", a slave node can start election after a jittered delay computed with slave rank")]),e._v(" "),s("li",[e._v("slave rank — slaves exchange messages when the master is failing in order to establish a (best effort) rank, ranked by how updated the replication offset is. In this way the most updated slaves try to get elected before others.")]),e._v(" "),s("li",[e._v("new master election — Raft like, other master nodes can vote but behave "),s("a",{attrs:{href:"https://redis.io/topics/cluster-spec#masters-reply-to-slave-vote-request",target:"_blank",rel:"noopener noreferrer"}},[e._v("a little differently"),s("OutboundLink")],1),e._v(" compared to Raft, "),s("code",[e._v("currentEpoch")]),e._v(" as term, upon winning a new unique and incremental "),s("code",[e._v("configEpoch")]),e._v(" higher than any other master is created and new configuration is broadcasted to overwrite configurations with old ones")])])]),e._v(" "),s("li",[e._v("replica migration — guarantees that eventually every master will be backed by at least one slave\n"),s("ul",[s("li",[e._v("process — if singled master detected, the slave among the masters with the maximum number of attached slaves, that is not in FAIL state and has the smallest node ID, will migrate to the singled master")]),e._v(" "),s("li",[e._v("can try to migrate only when enough slaves left — "),s("code",[e._v("cluster-migration-barrier")]),e._v(" in configurations")])])]),e._v(" "),s("li",[e._v("recover and clear "),s("code",[e._v("CLUSTER_NODE_FAIL")]),e._v(" — if failed nodes reachable again for some time, clear directly if slave or no slot, otherwise rejoin the cluster\n"),s("ul",[s("li",[e._v("rejoin — rejoining master nodes will be slave of the node that stole its last hash slot, rejoining slave nodes will be slave of the node that stole the last hash slot of its former master")])])])])]),e._v(" "),s("li",[s("p",[e._v("proxy based")]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://github.com/twitter/twemproxy",target:"_blank",rel:"noopener noreferrer"}},[e._v("twitter/twemproxy: A fast, light-weight proxy for memcached and redis"),s("OutboundLink")],1)])])])]),e._v(" "),s("h2",{attrs:{id:"Transaction"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Transaction"}},[e._v("#")]),e._v(" Transaction")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("transaction — queue commands and execute them atomically, no rollback")]),e._v(" "),s("ul",[s("li",[e._v("command queue — all commands except transaction related commands will be validated and queued, all the other commands will be executed even if some command fails during the transaction"),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("multiState")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    multiCmd "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("commands"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("     "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Array of MULTI commands */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("              "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Total number of MULTI commands */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" cmd_flags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("          "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* The accumulated command flags OR-ed together.\n                               So if at least a command has a given flag, it\n                               will be set in this field. */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" cmd_inv_flags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("      "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* Same as cmd_flags, OR-ing the ~flags. so that it\n                               is possible to know if all the commands have a\n                               certain flag. */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" minreplicas"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("        "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* MINREPLICAS for synchronous replication */")]),e._v("\n    time_t minreplicas_timeout"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* MINREPLICAS timeout as unixtime. */")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" multiState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("typedef")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("struct")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("client")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n    multiState mstate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("      "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* MULTI/EXEC state */")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])])]),e._v(" "),s("li",[e._v("optimistic lock — "),s("code",[e._v("WATCH")]),e._v(", transaction aborted if any "),s("code",[e._v("WATCH")]),e._v("ed key is modified before "),s("code",[e._v("EXEC")]),e._v(" "),s("ul",[s("li",[e._v("implementation — "),s("code",[e._v("redisDb->watched_keys")]),e._v(", "),s("code",[e._v("dict")]),e._v(" of key to client linked list; add "),s("code",[e._v("CLIENT_DIRTY_CAS")]),e._v(" in "),s("code",[e._v("client.flags")]),e._v(" if a command with "),s("code",[e._v("w")]),e._v(" in "),s("code",[e._v("redisCommand.sflags")]),e._v(" modified watched keys")])])]),e._v(" "),s("li",[e._v("ACID — guaranteed by single thread, except durability\n"),s("ul",[s("li",[e._v("force durability — "),s("code",[e._v("SAVE")]),e._v(" before "),s("code",[e._v("EXEC")]),e._v(", but low performance")])])])])]),e._v(" "),s("li",[s("p",[e._v("related commands")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("MULTI")]),e._v(" — start transaction, "),s("code",[e._v("CLIENT_MULTI")]),e._v(" in "),s("code",[e._v("client.flags")])]),e._v(" "),s("li",[s("code",[e._v("EXEC")]),e._v(" — executes all previously queued commands")]),e._v(" "),s("li",[s("code",[e._v("WATCH")]),e._v(", "),s("code",[e._v("UNWATCH")])]),e._v(" "),s("li",[s("code",[e._v("DISCARD")]),e._v(" — also "),s("code",[e._v("UNWATCH")]),e._v(" all keys")])])]),e._v(" "),s("li",[s("p",[e._v("Lua scripts — Lua 5.1, transactional by definition")]),e._v(" "),s("ul",[s("li",[e._v("create Lua environment\n"),s("ol",[s("li",[e._v("创建一个基础的 Lua 环境 by "),s("code",[e._v("lua_open")]),e._v("， 之后的所有修改都是针对这个环境进行的。")]),e._v(" "),s("li",[e._v("载入多个函数库到 Lua 环境里面， 让 Lua 脚本可以使用这些函数库来进行数据操作。 — tbd")]),e._v(" "),s("li",[e._v("创建全局表格 "),s("code",[e._v("redis")]),e._v(" ， 这个表格包含了对 Redis 进行操作的函数， 比如用于在 Lua 脚本中执行 Redis 命令的 "),s("code",[e._v("redis.call")]),e._v(" 函数。")]),e._v(" "),s("li",[e._v("使用 Redis 自制的随机函数来替换 Lua 原有的带有副作用的随机函数， 从而避免在脚本中引入副作用。")]),e._v(" "),s("li",[e._v("创建排序辅助函数， Lua 环境使用这个辅佐函数来对一部分 Redis 命令的结果进行排序， 从而消除这些命令的不确定性。")]),e._v(" "),s("li",[e._v("创建 "),s("code",[e._v("redis.pcall")]),e._v(" 函数的错误报告辅助函数， 这个函数可以提供更详细的出错信息。")]),e._v(" "),s("li",[e._v("对 Lua 环境里面的全局环境进行保护， 防止用户在执行 Lua 脚本的过程中， 将额外的全局变量添加到了 Lua 环境里面。")]),e._v(" "),s("li",[e._v("将完成修改的 Lua 环境保存到服务器状态的 "),s("code",[e._v("lua")]),e._v(" 属性里面， 等待执行服务器传来的 Lua 脚本。")])])]),e._v(" "),s("li",[s("code",[e._v("redis.call")]),e._v(" and "),s("code",[e._v("redis.pcall")]),e._v(" — executed by "),s("code",[e._v("redisServer.lua_client")]),e._v(", arguments are arguments of Redis commands"),s("div",{staticClass:"language-lua extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lua"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'set'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'bar'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])])]),s("ul",[s("li",[e._v("error handling — if a Redis command call will result in an error, "),s("code",[e._v("redis.call()")]),e._v(" will raise a Lua error that in turn will force "),s("code",[e._v("EVAL")]),e._v(" to return an error to the command caller, while "),s("code",[e._v("redis.pcall()")]),e._v(" will trap the error and return a Lua table representing the error")]),e._v(" "),s("li",[e._v("keys must be passed explicitly — in order to be compatible with cluster")])])]),e._v(" "),s("li",[e._v("SHA1\n"),s("ul",[s("li",[e._v("as key — "),s("code",[e._v("redisServer->lua_scripts")]),e._v(", which is "),s("code",[e._v("dict")]),e._v(" with SHA1 as key, function body as value")]),e._v(" "),s("li",[e._v("as Lua function name — function "),s("code",[e._v("f_<SHA1>()")]),e._v(" is defined with the arguments of "),s("code",[e._v("EVAL")])])])]),e._v(" "),s("li",[s("a",{attrs:{href:"https://redis.io/commands/eval#conversion-between-lua-and-redis-data-types",target:"_blank",rel:"noopener noreferrer"}},[e._v("tbd from type conversion"),s("OutboundLink")],1)]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("EVAL script numkeys key [key ...] arg [arg ...]")])]),e._v(" "),s("li",[s("code",[e._v("EVALSHA")]),e._v(" — arguments as "),s("code",[e._v("EVAL")]),e._v(", scripts cached using "),s("code",[e._v("SCRIPT LOAD")])]),e._v(" "),s("li",[s("code",[e._v("SCRIPT")]),e._v(" — tbd\n"),s("ul",[s("li",[s("code",[e._v("SCRIPT DEBUG")])]),e._v(" "),s("li",[s("code",[e._v("SCRIPT EXISTS")])]),e._v(" "),s("li",[s("code",[e._v("SCRIPT FLUSH")])]),e._v(" "),s("li",[s("code",[e._v("SCRIPT KILL")])]),e._v(" "),s("li",[s("code",[e._v("SCRIPT LOAD")])])])])])])])]),e._v(" "),s("li",[s("p",[e._v("other non-transactional batch")]),e._v(" "),s("ul",[s("li",[e._v("pipeline — batch commands but not in a transaction")]),e._v(" "),s("li",[e._v("mass insertion — "),s("code",[e._v("redis-cli --pipe")]),e._v(" pipe mode"),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("cat")]),e._v(" data.txt "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" redis-cli --pipe\n")])])]),s("ul",[s("li",[s("code",[e._v("data.txt")]),e._v(" — sequence of commands in the Redis protocol format, see "),s("a",{attrs:{href:"https://redis.io/topics/mass-insert",target:"_blank",rel:"noopener noreferrer"}},[e._v("Redis Mass Insertion"),s("OutboundLink")],1),e._v(" for scripts for generating")])])])])])]),e._v(" "),s("h2",{attrs:{id:"Other"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#Other"}},[e._v("#")]),e._v(" Other")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("config")]),e._v(" "),s("ul",[s("li",[e._v("config file — "),s("code",[e._v("/etc/redis/redis.conf")]),e._v(" or as CLI options prefixed with "),s("code",[e._v("--")])]),e._v(" "),s("li",[e._v("related command — "),s("code",[e._v("CONFIG")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("CONFIG GET")]),e._v(" — support "),s("code",[e._v("*")]),e._v(" glob pattern")]),e._v(" "),s("li",[s("code",[e._v("CONFIG SET")])]),e._v(" "),s("li",[s("code",[e._v("CONFIG REWRITE")]),e._v(" — rewrites the "),s("code",[e._v("redis.conf")]),e._v(" to current configurations")])])])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("maxmemory-policy")]),e._v(" in configurations — eviction policy when "),s("code",[e._v("maxmemory")]),e._v(" reached, which defaults to 0 which means no limit for 64 bit systems")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("noeviction")]),e._v(" — no eviction, return errors instead")]),e._v(" "),s("li",[e._v("LRU — approximated of LRU, by sampling "),s("code",[e._v("maxmemory-samples")]),e._v(" of keys, and evicting the one least recently used; pooling since 3.0, when the N keys sampling was performed, keys are used to populate a larger pool of keys (just 16 keys by default) sorted by idle time, if the keys are less recently used\n"),s("ul",[s("li",[s("code",[e._v("allkeys-lru")]),e._v(" — all keys")]),e._v(" "),s("li",[s("code",[e._v("volatile-lru")]),e._v(" — only among keys that have an expire set, return errors instead if no eviction")])])]),e._v(" "),s("li",[e._v("random\n"),s("ul",[s("li",[s("code",[e._v("allkeys-random")])]),e._v(" "),s("li",[s("code",[e._v("volatile-random")])])])]),e._v(" "),s("li",[s("code",[e._v("volatile-ttl")]),e._v(" — evict keys with an expire set, and try to evict keys with a shorter TTL first, return errors instead if no eviction")]),e._v(" "),s("li",[e._v("LFU — since 4.0, reuse "),s("code",[e._v("redisObject.lru")]),e._v(", uses Morris counter (the greater the counter, the less likely to be incremented) to estimate access frequency, combined with a decay period so that the counter is reduced over time; sampled similarly to LRU\n"),s("ul",[s("li",[s("a",{attrs:{href:"https://github.com/redis/redis/blob/204a14b8cffba6a23e4e313e248bed7ef5cd8260/src/evict.c#L242-L277",target:"_blank",rel:"noopener noreferrer"}},[e._v("src"),s("OutboundLink")],1)]),e._v(" "),s("li",[e._v("tune\n"),s("ul",[s("li",[s("code",[e._v("lfu-log-factor 10")]),e._v(" – defaults to saturate (255) at around 1M hits")]),e._v(" "),s("li",[s("code",[e._v("lfu-decay-time 1")])])])]),e._v(" "),s("li",[s("code",[e._v("allkeys-lfu")])]),e._v(" "),s("li",[s("code",[e._v("volatile-lfu")])])])]),e._v(" "),s("li",[e._v("related commands — "),s("code",[e._v("MEMORY")]),e._v(", see "),s("code",[e._v("MEMORY HELP")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("MEMORY DOCTOR")])]),e._v(" "),s("li",[s("code",[e._v("MEMORY MALLOC-STATS")])]),e._v(" "),s("li",[s("code",[e._v("MEMORY PURGE")])]),e._v(" "),s("li",[s("code",[e._v("MEMORY STATS")]),e._v(" — some overlap with "),s("code",[e._v("INFO")])]),e._v(" "),s("li",[s("code",[e._v("MEMORY USAGE")]),e._v(" — the number of bytes that a key and its value require to be stored in RAM")]),e._v(" "),s("li",[s("code",[e._v("OBJECT FREQ")]),e._v(" — available when "),s("code",[e._v("maxmemory-policy")]),e._v(" is set to an LFU policy")]),e._v(" "),s("li",[s("code",[e._v("TOUCH key [key ...]")]),e._v(" — alters the last access time of keys")])])])])]),e._v(" "),s("li",[s("p",[e._v("slow log")]),e._v(" "),s("ul",[s("li",[e._v("configurations — "),s("code",[e._v("slowlog-log-slower-than")]),e._v(", "),s("code",[e._v("slowlog-max-len")])]),e._v(" "),s("li",[e._v("log entry id — "),s("code",[e._v("long long")]),e._v(" "),s("code",[e._v("redisServer.slowlog_entry_id")]),e._v(", +1 every time")]),e._v(" "),s("li",[e._v("latency\n"),s("ul",[s("li",[e._v("enable latency monitor — "),s("code",[e._v("LATENCY")]),e._v(", "),s("code",[e._v("latency-monitor-threshold")]),e._v(" in configurations")]),e._v(" "),s("li",[s("a",{attrs:{href:"https://redis.io/topics/latency",target:"_blank",rel:"noopener noreferrer"}},[e._v("Redis latency problems troubleshooting – Redis.io"),s("OutboundLink")],1)])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("SLOWLOG")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("SLOWLOG GET")])]),e._v(" "),s("li",[s("code",[e._v("SLOWLOG LEN")])]),e._v(" "),s("li",[s("code",[e._v("SLOWLOG RESET")])])])]),e._v(" "),s("li",[s("code",[e._v("LATENCY")]),e._v(" — see "),s("code",[e._v("LATENCY HELP")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("LATENCY LATEST")]),e._v(" — returns the latest latency samples for all events")]),e._v(" "),s("li",[s("code",[e._v("LATENCY HISTORY")]),e._v(" — returns latency time series for a given event")]),e._v(" "),s("li",[s("code",[e._v("LATENCY RESET")]),e._v(" — resets latency time series data for one or more events")]),e._v(" "),s("li",[s("code",[e._v("LATENCY GRAPH")]),e._v(" — renders an ASCII-art graph of an event's latency samples")]),e._v(" "),s("li",[s("code",[e._v("LATENCY DOCTOR")]),e._v(" — replies with a human-readable latency analysis report")])])])])])])]),e._v(" "),s("li",[s("p",[e._v("distributed locks — see "),s("RouterLink",{attrs:{to:"/backend/distributed.html#Distributed-Locks"}},[e._v("distributed")])],1)]),e._v(" "),s("li",[s("p",[e._v("big keys")]),e._v(" "),s("ul",[s("li",[e._v("find big keys — "),s("code",[e._v("redis-cli --bigkeys")]),e._v(", "),s("code",[e._v("SCAN")])]),e._v(" "),s("li",[e._v("check whether big key — "),s("code",[e._v("DEBUG OBJECT")]),e._v(", "),s("code",[e._v("STRLEN")]),e._v(", etc.")]),e._v(" "),s("li",[e._v("delete bigkeys — "),s("code",[e._v("UNLINK")])])])]),e._v(" "),s("li",[s("p",[e._v("Redis modules — since 4.0, dynamic libraries, "),s("code",[e._v("loadmodule")]),e._v(" in configurations or use "),s("code",[e._v("MODULE LOAD")])]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://redis.io/topics/modules-intro",target:"_blank",rel:"noopener noreferrer"}},[e._v("tbd"),s("OutboundLink")],1)]),e._v(" "),s("li",[e._v("related commands "),s("code",[e._v("MODULE")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("MODULE LIST")])]),e._v(" "),s("li",[s("code",[e._v("MODULE LOAD")])]),e._v(" "),s("li",[s("code",[e._v("MODULE UNLOAD")])])])])])]),e._v(" "),s("li",[s("p",[e._v("security")]),e._v(" "),s("ul",[s("li",[e._v("command disabling — "),s("code",[e._v("rename-config")]),e._v(" in configurations")]),e._v(" "),s("li",[e._v("hash flooding protect — Redis uses a per-execution pseudo-random seed to the hash function")]),e._v(" "),s("li",[e._v('ACL — allows certain connections to be limited in terms of the commands that can be executed and the keys that can be accessed, new connections are already authenticated with a "default" user')]),e._v(" "),s("li",[e._v("TLS — see "),s("a",{attrs:{href:"https://redis.io/topics/encryption",target:"_blank",rel:"noopener noreferrer"}},[e._v("TLS Support – Redis.io"),s("OutboundLink")],1)]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("AUTH")])]),e._v(" "),s("li",[s("code",[e._v("ACL")])])])])])]),e._v(" "),s("li",[s("p",[e._v("RESP — Redis clients communicate with the Redis server using a protocol called REdis Serialization Protocol")]),e._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" -e "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'*1"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\r"}},[e._v("\\r")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[e._v("\\n")]),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$4")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\r"}},[e._v("\\r")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[e._v("\\n")]),e._v("PING"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\r"}},[e._v("\\r")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[e._v("\\n")]),e._v("'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sleep")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" netcat redis.host.com "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("6379")]),e._v("\n")])])]),s("ul",[s("li",[e._v("delimiter and section terminator — "),s("code",[e._v("\\r\\n")])]),e._v(" "),s("li",[e._v("data type — depends on the first byte, bulk strings and arrays are followed by byte count and "),s("code",[e._v("\\r\\n")]),e._v(" if not "),s("code",[e._v("NULL")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("+")]),e._v(" — simple strings")]),e._v(" "),s("li",[s("code",[e._v("-")]),e._v(" — errors")]),e._v(" "),s("li",[s("code",[e._v(":")]),e._v(" — integers")]),e._v(" "),s("li",[s("code",[e._v("$")]),e._v(" — bulk strings")]),e._v(" "),s("li",[s("code",[e._v("*")]),e._v(" — arrays")]),e._v(" "),s("li",[s("code",[e._v("NULL")]),e._v(" — "),s("code",[e._v('"$-1\\r\\n"')]),e._v(", "),s("code",[e._v('"*-1\\r\\n"')])])])]),e._v(" "),s("li",[e._v("client request and server reply — a client sends the Redis server a RESP Array consisting of just Bulk Strings; a Redis server replies to clients sending any valid RESP data type as reply")]),e._v(" "),s("li",[e._v("inline mode — designed for utilities like "),s("code",[e._v("telnet")]),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" PING "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("nc")]),e._v(" localhost "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("6379")]),e._v("\n")])])])]),e._v(" "),s("li",[e._v("RESP3 — since 6.0, "),s("a",{attrs:{href:"https://github.com/antirez/RESP3/blob/master/spec.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("specification"),s("OutboundLink")],1),e._v(" "),s("ul",[s("li",[e._v("map data type")]),e._v(" "),s("li",[e._v("multiplexing — possible to run the data queries and receive the invalidation messages in the same connection")])])]),e._v(" "),s("li",[e._v("related commands\n"),s("ul",[s("li",[s("code",[e._v("HELLO")]),e._v(" — since 6.0, switch protocol")])])])])]),e._v(" "),s("li",[s("p",[e._v("meme")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("LOLWUT")])])])])])])}),[],!1,null,null,null);t.default=n.exports}}]);